<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumber Tycoon | STADIASTUDIOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="assets/appicon.png">

    <!-- PWA Meta Tags for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lumber Tycoon | STADIASTUDIOS">
    <link rel="manifest" href="manifest.json">
    <!-- Theme color set to a darker shade -->
    <meta name="theme-color" id="themeMetaColor" content="#0a0a0a"/>

    <style>
        /* Base styles for the new darker gradient theme */
        body {
          font-family: 'Inter', sans-serif;
          margin: 0;
          padding: 0;
          display: flex;
          justify-content: center;
          align-items: flex-start; /* Align to top for better content flow */
          min-height: 100vh;
          /* Darker gradient background */
          background: linear-gradient(to bottom right, #1a1a1a, #0d0d0d, #000000); /* Very dark grays/blacks */
          color: #e2e8f0; /* Tailwind slate-200 for text */
          /* Hide scrollbar for various browsers */
          -ms-overflow-style: none;  /* IE and Edge */
          scrollbar-width: none;  /* Firefox */
          /* Prevent double-tap zoom on mobile */
          touch-action: manipulation;
        }
        html, body {
            cursor: url("cursor.ico"), default;
            /* just change the cursor.ico path to your location */
        }
        /* Hide scrollbar for Webkit browsers (Chrome, Safari) */
        body::-webkit-scrollbar {
            display: none;
        }

        /* Custom Scrollbar Styles for Darker Theme */
        ::-webkit-scrollbar {
            width: 12px; /* Width of the scrollbar */
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a; /* Darker background */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #333333; /* Dark gray thumb */
            border-radius: 10px;
            border: 3px solid #1a1a1a; /* Padding around the thumb */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555555; /* Lighter gray on hover */
        }

        /* New: Custom cursor for buttons on hover */
        button:hover {
            cursor: url("cursor-hover.ico"), pointer;
        }

        .app-container {
            width: 100%;
            max-width: 4xl; /* Equivalent to max-w-4xl */
            background-color: #0a0a0a; /* Even darker background for container */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.25); /* Stronger, darker shadow */
            padding: 1.5rem; /* p-6 */
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 1rem; /* Add some top margin */
            margin-bottom: 1rem; /* Add some bottom margin */
        }
        /* Existing custom CSS for game elements, adapted for darker theme */
        .tree-image {
          width: 100%; /* Fill parent wrapper */
          height: 100%; /* Fill parent wrapper */
          object-fit: contain;
          cursor: pointer;
          transition: transform 0.1s ease-out;
          box-shadow: none; /* Removed box-shadow to remove the "border" effect */
          border: none; /* Explicitly remove any border */
          z-index: 1; /* Ensure it's below the progress bar */
          
        }
        .tree-image:hover {
          transform: scale(1.05);
          cursor: url("cursor-hover.ico"), default;
        }
        .animate-shake {
          animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
          transform: translate3d(0, 0, 0);
          backface-visibility: hidden;
          perspective: 1000px;
        }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .furniture-item {
          position: absolute;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.5); /* Darker shadow */
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.75rem;
          color: #e2e8f0; /* Lighter text for items (slate-200) */
          overflow: hidden;
          transition: transform 0.2s ease-in-out;
          cursor: pointer; /* Changed to pointer for rotation/selection */
        }
        .furniture-item.moving-selected {
            border: 3px solid #6366f1; /* Indigo-500 - kept for selection highlight */
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.5); /* Darker glow for selection */
        }
        .furniture-item.deleting-active {
            border: 3px solid #ef4444; /* Red-500 - kept for deletion highlight */
            box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.5); /* Darker glow for deletion */
        }
        .furniture-item img {
          width: 100%;
          height: 100%;
          object-fit: contain;
        }
        .home-grid {
          background-color: #1a1a1a; /* Darker background for home grid */
          border: 2px dashed #333333; /* Darker dashed border */
          position: relative;
          overflow: hidden;
          background-size: contain; /* Reverted to 'contain' to prevent stretching and ensure full visibility */
          background-repeat: no-repeat; /* Prevents tiling */
          background-position: center; /* Centers the image */
        }
        .home-grid.rearranging-mode {
            cursor: cell; /* Indicates placement mode */
        }
        .shop-item {
          cursor: pointer;
          transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
        }
        .shop-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 10px rgba(0,0,0,0.4); /* Darker hover shadow */
          cursor: url("cursor-hover.ico"), default;
        }
        .shop-item.selected {
          border: 3px solid #6366f1; /* Indigo-500 - kept for selection */
          box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.5); /* Darker glow for selection */
          cursor: url("cursor-hover.ico"), default;
        }

        .progress-bar-container {
          position: absolute;
          bottom: 10px;
          left: 50%;
          transform: translateX(-50%);
          width: 80%;
          height: 10px;
          background-color: rgba(0,0,0,0.8); /* Even darker for better visibility */
          border-radius: 5px;
          overflow: hidden;
          z-index: 20; /* Ensure it's on top of the tree image */
        }

        .progress-bar {
          height: 100%;
          background-color: #22c55e; /* Bright green for clear progress (green-500) */
          width: 0%;
          border-radius: 55px;
          transition: width 0.05s linear; /* Smooth progress animation */
        }
        /* Custom styles for the icons */
        .currency-icon, .nav-icon {
            width: 24px; /* w-6 */
            height: 24px; /* h-6 */
            display: inline-block;
            margin-right: 8px; /* mr-2 */
            vertical-align: middle; /* Align with text */
        }
        /* New style for purple progress bar */
        .progress-bar-purple {
            background-color: #a855f7; /* A shade of purple (purple-500) */
        }
        /* New style for red progress bar (Vampire Forest) */
        .progress-bar-red {
            background-color: #ef4444; /* A shade of red (red-500) */
        }
        /* New style for quest progress bar (orange) */
        .progress-bar-orange {
            background-color: #f97316; /* Tailwind orange-500 */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #1a1a1a; /* Darker background for modal */
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); /* Darker shadow */
            width: 90%;
            max-width: 500px;
            color: #e2e8f0; /* slate-200 */
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #e2e8f0; /* slate-200 */
            cursor: pointer;
        }

        /* Loading Screen Styles */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom right, #1a1a1a, #0d0d0d, #000000); /* Match body background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Allow clicks through once hidden */
        }

        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.2); /* Lighter border for spinner */
            border-top: 8px solid #30ff75; /* Purple spinner - kept original for contrast */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-app-icon {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
        }

        #welcome-message {
            font-size: 2.5rem;
            font-weight: bold;
            color: #e2e8f0; /* slate-200 */
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        #welcome-message.show {
            opacity: 1;
        }

        /* New: Click to Start Overlay Styles */
        #click-to-start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Even darker overlay */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998; /* Below loading screen, above game content */
            transition: opacity 0.5s ease-out;
        }

        #click-to-start-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Common styles for nav buttons (colors are set dynamically) */
        .nav-button-base {
            padding: 0.75rem 1rem; /* px-4 py-3 */
            border-radius: 9999px; /* rounded-full */
            font-weight: 600; /* font-semibold */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1); /* Darker shadow */
            transition: all 0.2s ease-in-out;
        }
        .nav-button-active {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2); /* Deeper, darker shadow */
            transform: translateY(-2px); /* Slight lift */
        }
        .nav-button-inactive:hover {
            box-shadow: 0 6px 10px rgba(0,0,0,0.35); /* Darker hover shadow */
            transform: translateY(-1px);
        }

        /* General element background and text color adjustments for the darker theme */
        /* Adjusted these to be darker, more muted tones */
        .bg-stone-800 { background-color: #1c1c1c; } /* Darker gray */
        .bg-stone-900 { background-color: #121212; } /* Even darker gray */
        .bg-stone-700 { background-color: #2a2a2a; } /* Medium dark gray */
        .text-stone-100 { color: #f8fafc; } /* Slate-50 */
        .text-stone-300 { color: #cbd5e1; } /* Slate-300 */
        .text-stone-400 { color: #94a3b8; } /* Slate-400 */
        .text-stone-600 { color: #64748b; } /* Slate-600 */
        .border-stone-600 { border-color: #3a3a3a; } /* Darker border */
        .bg-yellow-950 { background-color: #2c1c00; } /* Darker yellow for wood display */
        .bg-emerald-950 { background-color: #033a2e; } /* Darker emerald for money display */
        .bg-purple-950 { background-color: #2a004a; } /* Darker purple for grape lumber */
        .bg-red-950 { background-color: #3a0000; } /* Darker red for soul lumber */
        .bg-gray-950 { background-color: #1a1a1a; } /* Darker gray for junk items */

        /* Adjusted biome specific colors for darker theme */
        .bg-emerald-900\/50 { background-color: rgba(2, 44, 34, 0.5); } /* Darker green for forest */
        .bg-emerald-800 { background-color: #065f46; } /* Darker green for forest ground */
        .bg-purple-900\/50 { background-color: rgba(49, 0, 68, 0.5); } /* Darker purple for purple forest */
        .bg-purple-800 { background-color: #581c87; } /* Darker purple for purple forest ground */
        .bg-red-900\/50 { background-color: rgba(68, 0, 0, 0.5); } /* Darker red for vampire forest */
        .bg-red-800 { background-color: #991b1b; } /* Darker red for vampire forest ground */

        /* Adjusted button colors for darker theme */
        .bg-emerald-700 { background-color: #047857; }
        .hover\:bg-emerald-600:hover { background-color: #059669; }
        .bg-amber-700 { background-color: #b45309; }
        .hover\:bg-amber-600:hover { background-color: #d97706; }
        .bg-blue-700 { background-color: #1d4ed8; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .bg-rose-700 { background-color: #be123c; }
        .hover\:bg-rose-600:hover { background-color: #e11d48; }
        .bg-indigo-700 { background-color: #4338ca; }
        .hover\:bg-indigo-600:hover { background-color: #4f46e5; }
        .bg-purple-700 { background-color: #7e22ce; }
        .hover\:bg-purple-600:hover { background-color: #9333ea; }
        .bg-teal-700 { background-color: #0f766e; }
        .hover\:bg-teal-600:hover { background-color: #14b8a6; }
        .bg-orange-700 { background-color: #c2410c; }
        .hover\:bg-orange-600:hover { background-color: #ea580c; }
        .bg-lime-700 { background-color: #4d7c0f; }
        .hover\:bg-lime-600:hover { background-color: #65a30d; }
        .bg-cyan-600 { background-color: #0891b2; }
        .hover\:bg-cyan-700:hover { background-color: #0e7490; }
        .bg-pink-600 { background-color: #db2777; }
        .hover\:bg-pink-700:hover { background-color: #be185d; }
    </style>
</head>
<body>
    <!-- Custom Loading Screen -->
    <div id="loading-screen">
        <img id="loading-app-icon" src="assets/appicon.png" alt="App Icon">
        <div class="spinner"></div>
        <p class="text-xl text-stone-300 mt-4">Loading LumberTycoon...</p>
        <p id="welcome-message" class="mt-8"></p>
    </div>

    <!-- New: Click to Start Overlay for Music Autoplay -->
    <div id="click-to-start-overlay" class="hidden">
        <h2 class="text-4xl font-bold text-stone-100 mb-8">Lumber Tycoon</h2>
        <p class="text-xl text-stone-300 mb-8">Welcome to LumberTycoon! Click Start Game to enable BG Music</p>
        <button id="startButton" class="px-8 py-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-full shadow-lg transition-all duration-200">
            Start Game
        </button>
    </div>

    <audio id="backgroundMusic" loop preload="auto">
        <source src="sfx/bgmusic.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div id="app-root" class="app-container">
        <!-- Music Controls - Will be rendered by JavaScript after initial load -->
        <div id="music-controls" class="absolute top-4 right-4 flex items-center space-x-2 bg-stone-800 p-2 rounded-lg shadow-md z-50 hidden">
            <button id="musicToggleButton" class="p-2 rounded-full bg-stone-700 hover:bg-stone-600 text-white">
                <span id="musicIcon">🎵</span> <!-- Placeholder for play/pause icon -->
            </button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.5" class="w-24 h-2 rounded-lg appearance-none cursor-pointer bg-stone-600 accent-blue-500">
        </div>
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <script type="module">
        // Game version constant
        const GAME_VERSION = "1.11.4";

        // Game state variables
        let woodCount = 0;
        let moneyCount = 0;
        let grapeLumberCount = 0; // New: Counter for grape lumber
        let soulLumberCount = 0; // New: Counter for Soul Lumber
        let rustyCanCount = 0; // New: Counter for Rusty Can
        let garbageCount = 0; // New: Counter for Garbage
        let screwsCount = 0; // New: Counter for Screws

        // Inventory Capacity Variables
        const DEFAULT_INVENTORY_CAPACITY = 500; // Default backpack capacity in kg
        const LUMBER_ITEM_WEIGHT = 0.25; // Weight of each regular and grape lumber item in kg
        const SOUL_LUMBER_ITEM_WEIGHT = 0.50; // Weight of each soul lumber item in kg
        let inventoryCapacity = DEFAULT_INVENTORY_CAPACITY; // Current total inventory capacity
        let currentInventoryWeight = 0; // Current weight of items in inventory

        let currentView = 'forest'; // 'forest', 'home', 'lumberMill', 'axeShop', 'biomes', 'purpleForest', 'carShop', 'deliveries', 'vampireForest', 'inventory', 'debug', 'settings', 'shops', 'quests', 'buySellShop', 'backpackShop'
        let lastLocation = 'forest'; // New: To store the last visited location
        let selectedFurnitureType = null; // For buying new furniture
        let sellWoodAmount = 1;
        let sellGrapeWoodAmount = 1; // New: Amount of grape lumber to sell
        let sellRustyCanAmount = 1; // New: Amount of Rusty Can to sell
        let sellGarbageAmount = 1; // New: Amount of Garbage to sell
        let sellScrewsAmount = 1; // New: Amount of Screws to sell

        let isCutting = false;
        let cuttingProgress = 0; // 0-100
        let cuttingIntervalRef = null;
        let currentCuttingTreeId = null;
        let currentAxeId = 'basic_axe'; // Default axe
        let ownedAxes = ['basic_axe']; // Start with basic axe

        // New state variables for furniture rearrangement and deletion
        let isRearrangingFurniture = false;
        let selectedFurnitureToMoveId = null; // The ID of the furniture being moved
        let isDeletingFurniture = false; // New state variable for delete mode

        // New state variables for selling wood progress
        let isSelling = false;
        let sellingProgress = 0; // 0-100
        let sellingIntervalRef = null;
        let currentSellAmount = 0; // To store the amount being sold during processing

        // New state variables for selling grape lumber progress
        let isSellingGrape = false; // New: State for selling grape lumber
        let sellingGrapeProgress = 0; // New: Progress for selling grape lumber
        let sellingGrapeIntervalRef = null; // New: Interval ref for selling grape lumber
        let currentSellGrapeAmount = 0; // New: Amount of grape lumber being sold

        // New state variables for selling junk items progress
        let isSellingJunk = false;
        let sellingJunkProgress = 0;
        let sellingJunkIntervalRef = null;
        let currentSellJunkAmount = 0;
        let currentSellJunkType = '';

        // House related state
        let currentHouseId = 'basic_home'; // Default house
        let ownedHouses = ['basic_home']; // Start with basic home
        // This object will store furniture for each house
        let allHousesFurniture = { 'basic_home': [] };
        let homeSubView = 'none'; // Changed default to 'none' to hide shop initially
        let currentFurnitureCategory = 'furniture'; // 'furniture', 'pets', 'generators' - New state for furniture categories
        let isFurnitureShopOpen = false; // Changed default to 'false' to hide shop initially

        // New state variable for biomes unlock
        let biomesUnlocked = false;
        // New state variable for Lumber Mill upgrade
        let lumberMillUpgraded = false; // Tracks if the lumber mill has been upgraded
        // New state variable for Vampire Forest unlock
        let vampireForestUnlocked = false; // Tracks if Vampire Forest is unlocked

        // Car and Delivery state variables
        let ownedCars = []; // Array to store IDs of owned cars
        let currentCarId = null; // ID of the currently equipped car
        let deliveriesUnlocked = false; // True if at least one car has been purchased

        let isDelivering = false; // State for delivery progress
        let deliveryProgress = 0; // 0-100
        let deliveryIntervalRef = null;
        let currentDeliveryRouteId = null; // ID of the route being delivered
        let currentDeliveryAmount = 0; // Amount of wood being delivered

        // New Quest state variables
        let questsUnlocked = true; // Changed to true to make quests show up at the start
        let isQuesting = false; // State for quest progress
        let questProgress = 0; // 0-100
        let questIntervalRef = null;
        let currentQuestId = null; // ID of the quest being undertaken
        let currentQuestLumberRequired = 0;

        // Backpack state variables
        let ownedBackpacks = ['basic_backpack']; // Start with basic backpack
        let currentBackpackId = 'basic_backpack'; // Default backpack

        // Idle Generation Variables
        let idleWoodGenerationInterval = null;
        let totalIdleWoodPerSecond = 0; // Sum of wood generated by all active generators
        let totalIdleSoulLumberPerSecond = 0; // New: Sum of soul lumber generated by all active generators

        // New: Global message box element
        let messageBox = null;

        // Debug console logs
        let debugConsoleLogs = [];
        const MAX_DEBUG_LOGS = 50; // Limit the number of logs to prevent performance issues

        // New: Flag to check if it's the first time the game is loaded
        const LOCAL_STORAGE_FIRST_LOAD_KEY = 'lumberTycoonFirstLoad';
        let isFirstLoad = localStorage.getItem(LOCAL_STORAGE_FIRST_LOAD_KEY) === null;

        // New: Music state variables
        let backgroundMusic;
        let musicVolume = 0.5; // Default volume
        let isBackgroundMusicPlaying = false;

        // Tone.js Players for sound effects
        let hoverSound; // This will now be used for hover sounds
        let buttonClickSound; // For general button clicks
        let purchaseSound;

        // Constants for touch-hold functionality
        const HOLD_DURATION = 700; // milliseconds
        const TOUCH_MOVE_THRESHOLD = 10; // pixels

        // Variables to track touch state for hold gesture
        let touchStartTimer = null;
        let touchStartX = 0;
        let touchStartY = 0;


        // Function to initialize Tone.js and load sounds
        const setupAudio = async () => {
            // Ensure Tone.js is started
            if (Tone.context.state !== 'running') {
                await Tone.start();
                addDebugLog("Tone.js audio context started.");
            }

            // Load hover sound (navbuttonclick.mp3)
            hoverSound = new Tone.Player({
                url: "sfx/navbuttonclick.mp3",
                onload: () => addDebugLog("Hover sound loaded."),
                onerror: (e) => addDebugLog(`Error loading hover sound: ${e}`)
            }).toDestination();

            // Load button click sound (clicksfx.mp3)
            buttonClickSound = new Tone.Player({
                url: "sfx/clicksfx.mp3",
                onload: () => addDebugLog("Button click sound loaded."),
                onerror: (e) => addDebugLog(`Error loading button click sound: ${e}`)
            }).toDestination();

            // Load purchase sound
            purchaseSound = new Tone.Player({
                url: "sfx/cashspend.mp3",
                onload: () => addDebugLog("Purchase sound loaded."),
                onerror: (e) => addDebugLog(`Error loading purchase sound: ${e}`)
            }).toDestination();
        };

        // Function to play hover sound
        const playHoverSound = () => {
            if (hoverSound && hoverSound.loaded) {
                // Stop if already playing to prevent layering
                if (hoverSound.state === 'started') {
                    hoverSound.stop();
                }
                hoverSound.start();
            } else {
                addDebugLog("Hover sound not loaded or not initialized.");
            }
        };

        // Function to stop hover sound on hover out
        const stopHoverSound = () => {
            if (hoverSound && hoverSound.loaded && hoverSound.state === 'started') {
                hoverSound.stop();
            }
        };

        // Function to play general button click sound
        const playButtonClickSound = () => {
            if (buttonClickSound && buttonClickSound.loaded) {
                if (buttonClickSound.state === 'started') {
                    buttonClickSound.stop();
                }
                buttonClickSound.start();
            } else {
                addDebugLog("Button click sound not loaded or not initialized.");
            }
        };

        // Function to play purchase sound
        const playPurchaseSound = () => {
            if (purchaseSound && purchaseSound.loaded) {
                purchaseSound.start();
            } else {
                addDebugLog("Purchase sound not loaded or not initialized.");
            }
        };


        // Function to show temporary messages
        const showMessage = (message, type = 'info', duration = 3000) => {
            // Instead of showing a pop-up, just log to the debug console
            addDebugLog(`Message (${type}): ${message}`);
            /*
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'globalMessageBox';
                messageBox.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-lg text-white z-[9999] transition-opacity duration-300 opacity-0';
                document.body.appendChild(messageBox);
            }

            messageBox.textContent = message;
            messageBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500'); // Clear previous types
            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }

            messageBox.classList.remove('opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, duration);
            */
        };

        // Local Storage Key
        const LOCAL_STORAGE_KEY = 'lumberTycoonSimulatorSave';

        // Utility function to generate a unique ID
        const generateUniqueId = () => {
            return 'id-' + Math.random().toString(36).substr(2, 9);
        };

        // Furniture data - Updated with explicit width and height for consistent placement
        const furnitureItems = [
            { id: 'chair', name: 'Chair', moneyCost: 100, imageUrl: 'assets/furniture/chair.png', width: 60, height: 60, category: 'furniture' },
            { id: 'table', name: 'Table', moneyCost: 100, imageUrl: 'assets/furniture/table.png', width: 90, height: 90, category: 'furniture' },
            { id: 'dining_table', name: 'Dining Table', moneyCost: 100, imageUrl: 'assets/furniture/dining-table.png', width: 120, height: 80, category: 'furniture' }, // New Dining Table
            { id: 'bed', name: 'Bed', moneyCost: 120, imageUrl: 'assets/furniture/bed.png', width: 90, height: 100, category: 'furniture' },
            { id: 'plant', name: 'Plant', moneyCost: 100, imageUrl: 'assets/furniture/plant1.png', width: 60, height: 60, category: 'furniture' },
            { id: 'sofa', name: 'Sofa', moneyCost: 130, imageUrl: 'assets/furniture/sofa.png', width: 140, height: 110, category: 'furniture' },
            { id: 'statue', name: 'Dragon Statue', moneyCost: 1500, imageUrl: 'assets/furniture/statue/dragon.png', width: 150, height: 200, category: 'furniture' }, // New statue item
            { id: 'midas_statue', name: 'Midas Statue', moneyCost: 2500, imageUrl: 'assets/furniture/midas-statue.png', width: 100, height: 180, category: 'furniture' }, // New Midas Statue item
            { id: 'bookshelf', name: 'Pool', moneyCost: 400, imageUrl: 'assets/furniture/pool.png', width: 100, height: 110, category: 'furniture' }, // New Bookshelf item
            { id: 'grand_piano', name: 'Water Fountain', moneyCost: 900, imageUrl: 'assets/furniture/water-fountain.png', width: 160, height: 140, category: 'furniture' }, // New Grand Piano item
            { id: 'dog', name: 'Dog', moneyCost: 200, imageUrl: 'assets/pets/dog.gif', width: 50, height: 50, category: 'pets' },
            { id: 'dragon', name: 'Dragon', moneyCost: 1999, imageUrl: 'assets/pets/dragon.png', width: 150, height: 130, category: 'pets' }, // Added Dragon pet
            { id: 'fireplace', name: 'Small Fountain', moneyCost: 900, imageUrl: 'assets/furniture/small-fountain.png', width: 100, height: 100, category: 'furniture' },
            { id: 'rug', name: 'High End Fountain', moneyCost: 1500, imageUrl: 'assets/furniture/extra-large-fountain.png', width: 150, height: 150, category: 'furniture' },
            { id: 'vault', name: 'Gold Fountain', moneyCost: 1500, imageUrl: 'assets/furniture/gold-fountain.png', width: 100, height: 100, category: 'furniture' }, // New Vault item
            { id: 'pool_table', name: 'Pool Table', moneyCost: 150, imageUrl: 'assets/furniture/pool-table.png', width: 90, height: 80, category: 'furniture' },
            { id: 'outdoor_pool', name: 'Crystal Statue', moneyCost: 750, imageUrl: 'assets/furniture/statue/crystal-statue.png', width: 150, height: 100, category: 'furniture' },
            { id: 'demonic_pool', name: 'Demonic Pool', moneyCost: 2999, imageUrl: 'assets/furniture/demonic-pool.png', width: 140, height: 120, category: 'furniture' },
            { id: 'chest', name: 'Safe', moneyCost: 300, imageUrl: 'assets/furniture/safe.png', width: 80, height: 80, category: 'furniture' }, // New Chest item
            { id: 'gun_case', name: 'Gun Case', moneyCost: 800, imageUrl: 'assets/furniture/gun-case.png', width: 90, height: 60, category: 'furniture' }, // Added Gun Case
            { id: 'scare_crow', name: 'Scare Crow', moneyCost: 1299, imageUrl: 'assets/furniture/scare-crow.png', width: 90, height: 150, category: 'furniture' }, // Added Scare Crow
            { id: 'money_wagon', name: 'Money Wagon', moneyCost: 1500, imageUrl: 'assets/furniture/money_wagon.png', width: 120, height: 80, category: 'furniture' }, // New Money Wagon item
            // New Demonic items
            { id: 'demonic_statue', name: 'Demonic Statue', moneyCost: 3500, imageUrl: 'assets/furniture/statue/demonic-statue.png', width: 110, height: 100, category: 'furniture' },
            { id: 'demonic_bed', name: 'Demonic Bed', moneyCost: 1500, imageUrl: 'assets/furniture/demonic-bed.png', width: 170, height: 170, category: 'furniture' },
            // New items added by the model
            { id: 'demonic_plant', name: 'Demonic Plant', moneyCost: 800, imageUrl: 'assets/furniture/demonic-plant.png', width: 80, height: 100, category: 'furniture' },
            { id: 'bear_statue', name: 'Bear Statue', moneyCost: 1300, imageUrl: 'assets/furniture/statue/bear.png', width: 100, height: 120, category: 'furniture' },
            { id: 'demonic_chest', name: 'Demonic Chest', moneyCost: 2000, imageUrl: 'assets/furniture/demonic-chest.png', width: 60, height: 60, category: 'furniture' }, // New Demonic Chest
            // Added new demonic furniture items
            { id: 'demonic_sofa', name: 'Demonic Sofa', moneyCost: 1800, imageUrl: 'assets/furniture/demonic-sofa.png', width: 150, height: 120, category: 'furniture' },
            { id: 'demonic_table', name: 'Demonic Table', moneyCost: 1000, imageUrl: 'assets/furniture/demonic-table.png', width: 120, height: 80, category: 'furniture' },
            { id: 'demonic_chair', name: 'Demonic Chair', moneyCost: 900, imageUrl: 'assets/furniture/demonic-chair.png', width: 70, height: 70, category: 'furniture' },
            // New Generator Item - Corrected imageUrl
            { id: 'basic_idle_generator', name: 'Basic Idle Generator', moneyCost: 3000, imageUrl: 'assets/furniture/generator1.png', width: 120, height: 120, category: 'generators', generatesWoodPerSecond: 0.25 },
            // New Soul Lumber Generator
            { id: 'soul_lumber_generator', name: 'Demonic Generator', moneyCost: 9999, imageUrl: 'assets/furniture/demonic-generator.png', width: 100, height: 100, category: 'generators', generatesSoulLumberPerSecond: 0.25 }, // 1 soul lumber every 4 seconds = 0.25 per second
            // NEW FURNITURE ITEMS ADDED
            { id: 'outdoor_pond', name: 'Outdoor Pond', moneyCost: 750, imageUrl: 'https://placehold.co/150x100/336699/FFFFFF?text=Outdoor+Pond', width: 150, height: 100, category: 'furniture' },
            { id: 'frog_statue', name: 'Frog Statue', moneyCost: 300, imageUrl: 'https://placehold.co/80x80/228B22/FFFFFF?text=Frog+Statue', width: 80, height: 80, category: 'furniture' },
            { id: 'demonic_shed', name: 'Demonic Shed', moneyCost: 2500, imageUrl: 'https://placehold.co/180x150/440000/FFFFFF?text=Demonic+Shed', width: 180, height: 150, category: 'furniture' },
        ];

        // Car data - Modified to give money bonus and delivery speed
        const carItems = [
            { id: 'bicycle', name: 'Basic Quad', moneyCost: 900, moneyBonusMultiplier: 1.0, deliverySpeedMultiplier: 1.2, imageUrl: 'assets/vehicles/basic-quad.png', deliversSoulLumber: false }, // No bonus
            { id: 'pickup_truck', name: 'Pickup Truck', moneyCost: 2000, moneyBonusMultiplier: 1.2, deliverySpeedMultiplier: 1.3, imageUrl: 'assets/vehicles/basic-truck.png', deliversSoulLumber: false }, // 20% more money
            { id: 'delivery_van', name: 'ATV', moneyCost: 3000, moneyBonusMultiplier: 1.5, deliverySpeedMultiplier: 1.5, imageUrl: 'assets/vehicles/atv2.png', deliversSoulLumber: false }, // 50% more money, 30% faster delivery
            { id: 'semi_truck', name: 'ATV', moneyCost: 5000, moneyBonusMultiplier: 5.0, deliverySpeedMultiplier: 5, imageUrl: 'assets/vehicles/atv.png', deliversSoulLumber: false }, // 100% more money, 30% faster delivery
            { id: 'demonic_mo_bile', name: 'Demonic Mo-Bile', moneyCost: 5000, moneyBonusMultiplier: 2.0, deliverySpeedMultiplier: 13, imageUrl: 'assets/vehicles/demonic-mo-bile.png', deliversSoulLumber: true }, // New Demonic Mo-Bile
            { id: 'nightcrawler_atv', name: 'Nightcrawler ATV', moneyCost: 8500, moneyBonusMultiplier: 3.0, deliverySpeedMultiplier: 13, imageUrl: 'assets/vehicles/nightcrawler-atv.png', deliversSoulLumber: true }, // New Nightcrawler ATV
        ];

        // Axe data
        const axeItems = [
            { id: 'basic_axe', name: 'Basic Axe', moneyCost: 0, cutSpeedMultiplier: 1, imageUrl: 'assets/axes/basic-axe.png' }, // Default axe
            { id: 'stone_axe', name: 'Stone Axe', moneyCost: 50, cutSpeedMultiplier: 1.5, imageUrl: 'assets/axes/stone-axe.png' }, // 50% faster
            { id: 'iron_axe', name: 'Iron Axe', moneyCost: 150, cutSpeedMultiplier: 2.5, imageUrl: 'assets/axes/iron-axe.png' }, // 150% faster
            { id: 'diamond_axe', name: 'Diamond Axe', moneyCost: 300, cutSpeedMultiplier: 5, imageUrl: 'assets/axes/diamond-axe.png' }, // 400% faster
            { id: 'steel_axe', name: 'Glowing Axe', moneyCost: 325, cutSpeedMultiplier: 5, imageUrl: 'assets/axes/steel-axe.png' }, // New Steel Axe, 5x faster
            { id: 'gold_axe', name: 'Juicy Axe', moneyCost: 500, cutSpeedMultiplier: 20, imageUrl: 'assets/axes/juicey-axe.png' }, // New Gold Axe, 6x faster (6% extra damage)
            { id: 'mighty_axe', name: 'Phase Axe', moneyCost: 1000, cutSpeedMultiplier: 30, imageUrl: 'assets/axes/phase-axe.png' }, // New Mighty Axe, 40% extra damage (20 * 1.4 = 28)
            { id: 'demonic_axe', name: 'Demonic AXE', moneyCost: 1499, cutSpeedMultiplier: 110, imageUrl: 'assets/axes/demonic-axe.png' },
        ];

        // Backpack data
        const backpackItems = [
            { id: 'basic_backpack', name: 'Basic Backpack', moneyCost: 0, capacityIncrease: 0, imageUrl: 'assets/nav/backpack.png' }, // Default, no extra capacity
            { id: 'small_backpack', name: 'Blue Backpack', moneyCost: 300, capacityIncrease: 400, imageUrl: 'assets/backpacks/blue-backpack.png' }, // +200kg
            { id: 'medium_backpack', name: 'Red Camo Backpack', moneyCost: 500, capacityIncrease: 900, imageUrl: 'assets/backpacks/red-camo.png' }, // +500kg
            { id: 'large_backpack', name: 'Yellow Backpack', moneyCost: 2000, capacityIncrease: 1000, imageUrl: 'assets/backpacks/yellow-backpack.png' }, // +1000kg
            { id: 'lumberjack_backpack', name: 'Off-White Backpack', moneyCost: 2500, capacityIncrease: 2500, imageUrl: 'assets/backpacks/offwhite-backpack.png' }, // +2500kg
            { id: 'demonic_backpack', name: 'Demonic Backpack', moneyCost: 5000, capacityIncrease: 5000, imageUrl: 'assets/backpacks/demonic-backpack.png' }, // +5000kg
        ];

        // House data
        const houseItems = [
            { id: 'basic_home', name: 'Basic Home', moneyCost: 0, imageUrl: 'assets/homes/basic-home.png' },
            { id: 'cottage', name: 'Medium Home', moneyCost: 3000, imageUrl: 'assets/homes/medium-home.png' },
            { id: 'mansion', name: 'Grand Mansion', moneyCost: 2000, imageUrl: 'assets/homes/grand-mansion.png' },
            { id: 'backyard', name: 'Backyard', moneyCost: 1000, imageUrl: 'assets/homes/backyard.png' }, // New Backyard home
            { id: 'demonic_cottage', name: 'Demonic Cottage', moneyCost: 29999, imageUrl: 'assets/homes/demonic-cottage.png' }, // Demonic Cottage is now purchasable
        ];

        // Delivery Route data - Added lumberType and lumberRequired for specific lumber types
        const deliveryRoutes = [
            { id: 'local_market', name: 'Local Market', baseTime: 5000, lumberType: 'wood', moneyReward: 100, lumberRequired: 100, imageUrl: 'assets/delivery/local-market.png' },
            { id: 'city_center', name: 'City Center', baseTime: 10000, lumberType: 'wood', moneyReward: 300, lumberRequired: 250, imageUrl: 'assets/delivery/city-center.png' },
            { id: 'distant_port', name: 'Distant Port', baseTime: 20000, lumberType: 'wood', moneyReward: 800, lumberRequired: 500, imageUrl: 'assets/delivery/distant-port.png' },
            // New routes for Soul Lumber - Base time increased significantly
            { id: 'spirit_realm_gate', name: 'Spirit Realm Gate', baseTime: 60000, lumberType: 'soulLumber', moneyReward: 1500, lumberRequired: 50, imageUrl: 'assets/delivery/spirit-gate-realm.png' }, // Increased from 15s to 60s
            { id: 'shadow_dimension', name: 'Shadow Dimension', baseTime: 120000, lumberType: 'soulLumber', moneyReward: 3000, lumberRequired: 100, imageUrl: 'assets/delivery/shadow-dimensions.png' }, // Increased from 25s to 120s
        ];

        // New: Quest Data - For building houses
        const questItems = [
            { id: 'small_house_quest', name: 'Small House Build', description: 'Build a small wooden house for a new settler.', lumberType: 'wood', lumberRequired: 500, moneyReward: 1500, baseTime: 30000, imageUrl: 'assets/quests/small-house.png' },
            { id: 'cottage_quest', name: 'Cozy Cottage Construction', description: 'Construct a cozy cottage for a growing family.', lumberType: 'wood', lumberRequired: 1500, moneyReward: 4500, baseTime: 60000, imageUrl: 'assets/quests/cottage.png' },
            { id: 'mansion_quest', name: 'Grand Mansion Project', description: 'Undertake the grand project of building a mansion.', lumberType: 'wood', lumberRequired: 5000, moneyReward: 15000, baseTime: 120000, imageUrl: 'assets/quests/grand-mansion.png' },
            { id: 'grape_house_quest', name: 'Purple Dream Home', description: 'Build a unique home using rare grape lumber.', lumberType: 'grapeLumber', lumberRequired: 350, moneyReward: 5000, baseTime: 90000, imageUrl: 'assets/quests/purple-house.png' },
            { id: 'soul_sanctuary_quest', name: 'Soul Sanctuary', description: 'Construct a mystical sanctuary from soul lumber.', lumberType: 'soulLumber', moneyReward: 100, moneyReward: 6000, baseTime: 180000, imageUrl: 'assets/quests/soul-sanctuary.png' },
        ];


        // Biome Data - Contains all biome definitions and their trees
        const biomesData = {
            'forest': {
                name: 'Green Forest',
                iconUrl: 'assets/tree.png',
                trees: [
                    { id: 'tree1', top: '20%', left: '10%', cutTime: 1000, imageUrl: 'assets/tree.png' }, // 1 second
                    { id: 'tree2', top: '50%', left: '30%', cutTime: 1500, imageUrl: 'assets/tree.png' }, // 1.5 seconds
                    { id: 'tree3', top: '30%', left: '60%', cutTime: 800, imageUrl: 'assets/tree.png' },  // 0.8 seconds
                    { id: 'tree4', top: '65%', left: '80%', cutTime: 2000, imageUrl: 'assets/tree.png' }, // 2 seconds
                    { id: 'tree5', top: '10%', left: '40%', cutTime: 1200, imageUrl: 'assets/tree.png' }, // 1.2 seconds
                    { id: 'tree6', top: '70%', left: '15%', cutTime: 900, imageUrl: 'assets/tree.png' },  // 0.9 seconds
                    { id: 'tree7', top: '45%', left: '85%', cutTime: 1800, imageUrl: 'assets/tree.png' }, // 1.8 seconds
                ]
            },
            'purpleForest': {
                name: 'Purple Tree Forest',
                iconUrl: 'assets/tree2.png', // Using the biomes icon for now, could be a new purple tree icon
                trees: [
                    { id: 'purpleTree1', top: '20%', left: '10%', cutTime: 5000, imageUrl: 'assets/tree2.png' }, // Increased from 2500 to 5000
                    { id: 'purpleTree2', top: '50%', left: '30%', cutTime: 6000, imageUrl: 'assets/tree2.png' }, // Increased from 3000 to 6000
                    { id: 'purpleTree3', top: '30%', left: '60%', cutTime: 4400, imageUrl: 'assets/tree2.png' },  // Increased from 2200 to 4400
                    { id: 'purpleTree4', top: '65%', left: '80%', cutTime: 7000, imageUrl: 'assets/tree2.png' }, // Increased from 3500 to 7000
                    { id: 'purpleTree5', top: '10%', left: '40%', cutTime: 5400, imageUrl: 'assets/tree2.png' }, // Increased from 2700 to 5400
                ]
            },
            'vampireForest': { // New Biome: Vampire Forest
                name: 'Soul Forest',
                iconUrl: 'assets/tree3.png', // Placeholder for a red tree icon
                trees: [
                    { id: 'vampireTree1', top: '25%', left: '15%', cutTime: 40000, imageUrl: 'assets/tree3.png' }, // Increased from 15000 to 30000
                    { id: 'vampireTree2', top: '55%', left: '40%', cutTime: 90000, imageUrl: 'assets/tree3.png' }, // Increased from 18000 to 36000
                    { id: 'vampireTree3', top: '35%', left: '70%', cutTime: 99000, imageUrl: 'assets/tree3.png' }, // Increased from 13000 to 26000
                    { id: 'vampireTree4', top: '60%', left: '20%', cutTime: 60000, imageUrl: 'assets/tree3.png' }, // 20000 to 40000
                ]
            }
        };


        // Conversion rate for wood to money
        const WOOD_TO_MONEY_RATE = 1; // 1 wood = 1 money
        const GRAPE_WOOD_TO_MONEY_RATE = 3.50; // New: 1 grape wood = 3.50 money
        const RUSTY_CAN_TO_MONEY_RATE = 60; // 1 Rusty Can = 0.5 money
        const GARBAGE_TO_MONEY_RATE = 50; // 1 Garbage = 0.2 money
        const SCREWS_TO_MONEY_RATE = 90; // 1 Screws = 1.0 money

        const SELL_TIME_PER_WOOD_MS = 100; // 100ms per wood unit to sell
        const SELL_TIME_PER_GRAPE_WOOD_MS = 150; // New: 150ms per grape wood unit to sell
        const SELL_TIME_PER_JUNK_MS = 50; // 50ms per junk item to sell

        const LUMBER_MILL_UPGRADE_COST = 500; // Cost to upgrade the lumber mill

        // Icon URLs - Updated to use placeholder images
        const woodIconUrl = 'assets/items/lumber.png';
        const moneyIconUrl = 'assets/items/cash.png';
        const grapeLumberIconUrl = 'assets/items/purple-lumber.png'; // New: Placeholder icon for Grape Lumber
        const soulLumberIconUrl = 'assets/items/soul-lumber.png'; // New: Placeholder icon for Soul Lumber
        const rustyCanIconUrl = 'assets/items/rusty-can.png'; // New: Icon for Rusty Can
        const garbageIconUrl = 'assets/items/garbage.png'; // New: Icon for Garbage
        const screwsIconUrl = 'assets/items/screws.png'; // New: Icon for Screws

        const lumberMillIconUrl = 'assets/nav/lumbermill.png';
        const axeShopIconUrl = 'assets/nav/shop.png';
        const homeIconUrl = 'assets/nav/home.png';
        const biomesIconUrl = 'assets/tree2.png'; // New icon for biomes
        const carShopIconUrl = 'assets/vehicles/pickup-truck.png'; // New icon for car shop
        const deliveriesIconUrl = 'assets/vehicles/basic-truck.png'; // New icon for deliveries
        const inventoryIconUrl = 'assets/nav/backpack.png'; // New icon for inventory
        const debugIconUrl = 'assets/nav/debug.png'; // Simple debug icon
        const shopsIconUrl = 'assets/nav/shops.png'; // New icon for shops
        const settingsIconUrl = 'assets/nav/settings.png'; // New icon for settings
        const questsIconUrl = 'assets/nav/quests.png'; // New icon for quests
        const buySellShopIconUrl = 'assets/nav/buysell.png'; // New icon for Buy & Sell shop


        // --- UI Update Functions ---
        const getAppRoot = () => document.getElementById('app-root');

        // Function to calculate current inventory weight
        const calculateCurrentInventoryWeight = () => {
            return (woodCount * LUMBER_ITEM_WEIGHT) +
                   (grapeLumberCount * LUMBER_ITEM_WEIGHT) +
                   (soulLumberCount * SOUL_LUMBER_ITEM_WEIGHT); // Use new constant for soul lumber
        };

        // Function to update inventory capacity based on equipped backpack
        const updateInventoryCapacity = () => {
            const equippedBackpack = backpackItems.find(bp => bp.id === currentBackpackId);
            inventoryCapacity = DEFAULT_INVENTORY_CAPACITY + (equippedBackpack ? equippedBackpack.capacityIncrease : 0);
        };

        const updateCurrencyDisplay = () => {
            const woodSpan = document.getElementById('woodCount');
            const moneySpan = document.getElementById('moneyCount');
            const grapeLumberSpan = document.getElementById('grapeLumberCount'); // New: Get grape lumber span
            const soulLumberSpan = document.getElementById('soulLumberCount'); // New: Get soul lumber span
            const rustyCanSpan = document.getElementById('rustyCanCount'); // New: Get rusty can span
            const garbageSpan = document.getElementById('garbageCount'); // New: Get garbage span
            const screwsSpan = document.getElementById('screwsCount'); // New: Get screws span
            const idleWoodRateSpan = document.getElementById('idleWoodRate'); // New: Get idle wood rate span
            const idleSoulLumberRateSpan = document.getElementById('idleSoulLumberRate'); // New: Get idle soul lumber rate span
            
            // New: Inventory capacity display elements
            const currentInventoryWeightSpan = document.getElementById('currentInventoryWeight');
            const inventoryCapacitySpan = document.getElementById('inventoryCapacity');

            // Get the new axe and car display elements
            const currentAxeDisplayDiv = document.getElementById('currentAxeDisplay');
            const currentCarDisplayDiv = document.getElementById('currentCarDisplay');
            // New: Current Backpack Display element
            const currentBackpackDisplayDiv = document.getElementById('currentBackpackDisplay');


            if (woodSpan) woodSpan.textContent = woodCount;
            if (moneySpan) moneySpan.textContent = moneyCount;
            if (grapeLumberSpan) grapeLumberSpan.textContent = grapeLumberCount; // New: Update grape lumber count
            if (soulLumberSpan) soulLumberSpan.textContent = soulLumberCount; // New: Update soul lumber count
            if (rustyCanSpan) rustyCanSpan.textContent = rustyCanCount; // New: Update rusty can count
            if (garbageSpan) garbageSpan.textContent = garbageCount; // New: Update garbage count
            if (screwsSpan) screwsSpan.textContent = screwsCount; // New: Update screws count
            if (idleWoodRateSpan) idleWoodRateSpan.textContent = `${totalIdleWoodPerSecond}/sec`;
            if (idleSoulLumberRateSpan) idleSoulLumberRateSpan.textContent = `${totalIdleSoulLumberPerSecond}/sec`;

            // Update inventory weight and capacity
            currentInventoryWeight = calculateCurrentInventoryWeight(); // Recalculate weight
            updateInventoryCapacity(); // Recalculate capacity based on equipped backpack

            if (currentInventoryWeightSpan) currentInventoryWeightSpan.textContent = currentInventoryWeight.toFixed(2);
            if (inventoryCapacitySpan) inventoryCapacitySpan.textContent = inventoryCapacity;


            // Update Current Axe Display
            if (currentAxeDisplayDiv) {
                const currentAxe = axeItems.find(axe => axe.id === currentAxeId);
                if (currentAxe) {
                    currentAxeDisplayDiv.innerHTML = `
                        <img src="${currentAxe.imageUrl}" alt="${currentAxe.name}" class="w-16 h-16 rounded-full object-contain mr-2" />
                        <span class="text-2xl font-bold text-cyan-400">${currentAxe.name}</span>
                        <span class="text-lg text-stone-300 ml-2">(Cuts ${currentAxe.cutSpeedMultiplier}x faster)</span>
                    `;
                    currentAxeDisplayDiv.classList.remove('hidden');
                } else {
                    currentAxeDisplayDiv.classList.add('hidden');
                }
            }

            // Update Current Car Display
            if (currentCarDisplayDiv) {
                const currentCar = carItems.find(car => car.id === currentCarId);
                if (currentCar) {
                    currentCarDisplayDiv.innerHTML = `
                        <img src="${currentCar.imageUrl}" alt="${currentCar.name}" class="w-16 h-16 rounded-full object-contain mr-2" />
                        <span class="text-2xl font-bold text-cyan-400">${currentCar.name}</span>
                        <span class="text-lg text-stone-300 ml-2">(Gives ${currentCar.moneyBonusMultiplier}x more money, Delivers ${currentCar.deliverySpeedMultiplier}x faster)</span>
                    `;
                    currentCarDisplayDiv.classList.remove('hidden');
                } else {
                    currentCarDisplayDiv.classList.add('hidden');
                }
            }

            // Update Current Backpack Display
            if (currentBackpackDisplayDiv) {
                const currentBackpack = backpackItems.find(bp => bp.id === currentBackpackId);
                if (currentBackpack) {
                    currentBackpackDisplayDiv.innerHTML = `
                        <img src="${currentBackpack.imageUrl}" alt="${currentBackpack.name}" class="w-16 h-16 rounded-full object-contain mr-2" />
                        <span class="text-2xl font-bold text-green-400">${currentBackpack.name}</span>
                        <span class="text-lg text-stone-300 ml-2">(Capacity: ${DEFAULT_INVENTORY_CAPACITY + currentBackpack.capacityIncrease}kg)</span>
                    `;
                    currentBackpackDisplayDiv.classList.remove('hidden');
                } else {
                    currentBackpackDisplayDiv.classList.add('hidden');
                }
            }
        };

        // updateAxeDisplay and updateCarDisplay functions are now integrated into updateCurrencyDisplay
        // and will be called when the inventory view is rendered.
        // Removed original updateAxeDisplay and updateCarDisplay as separate functions.

        const setupNavigation = () => {
            const navContainer = document.createElement('div');
            // Adjusted classes for better mobile responsiveness:
            // - Replaced space-x-4 with gap-2 for consistent spacing even when wrapping.
            // - Added flex-wrap to allow items to wrap onto multiple lines.
            // - Ensured justify-center for horizontal centering.
            navContainer.className = "flex flex-wrap justify-center gap-2 mb-8";

            const createNavButton = (viewName, label, iconUrl, activeClass, inactiveClass, onClick = null) => {
                const button = document.createElement('button');
                // Use img tag for icon
                button.innerHTML = `<img src="${iconUrl}" alt="${label} Icon" class="nav-icon" />${label}`;
                // Adjusted px-6 to px-4 for slightly less horizontal padding on buttons
                button.className = `nav-button-base ${currentView === viewName ? activeClass + ' nav-button-active' : inactiveClass + ' nav-button-inactive'}`;
                
                // Add hover sound listeners
                button.addEventListener('mouseover', playHoverSound);
                button.addEventListener('mouseout', stopHoverSound);
                // Add click sound listener
                button.addEventListener('click', playButtonClickSound);

                button.addEventListener('click', () => {
                    // If currently selling, stop the process before navigating
                    if (isSelling) {
                        clearInterval(sellingIntervalRef);
                        sellingIntervalRef = null;
                        isSelling = false;
                        sellingProgress = 0;
                        currentSellAmount = 0;
                        // Removed selling sound stop: if (sellingSound && sellingSound.state === 'started') { sellingSound.stop(); }
                    }
                    // New: If currently selling grape lumber, stop the process
                    if (isSellingGrape) {
                        clearInterval(sellingGrapeIntervalRef);
                        sellingGrapeIntervalRef = null;
                        isSellingGrape = false;
                        sellingGrapeProgress = 0;
                        currentSellGrapeAmount = 0;
                        // Removed selling sound stop: if (sellingSound && sellingSound.state === 'started') { sellingSound.stop(); }
                    }
                    // New: If currently selling junk, stop the process
                    if (isSellingJunk) {
                        clearInterval(sellingJunkIntervalRef);
                        sellingJunkIntervalRef = null;
                        isSellingJunk = false;
                        sellingJunkProgress = 0;
                        currentSellJunkAmount = 0;
                        currentSellJunkType = '';
                    }
                    // If currently cutting, stop the process before navigating
                    if (isCutting) {
                        clearInterval(cuttingIntervalRef);
                        cuttingIntervalRef = null;
                        isCutting = false;
                        cuttingProgress = 0;
                        currentCuttingTreeId = null;
                    }
                    // If currently delivering, stop the process before navigating
                    if (isDelivering) {
                        clearInterval(deliveryIntervalRef);
                        deliveryIntervalRef = null;
                        isDelivering = false;
                        deliveryProgress = 0;
                        currentDeliveryRouteId = null;
                        currentDeliveryAmount = 0;
                        // Removed delivery sound stop: if (deliverySound && deliverySound.state === 'started') { deliverySound.stop(); }
                    }
                    // New: If currently questing, stop the process before navigating
                    if (isQuesting) {
                        clearInterval(questIntervalRef);
                        questIntervalRef = null;
                        isQuesting = false;
                        questProgress = 0;
                        currentQuestId = null;
                        currentQuestLumberRequired = 0;
                    }


                    // Reset all furniture modes when navigating between main views
                    isRearrangingFurniture = false;
                    isDeletingFurniture = false;
                    selectedFurnitureToMoveId = null;
                    selectedFurnitureType = null;
                    isFurnitureShopOpen = false; // Close furniture shop when navigating to other main views
                    
                    // Play button click sound
                    playButtonClickSound();

                    currentView = viewName;
                    lastLocation = viewName; // Update lastLocation on navigation
                    // Reset homeSubView and furniture modes when navigating away from or to home or shops
                    if (viewName === 'home' || viewName === 'shops' || viewName === 'buySellShop' || viewName === 'backpackShop') { // Added backpackShop
                        homeSubView = 'none'; // Reset to default home sub-view (hidden)
                        currentFurnitureCategory = 'furniture'; // Reset to default furniture category
                        isFurnitureShopOpen = false; // Keep shop closed by default when entering home view
                    } else {
                        homeSubView = 'none'; // Ensure home sub-view is 'none' if not in home view
                    }
                    
                    if (onClick) { // Execute custom click handler if provided
                        onClick();
                    } else {
                        renderApp();
                        saveGame(); // Save game state after navigation
                    }
                });
                return button;
            };

            // Main Navigation Buttons - Adjusted colors for new theme
            navContainer.appendChild(createNavButton('forest', 'Chop Trees', biomesData.forest.iconUrl, 'bg-emerald-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600'));
            navContainer.appendChild(createNavButton('lumberMill', 'Lumber Mill', lumberMillIconUrl, 'bg-amber-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600'));
            // Replaced individual shop buttons with a single 'Shops' button
            navContainer.appendChild(createNavButton('shops', 'Shops', shopsIconUrl, 'bg-rose-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600'));
            navContainer.appendChild(createNavButton('buySellShop', 'Buy & Sell', buySellShopIconUrl, 'bg-lime-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600')); // New Buy & Sell Shop
            navContainer.appendChild(createNavButton('home', 'Your Home', homeIconUrl, 'bg-indigo-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600'));
            
            // New Biomes Button - only show if unlocked
            if (biomesUnlocked) { // Show if biomesUnlocked is true
                navContainer.appendChild(createNavButton('biomes', 'Biomes', biomesIconUrl, 'bg-purple-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600'));
            }

            // New Deliveries Button - only show if unlocked
            if (deliveriesUnlocked) {
                navContainer.appendChild(createNavButton('deliveries', 'Deliveries', deliveriesIconUrl, 'bg-teal-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600'));
            }

            // New Quests Button - questsUnlocked is now true by default
            navContainer.appendChild(createNavButton('quests', 'Quests', questsIconUrl, 'bg-orange-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600'));
            

            // New Inventory Button
            navContainer.appendChild(createNavButton('inventory', 'Inventory', inventoryIconUrl, 'bg-stone-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600'));

            // New Settings Button (replaces Debug in navbar)
            navContainer.appendChild(createNavButton('settings', 'Settings', settingsIconUrl, 'bg-blue-700 text-white shadow-lg', 'bg-stone-700 text-stone-100 hover:bg-stone-600'));

            return navContainer;
        };

        // --- View Rendering Functions ---
        const renderTreeChoppingView = (biomeId) => {
            const biome = biomesData[biomeId];
            if (!biome) {
                console.error(`Biome with ID ${biomeId} not found.`);
                return document.createElement('div'); // Return an empty div or error message
            }

            const choppingDiv = document.createElement('div');
            // Dynamically set background color based on biome
            let biomeBgColor = '';
            let biomeGroundColor = '';
            let progressBarClass = '';

            switch (biomeId) {
                case 'purpleForest':
                    biomeBgColor = 'bg-purple-900/50';
                    biomeGroundColor = 'bg-purple-800';
                    progressBarClass = 'progress-bar-purple';
                    break;
                case 'vampireForest': // New: Vampire Forest colors
                    biomeBgColor = 'bg-red-900/50';
                    biomeGroundColor = 'bg-red-800';
                    progressBarClass = 'progress-bar-red';
                    break;
                case 'forest':
                default:
                    biomeBgColor = 'bg-emerald-900/50'; // Changed from green-900/50
                    biomeGroundColor = 'bg-emerald-800'; // Changed from green-800
                    progressBarClass = ''; // Default green
                    break;
            }

            choppingDiv.className = `w-full h-[400px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-wrap justify-around items-center gap-8 relative overflow-hidden`;
            choppingDiv.innerHTML = `
                <div class="absolute top-0 left-0 w-full h-full ${biomeBgColor} to-transparent pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-full h-20 ${biomeGroundColor} rounded-b-lg pointer-events-none"></div>
                <p class="text-lg text-stone-300 absolute bottom-4 left-1/2 -translate-x-1/2">Click on trees to chop wood!</p>
            `;

            biome.trees.forEach(treeData => {
                const treeWrapper = document.createElement('div'); // Create a wrapper for positioning
                treeWrapper.style.position = 'absolute';
                treeWrapper.style.top = treeData.top;
                treeWrapper.style.left = treeData.left;
                treeWrapper.style.width = '80px'; /* Match image width */
                treeWrapper.style.height = '120px'; /* Match image height */

                const treeElement = document.createElement('img'); // Change to img tag
                treeElement.id = `tree-${treeData.id}`; // Unique ID for each tree DOM element
                treeElement.className = `tree-image ${isCutting && currentCuttingTreeId !== treeData.id ? 'cursor-not-allowed opacity-70' : ''}`;
                treeElement.src = treeData.imageUrl; // Set image source
                treeElement.alt = `Tree ${treeData.id}`; // Add alt text

                treeElement.addEventListener('click', (e) => chopTree(treeData.id, e));

                // Progress bar container for each tree
                const progressBarContainer = document.createElement('div');
                progressBarContainer.className = "progress-bar-container";
                const progressBar = document.createElement('div');
                // Add class for purple progress bar if it's the purple forest biome
                progressBar.className = `progress-bar ${progressBarClass}`;
                progressBarContainer.appendChild(progressBar);
                
                // Append image first, then progress bar container so progress bar is on top
                treeWrapper.appendChild(treeElement); 
                treeWrapper.appendChild(progressBarContainer); 

                // Control visibility based on cutting state
                if (isCutting && currentCuttingTreeId === treeData.id) {
                    progressBarContainer.classList.remove('hidden');
                    progressBar.style.width = `${cuttingProgress}%`;
                } else {
                    progressBarContainer.classList.add('hidden');
                }

                choppingDiv.appendChild(treeWrapper); // Append wrapper to chopping div
            });

            return choppingDiv;
        };

        const renderLumberMillView = () => {
            const lumberMillDiv = document.createElement('div');
            // Changed align-items to flex-start and added overflow-auto
            lumberMillDiv.className = "w-full h-[540px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-start relative overflow-auto";

            // Initialize sell amounts for display, but don't cap them here
            // These variables will store the *last valid entered amount* or a default.
            if (sellWoodAmount === 0 && woodCount > 0) {
                sellWoodAmount = 1;
            }
            if (sellGrapeWoodAmount === 0 && grapeLumberCount > 0) {
                sellGrapeWoodAmount = 1;
            }

            lumberMillDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-amber-400 mb-6">Welcome to the Lumber Mill!</h2>
                <p class="text-lg text-stone-300 mb-4">Sell your wood here to earn money.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full"> <!-- New grid container -->
                    <div class="bg-stone-900 p-6 rounded-lg shadow-md flex flex-col items-center gap-4">
                        <h3 class="text-2xl font-bold text-stone-100">Sell Regular Lumber</h3>
                        <div class="flex items-center space-x-2">
                            <label for="sellAmount" class="text-lg font-medium text-stone-100">Sell:</label>
                            <input
                                type="number"
                                id="sellAmount"
                                min="0"
                                value="${sellWoodAmount}"
                                class="w-24 p-2 border border-stone-600 rounded-md text-center text-lg font-semibold bg-stone-700 text-stone-100"
                                ${isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}
                            />
                            <span class="text-lg font-medium text-stone-100">Wood</span>
                        </div>
                        <p class="text-md text-stone-300">You will get: <span class="font-bold text-emerald-400" id="sellMoneyPreview">${sellWoodAmount * WOOD_TO_MONEY_RATE}</span> <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>

                        <!-- Selling Progress Bar -->
                        <div id="sellingProgressBarContainer" class="progress-bar-container w-full max-w-xs ${isSelling ? '' : 'hidden'}">
                            <div id="sellingProgressBar" class="progress-bar bg-blue-500" style="width: ${sellingProgress}%"></div>
                        </div>
                        <p id="sellingStatus" class="text-sm text-blue-400 ${isSelling ? '' : 'hidden'}">Processing ${currentSellAmount} wood...</p>

                        <button id="sellWoodButton" class="px-8 py-3 rounded-full font-semibold text-white shadow-lg transition-all duration-200 ease-in-out
                            ${sellWoodAmount > 0 && !isSelling && !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk ? 'bg-amber-600 hover:bg-amber-700' : 'bg-stone-600 cursor-not-allowed'}"
                            ${sellWoodAmount <= 0 || isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}>
                            Exchange Lumber
                        </button>
                    </div>

                    <!-- Upgrade Lumber Mill Section -->
                    <div class="bg-stone-900 p-6 rounded-lg shadow-md flex flex-col items-center gap-4 ${lumberMillUpgraded ? 'hidden' : ''}">
                        <h3 class="text-2xl font-bold text-yellow-300">Cannot Exchange</h3>
                        <p class="text-lg text-stone-300">Locked</p>
                        <p class="text-xl font-bold text-emerald-400">Cost: ${LUMBER_MILL_UPGRADE_COST} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                        <button id="upgradeLumberMillButton" class="px-8 py-3 rounded-full font-semibold text-white shadow-lg transition-all duration-200 ease-in-out
                            ${moneyCount >= LUMBER_MILL_UPGRADE_COST ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-stone-600 cursor-not-allowed'}"
                            ${moneyCount < LUMBER_MILL_UPGRADE_COST ? 'disabled' : ''}>
                            Upgrade Lumber Mill
                        </button>
                        ${moneyCount < LUMBER_MILL_UPGRADE_COST ? '<p class="text-red-400 text-sm mt-2">Not enough money!</p>' : ''}
                    </div>

                    <!-- New Section: Sell Grape Lumber - only visible if lumberMillUpgraded is true -->
                    <div class="bg-stone-900 p-6 rounded-lg shadow-md flex flex-col items-center gap-4 ${lumberMillUpgraded ? '' : 'hidden'}">
                        <h3 class="text-2xl font-bold text-purple-300">Sell Grape Lumber</h3>
                        <div class="flex items-center space-x-2">
                            <label for="sellGrapeAmount" class="text-lg font-medium text-stone-100">Sell:</label>
                            <input
                                type="number"
                                id="sellGrapeAmount"
                                min="0"
                                value="${sellGrapeWoodAmount}"
                                class="w-24 p-2 border border-stone-600 rounded-md text-center text-lg font-semibold bg-stone-700 text-stone-100"
                                ${isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}
                            />
                            <span class="text-lg font-medium text-stone-100">Grape Lumber</span>
                        </div>
                        <p class="text-md text-stone-300">You will get: <span class="font-bold text-emerald-400" id="sellGrapeMoneyPreview">${sellGrapeWoodAmount * GRAPE_WOOD_TO_MONEY_RATE}</span> <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>

                        <!-- Selling Grape Progress Bar -->
                        <div id="sellingGrapeProgressBarContainer" class="progress-bar-container w-full max-w-xs ${isSellingGrape ? '' : 'hidden'}">
                            <div id="sellingGrapeProgressBar" class="progress-bar progress-bar-purple" style="width: ${sellingGrapeProgress}%"></div>
                        </div>
                        <p id="sellingGrapeStatus" class="text-sm text-purple-400 ${isSellingGrape ? '' : 'hidden'}">Processing ${currentSellGrapeAmount} Grape Lumber...</p>

                        <button id="sellGrapeWoodButton" class="px-8 py-3 rounded-full font-semibold text-white shadow-lg transition-all duration-200 ease-in-out
                            ${sellGrapeWoodAmount > 0 && !isSelling && !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk ? 'bg-purple-600 hover:bg-purple-700' : 'bg-stone-600 cursor-not-allowed'}"
                            ${sellGrapeWoodAmount <= 0 || isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}>
                            Exchange Grape Lumber
                        </button>
                    </div>
                </div> <!-- End of grid container -->
            `;

            // Event listener for sellAmount input
            lumberMillDiv.querySelector('#sellAmount').addEventListener('input', (e) => {
                let inputValue = parseInt(e.target.value);

                if (isNaN(inputValue) || inputValue < 0) {
                    sellWoodAmount = 0;
                } else {
                    sellWoodAmount = inputValue;
                }

                // Update money preview
                const sellMoneyPreviewSpan = lumberMillDiv.querySelector('#sellMoneyPreview');
                if (sellMoneyPreviewSpan) {
                    sellMoneyPreviewSpan.textContent = sellWoodAmount * WOOD_TO_MONEY_RATE;
                }

                // Update button state
                const sellWoodButton = lumberMillDiv.querySelector('#sellWoodButton');
                if (sellWoodButton) {
                    const canSell = sellWoodAmount > 0 && !isSelling && !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk;
                    sellWoodButton.disabled = !canSell;
                    if (canSell) {
                        sellWoodButton.classList.remove('bg-stone-600', 'cursor-not-allowed');
                        sellWoodButton.classList.add('bg-amber-600', 'hover:bg-amber-700');
                    } else {
                        sellWoodButton.classList.remove('bg-amber-600', 'hover:bg-amber-700');
                        sellWoodButton.classList.add('bg-stone-600', 'cursor-not-allowed');
                    }
                }
            });

            lumberMillDiv.querySelector('#sellWoodButton').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                sellWood();
            });

            // Add event listener for the new upgrade button
            const upgradeButton = lumberMillDiv.querySelector('#upgradeLumberMillButton');
            if (upgradeButton) { // Ensure button exists before adding listener
                upgradeButton.addEventListener('click', () => {
                    playButtonClickSound(); // Play sound on click
                    upgradeLumberMill();
                });
            }

            // New: Event listeners for Grape Lumber selling (only if upgraded)
            if (lumberMillUpgraded) {
                lumberMillDiv.querySelector('#sellGrapeAmount').addEventListener('input', (e) => {
                    let inputValue = parseInt(e.target.value);

                    if (isNaN(inputValue) || inputValue < 0) {
                        sellGrapeWoodAmount = 0;
                    } else {
                        sellGrapeWoodAmount = inputValue;
                    }

                    // Update money preview
                    const sellGrapeMoneyPreviewSpan = lumberMillDiv.querySelector('#sellGrapeMoneyPreview');
                    if (sellGrapeMoneyPreviewSpan) {
                        sellGrapeMoneyPreviewSpan.textContent = sellGrapeWoodAmount * GRAPE_WOOD_TO_MONEY_RATE;
                    }

                    // Update button state
                    const sellGrapeWoodButton = lumberMillDiv.querySelector('#sellGrapeWoodButton');
                    if (sellGrapeWoodButton) {
                        const canSell = sellGrapeWoodAmount > 0 && !isSelling && !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk;
                        sellGrapeWoodButton.disabled = !canSell;
                        if (canSell) {
                            sellGrapeWoodButton.classList.remove('bg-stone-600', 'cursor-not-allowed');
                            sellGrapeWoodButton.classList.add('bg-purple-600', 'hover:bg-purple-700');
                        } else {
                            sellGrapeWoodButton.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                            sellGrapeWoodButton.classList.add('bg-stone-600', 'cursor-not-allowed');
                        }
                    }
                });
                lumberMillDiv.querySelector('#sellGrapeWoodButton').addEventListener('click', () => {
                    playButtonClickSound(); // Play sound on click
                    sellGrapeWood();
                });
            }

            return lumberMillDiv;
        };

        const renderAxeShopView = () => {
            const axeShopDiv = document.createElement('div');
            axeShopDiv.className = "w-full h-[400px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-hidden";
            // Removed fixed height to allow it to grow with content
            axeShopDiv.style.height = 'auto';
            axeShopDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-rose-400 mb-6">Axe Shop</h2>
                <p class="text-lg text-stone-300 mb-4">Upgrade your axe to cut trees faster!</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-2xl" id="axeItemsContainer">
                    <!-- Axe items will be dynamically added here -->
                </div>
            `;

            const axeItemsContainer = axeShopDiv.querySelector('#axeItemsContainer');
            axeItems.forEach(axe => {
                const axeCard = document.createElement('div');
                axeCard.className = `bg-stone-900 p-4 rounded-lg shadow-md flex flex-col items-center border-2
                    ${currentAxeId === axe.id ? 'border-cyan-500 ring-4 ring-cyan-200' : 'border-stone-600'}
                    ${moneyCount < axe.moneyCost && !ownedAxes.includes(axe.id) ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg transition-shadow duration-200'}
                `;
                axeCard.innerHTML = `
                    <img src="${axe.imageUrl}" alt="${axe.name}" class="w-20 h-20 mb-3 rounded-full object-contain" />
                    <h3 class="text-xl font-semibold text-stone-100">${axe.name}</h3>
                    <p class="text-sm text-stone-300">Cuts: ${axe.cutSpeedMultiplier}x faster</p>
                    <p class="text-lg font-bold text-emerald-400 mt-2">Cost: ${axe.moneyCost} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                `;

                const button = document.createElement('button');
                button.className = `mt-4 px-6 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out`;

                // Fix for InvalidCharacterError: Use spread operator for multiple classes
                if (ownedAxes.includes(axe.id)) {
                    button.textContent = currentAxeId === axe.id ? 'Equipped' : 'Equip';
                    button.classList.add(...(currentAxeId === axe.id ? ['bg-cyan-600', 'cursor-default'] : ['bg-cyan-700', 'hover:bg-cyan-600']));
                    button.disabled = currentAxeId === axe.id;
                    button.addEventListener('click', () => {
                        playButtonClickSound(); // Play sound on click
                        equipAxe(axe.id);
                    });
                } else {
                    button.textContent = 'Buy Axe';
                    button.classList.add(...(moneyCount >= axe.moneyCost ? ['bg-rose-600', 'hover:bg-rose-700'] : ['bg-stone-600', 'cursor-not-allowed']));
                    button.disabled = moneyCount < axe.moneyCost;
                    button.addEventListener('click', () => {
                        playButtonClickSound(); // Play sound on click
                        buyAxe(axe.id);
                    });
                }
                axeCard.appendChild(button);
                axeItemsContainer.appendChild(axeCard);
            });

            return axeShopDiv;
        };

        // New: renderCarShopView function
        const renderCarShopView = () => {
            const carShopDiv = document.createElement('div');
            carShopDiv.className = "w-full h-[400px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-hidden";
            carShopDiv.style.height = 'auto';
            carShopDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-cyan-400 mb-6">Car Shop</h2>
                <p class="text-lg text-stone-300 mb-4">Purchase vehicles to deliver lumber faster!</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-2xl" id="carItemsContainer">
                    <!-- Car items will be dynamically added here -->
                </div>
            `;

            const carItemsContainer = carShopDiv.querySelector('#carItemsContainer');
            carItems.forEach(car => {
                const carCard = document.createElement('div');
                carCard.className = `bg-stone-900 p-4 rounded-lg shadow-md flex flex-col items-center border-2
                    ${currentCarId === car.id ? 'border-cyan-500 ring-4 ring-cyan-200' : 'border-stone-600'}
                    ${moneyCount < car.moneyCost && !ownedCars.includes(car.id) ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg transition-shadow duration-200'}
                `;
                carCard.innerHTML = `
                    <img src="${car.imageUrl}" alt="${car.name}" class="w-20 h-20 mb-3 rounded-full object-contain" />
                    <h3 class="text-xl font-semibold text-stone-100">${car.name}</h3>
                    <p class="text-sm text-stone-300">Money Bonus: ${car.moneyBonusMultiplier}x</p>
                    <p class="text-sm text-stone-300">Delivery Speed: ${car.deliverySpeedMultiplier}x faster</p>
                    ${car.deliversSoulLumber ? '<p class="text-sm text-red-400">Delivers Soul Lumber</p>' : ''}
                    <p class="text-lg font-bold text-emerald-400 mt-2">Cost: ${car.moneyCost} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                `;

                const button = document.createElement('button');
                button.className = `mt-4 px-6 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out`;

                if (ownedCars.includes(car.id)) {
                    button.textContent = currentCarId === car.id ? 'Equipped' : 'Equip';
                    button.classList.add(...(currentCarId === car.id ? ['bg-cyan-600', 'cursor-default'] : ['bg-cyan-700', 'hover:bg-cyan-600']));
                    button.disabled = currentCarId === car.id;
                    button.addEventListener('click', () => {
                        playButtonClickSound(); // Play sound on click
                        equipCar(car.id);
                    });
                } else {
                    button.textContent = 'Buy Car';
                    button.classList.add(...(moneyCount >= car.moneyCost ? ['bg-cyan-600', 'hover:bg-cyan-700'] : ['bg-stone-600', 'cursor-not-allowed']));
                    button.disabled = moneyCount < car.moneyCost;
                    button.addEventListener('click', () => {
                        playButtonClickSound(); // Play sound on click
                        buyCar(car.id);
                    });
                }
                carCard.appendChild(button);
                carItemsContainer.appendChild(carCard);
            });

            return carShopDiv;
        };

        // New: renderBackpackShopView function
        const renderBackpackShopView = () => {
            const backpackShopDiv = document.createElement('div');
            backpackShopDiv.className = "w-full h-[400px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-hidden";
            backpackShopDiv.style.height = 'auto';
            backpackShopDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-green-400 mb-6">Backpack Shop</h2>
                <p class="text-lg text-stone-300 mb-4">Increase your inventory capacity!</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-2xl" id="backpackItemsContainer">
                    <!-- Backpack items will be dynamically added here -->
                </div>
            `;

            const backpackItemsContainer = backpackShopDiv.querySelector('#backpackItemsContainer');
            backpackItems.forEach(backpack => {
                const backpackCard = document.createElement('div');
                backpackCard.className = `bg-stone-900 p-4 rounded-lg shadow-md flex flex-col items-center border-2
                    ${currentBackpackId === backpack.id ? 'border-green-500 ring-4 ring-green-200' : 'border-stone-600'}
                    ${moneyCount < backpack.moneyCost && !ownedBackpacks.includes(backpack.id) ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg transition-shadow duration-200'}
                `;
                backpackCard.innerHTML = `
                    <img src="${backpack.imageUrl}" alt="${backpack.name}" class="w-20 h-20 mb-3 rounded-full object-contain" />
                    <h3 class="text-xl font-semibold text-stone-100">${backpack.name}</h3>
                    <p class="text-sm text-stone-300">Capacity: ${DEFAULT_INVENTORY_CAPACITY + backpack.capacityIncrease}kg</p>
                    <p class="text-lg font-bold text-emerald-400 mt-2">Cost: ${backpack.moneyCost} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                `;

                const button = document.createElement('button');
                button.className = `mt-4 px-6 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out`;

                if (ownedBackpacks.includes(backpack.id)) {
                    button.textContent = currentBackpackId === backpack.id ? 'Equipped' : 'Equip';
                    button.classList.add(...(currentBackpackId === backpack.id ? ['bg-green-600', 'cursor-default'] : ['bg-green-700', 'hover:bg-green-600']));
                    button.disabled = currentBackpackId === backpack.id;
                    button.addEventListener('click', () => {
                        playButtonClickSound(); // Play sound on click
                        equipBackpack(backpack.id);
                    });
                } else {
                    button.textContent = 'Buy Backpack';
                    button.classList.add(...(moneyCount >= backpack.moneyCost ? ['bg-green-600', 'hover:bg-green-700'] : ['bg-stone-600', 'cursor-not-allowed']));
                    button.disabled = moneyCount < backpack.moneyCost;
                    button.addEventListener('click', () => {
                        playButtonClickSound(); // Play sound on click
                        buyBackpack(backpack.id);
                    });
                }
                backpackCard.appendChild(button);
                backpackItemsContainer.appendChild(backpackCard);
            });

            return backpackShopDiv;
        };

        // New: renderShopsView function to display Axe Shop and Car Shop buttons
        const renderShopsView = () => {
            const shopsDiv = document.createElement('div');
            shopsDiv.className = "w-full h-[400px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-hidden";
            shopsDiv.style.height = 'auto';
            shopsDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-rose-400 mb-6">Shops</h2>
                <p class="text-lg text-stone-300 mb-4">Choose a shop to visit:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                    <button id="goToAxeShopBtn" class="px-8 py-4 rounded-xl font-bold text-white shadow-xl transition-all duration-300 ease-in-out transform hover:scale-105
                        bg-gradient-to-r from-rose-600 to-rose-800 hover:from-rose-700 hover:to-rose-900 ring-2 ring-rose-500 hover:ring-rose-400
                        flex items-center justify-center">
                        <img src="${axeShopIconUrl}" alt="Axe Shop Icon" class="nav-icon mr-2" />Axe Shop
                    </button>
                    <button id="goToCarShopBtn" class="px-8 py-4 rounded-xl font-bold text-white shadow-xl transition-all duration-300 ease-in-out transform hover:scale-105
                        bg-gradient-to-r from-cyan-600 to-cyan-800 hover:from-cyan-700 hover:to-cyan-900 ring-2 ring-cyan-500 hover:ring-cyan-400
                        flex items-center justify-center">
                        <img src="${carShopIconUrl}" alt="Car Shop Icon" class="nav-icon mr-2" />Car Shop
                    </button>
                    <button id="goToBackpackShopBtn" class="px-8 py-4 rounded-xl font-bold text-white shadow-xl transition-all duration-300 ease-in-out transform hover:scale-105
                        bg-gradient-to-r from-green-600 to-green-800 hover:from-green-700 hover:to-green-900 ring-2 ring-green-500 hover:ring-green-400
                        flex items-center justify-center">
                        <img src="${inventoryIconUrl}" alt="Backpack Shop Icon" class="nav-icon mr-2" />Backpack Shop
                    </button>
                </div>
            `;

            shopsDiv.querySelector('#goToAxeShopBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                currentView = 'axeShop';
                renderApp();
                saveGame();
            });

            shopsDiv.querySelector('#goToCarShopBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                currentView = 'carShop';
                renderApp();
                saveGame();
            });

            shopsDiv.querySelector('#goToBackpackShopBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                currentView = 'backpackShop';
                renderApp();
                saveGame();
            });

            return shopsDiv;
        };

        // New: renderBuySellShopView function
        const renderBuySellShopView = () => {
            const buySellShopDiv = document.createElement('div');
            buySellShopDiv.className = "w-full h-[600px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-auto";
            buySellShopDiv.style.height = 'auto';
            buySellShopDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-lime-400 mb-6">Buy & Sell Shop</h2>
                <p class="text-lg text-stone-300 mb-4">Sell your junk items for money!</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-4xl">
                    <!-- Rusty Can Sell Section -->
                    <div class="bg-stone-900 p-6 rounded-lg shadow-md flex flex-col items-center gap-4">
                        <h3 class="text-2xl font-bold text-stone-100">Sell Rusty Cans</h3>
                        <img src="${rustyCanIconUrl}" alt="Rusty Can Icon" class="w-16 h-16 object-contain" />
                        <div class="flex items-center space-x-2">
                            <label for="sellRustyCanAmount" class="text-lg font-medium text-stone-100">Sell:</label>
                            <input
                                type="number"
                                id="sellRustyCanAmount"
                                min="0"
                                value="${sellRustyCanAmount}"
                                class="w-24 p-2 border border-stone-600 rounded-md text-center text-lg font-semibold bg-stone-700 text-stone-100"
                                ${isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}
                            />
                            <span class="text-lg font-medium text-stone-100">Rusty Cans</span>
                        </div>
                        <p class="text-md text-stone-300">You will get: <span class="font-bold text-emerald-400" id="sellRustyCanMoneyPreview">${sellRustyCanAmount * RUSTY_CAN_TO_MONEY_RATE}</span> <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                        <button id="sellRustyCanButton" class="px-8 py-3 rounded-full font-semibold text-white shadow-lg transition-all duration-200 ease-in-out
                            ${rustyCanCount > 0 && sellRustyCanAmount > 0 && !isSelling && !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk ? 'bg-lime-600 hover:bg-lime-700' : 'bg-stone-600 cursor-not-allowed'}"
                            ${rustyCanCount <= 0 || sellRustyCanAmount <= 0 || isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}>
                            Sell
                        </button>
                    </div>

                    <!-- Garbage Sell Section -->
                    <div class="bg-stone-900 p-6 rounded-lg shadow-md flex flex-col items-center gap-4">
                        <h3 class="text-2xl font-bold text-stone-100">Sell Garbage</h3>
                        <img src="${garbageIconUrl}" alt="Garbage Icon" class="w-16 h-16 object-contain" />
                        <div class="flex items-center space-x-2">
                            <label for="sellGarbageAmount" class="text-lg font-medium text-stone-100">Sell:</label>
                            <input
                                type="number"
                                id="sellGarbageAmount"
                                min="0"
                                value="${sellGarbageAmount}"
                                class="w-24 p-2 border border-stone-600 rounded-md text-center text-lg font-semibold bg-stone-700 text-stone-100"
                                ${isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}
                            />
                            <span class="text-lg font-medium text-stone-100">Garbage</span>
                        </div>
                        <p class="text-md text-stone-300">You will get: <span class="font-bold text-emerald-400" id="sellGarbageMoneyPreview">${sellGarbageAmount * GARBAGE_TO_MONEY_RATE}</span> <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                        <button id="sellGarbageButton" class="px-8 py-3 rounded-full font-semibold text-white shadow-lg transition-all duration-200 ease-in-out
                            ${garbageCount > 0 && sellGarbageAmount > 0 && !isSelling || !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk ? 'bg-lime-600 hover:bg-lime-700' : 'bg-stone-600 cursor-not-allowed'}"
                            ${garbageCount <= 0 || sellGarbageAmount <= 0 || isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}>
                            Sell
                        </button>
                    </div>

                    <!-- Screws Sell Section -->
                    <div class="bg-stone-900 p-6 rounded-lg shadow-md flex flex-col items-center gap-4">
                        <h3 class="text-2xl font-bold text-stone-100">Sell Screws</h3>
                        <img src="${screwsIconUrl}" alt="Screws Icon" class="w-16 h-16 object-contain" />
                        <div class="flex items-center space-x-2">
                            <label for="sellScrewsAmount" class="text-lg font-medium text-stone-100">Sell:</label>
                            <input
                                type="number"
                                id="sellScrewsAmount"
                                min="0"
                                value="${sellScrewsAmount}"
                                class="w-24 p-2 border border-stone-600 rounded-md text-center text-lg font-semibold bg-stone-700 text-stone-100"
                                ${isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}
                            />
                            <span class="text-lg font-medium text-stone-100">Screws</span>
                        </div>
                        <p class="text-md text-stone-300">You will get: <span class="font-bold text-emerald-400" id="sellScrewsMoneyPreview">${sellScrewsAmount * SCREWS_TO_MONEY_RATE}</span> <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                        <button id="sellScrewsButton" class="px-8 py-3 rounded-full font-semibold text-white shadow-lg transition-all duration-200 ease-in-out
                            ${screwsCount > 0 && sellScrewsAmount > 0 && !isSelling || !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk ? 'bg-lime-600 hover:bg-lime-700' : 'bg-stone-600 cursor-not-allowed'}"
                            ${screwsCount <= 0 || sellScrewsAmount <= 0 || isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk ? 'disabled' : ''}>
                            Sell
                        </button>
                    </div>
                </div>

                <!-- Selling Junk Progress Bar -->
                <div id="sellingJunkProgressBarContainer" class="progress-bar-container w-full max-w-xs mt-6 ${isSellingJunk ? '' : 'hidden'}">
                    <div id="sellingJunkProgressBar" class="progress-bar bg-lime-500" style="width: ${sellingJunkProgress}%"></div>
                </div>
                <p id="sellingJunkStatus" class="text-sm text-lime-400 ${isSellingJunk ? '' : 'hidden'}">Processing ${currentSellJunkAmount} ${currentSellJunkType}...</p>
            `;

            // Event listeners for Rusty Can sell input and button
            buySellShopDiv.querySelector('#sellRustyCanAmount').addEventListener('input', (e) => {
                let inputValue = parseInt(e.target.value);
                sellRustyCanAmount = (isNaN(inputValue) || inputValue < 0) ? 0 : inputValue;
                buySellShopDiv.querySelector('#sellRustyCanMoneyPreview').textContent = sellRustyCanAmount * RUSTY_CAN_TO_MONEY_RATE;
                const sellButton = buySellShopDiv.querySelector('#sellRustyCanButton');
                const canSell = rustyCanCount >= sellRustyCanAmount && sellRustyCanAmount > 0 && !isSelling && !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk;
                sellButton.disabled = !canSell;
                if (canSell) {
                    sellButton.classList.remove('bg-stone-600', 'cursor-not-allowed');
                    sellButton.classList.add('bg-lime-600', 'hover:bg-lime-700');
                } else {
                    sellButton.classList.remove('bg-lime-600', 'hover:bg-lime-700');
                    sellButton.classList.add('bg-stone-600', 'cursor-not-allowed');
                }
            });
            buySellShopDiv.querySelector('#sellRustyCanButton').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                sellJunk('rustyCan', sellRustyCanAmount);
            });

            // Event listeners for Garbage sell input and button
            buySellShopDiv.querySelector('#sellGarbageAmount').addEventListener('input', (e) => {
                let inputValue = parseInt(e.target.value);
                sellGarbageAmount = (isNaN(inputValue) || inputValue < 0) ? 0 : inputValue;
                buySellShopDiv.querySelector('#sellGarbageMoneyPreview').textContent = sellGarbageAmount * GARBAGE_TO_MONEY_RATE;
                const sellButton = buySellShopDiv.querySelector('#sellGarbageButton');
                const canSell = garbageCount >= sellGarbageAmount && sellGarbageAmount > 0 && !isSelling && !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk;
                sellButton.disabled = !canSell;
                if (canSell) {
                    sellButton.classList.remove('bg-stone-600', 'cursor-not-allowed');
                    sellButton.classList.add('bg-lime-600', 'hover:bg-lime-700');
                } else {
                    sellButton.classList.remove('bg-lime-600', 'hover:bg-lime-700');
                    sellButton.classList.add('bg-stone-600', 'cursor-not-allowed');
                }
            });
            buySellShopDiv.querySelector('#sellGarbageButton').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                sellJunk('garbage', sellGarbageAmount);
            });

            // Event listeners for Screws sell input and button
            buySellShopDiv.querySelector('#sellScrewsAmount').addEventListener('input', (e) => {
                let inputValue = parseInt(e.target.value);
                sellScrewsAmount = (isNaN(inputValue) || inputValue < 0) ? 0 : inputValue;
                buySellShopDiv.querySelector('#sellScrewsMoneyPreview').textContent = sellScrewsAmount * SCREWS_TO_MONEY_RATE;
                const sellButton = buySellShopDiv.querySelector('#sellScrewsButton');
                const canSell = screwsCount >= sellScrewsAmount && sellScrewsAmount > 0 && !isSelling || !isSellingGrape && !isDelivering && !isQuesting && !isSellingJunk;
                sellButton.disabled = !canSell;
                if (canSell) {
                    sellButton.classList.remove('bg-stone-600', 'cursor-not-allowed');
                    sellButton.classList.add('bg-lime-600', 'hover:bg-lime-700');
                } else {
                    sellButton.classList.remove('bg-lime-600', 'hover:bg-lime-700');
                    sellButton.classList.add('bg-stone-600', 'cursor-not-allowed');
                }
            });
            buySellShopDiv.querySelector('#sellScrewsButton').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                sellJunk('screws', sellScrewsAmount);
            });

            return buySellShopDiv;
        };


        // New: renderDeliveriesView function
        const renderDeliveriesView = () => {
            const deliveriesDiv = document.createElement('div');
            deliveriesDiv.className = "w-full h-[900px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-hidden";
            deliveriesDiv.style.height = 'auto';
            deliveriesDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-teal-400 mb-6">Lumber Deliveries</h2>
                <p class="text-lg text-stone-300 mb-4">Choose a route and deliver your lumber for a reward!</p>
                
                ${currentCarId ? `
                    <div class="bg-stone-900 p-4 rounded-lg shadow-md flex items-center mb-6">
                        <span class="text-lg font-semibold text-stone-100 mr-2">Using:</span>
                        <img src="${carItems.find(c => c.id === currentCarId)?.imageUrl}" alt="${carItems.find(c => c.id === currentCarId)?.name}" class="w-10 h-10 rounded-full object-contain mr-2" />
                        <span class="text-xl font-bold text-cyan-400">${carItems.find(c => c.id === currentCarId)?.name}</span>
                        <span class="text-sm text-stone-300 ml-2">(Delivers ${carItems.find(c => c.id === currentCarId)?.deliverySpeedMultiplier}x faster)</span>
                    </div>
                ` : `
                    <p class="text-red-400 text-lg mb-6">You need to purchase and equip a car from the Car Shop to start deliveries!</p>
                `}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl" id="deliveryRoutesContainer">
                    <!-- Delivery routes will be dynamically added here -->
                </div>

                <!-- Delivery Progress Bar -->
                <div id="deliveryProgressBarContainer" class="progress-bar-container w-full max-w-xs mt-6 ${isDelivering ? '' : 'hidden'}">
                    <div id="deliveryProgressBar" class="progress-bar bg-teal-500" style="width: ${deliveryProgress}%"></div>
                </div>
                <p id="deliveryStatus" class="text-sm text-teal-400 ${isDelivering ? '' : 'hidden'}">Delivering ${currentDeliveryAmount} wood to ${deliveryRoutes.find(r => r.id === currentDeliveryRouteId)?.name}...</p>
            `;

            const deliveryRoutesContainer = deliveriesDiv.querySelector('#deliveryRoutesContainer');
            deliveryRoutes.forEach(route => {
                const routeCard = document.createElement('div');
                let lumberIcon = '';
                let currentLumberCount = 0;
                let isLumberAvailable = false;
                let deliveryButtonText = 'Start Delivery';
                let deliveryButtonDisabled = false;
                let deliveryButtonClasses = 'bg-teal-600 hover:bg-teal-700';

                // Determine which lumber type is required and set icon/count
                if (route.lumberType === 'wood') {
                    lumberIcon = woodIconUrl;
                    currentLumberCount = woodCount;
                    isLumberAvailable = woodCount >= route.lumberRequired;
                } else if (route.lumberType === 'grapeLumber') {
                    lumberIcon = grapeLumberIconUrl;
                    currentLumberCount = grapeLumberCount;
                    isLumberAvailable = grapeLumberCount >= route.lumberRequired;
                } else if (route.lumberType === 'soulLumber') { // New: Soul Lumber
                    lumberIcon = soulLumberIconUrl;
                    currentLumberCount = soulLumberCount;
                    isLumberAvailable = soulLumberCount >= route.lumberRequired;
                }

                const equippedCar = carItems.find(c => c.id === currentCarId);
                const canDeliverSoulLumber = equippedCar && equippedCar.deliversSoulLumber;

                // Check general conditions for delivery
                if (!currentCarId || !isLumberAvailable || isDelivering || isQuesting || isSellingJunk) { // Added isQuesting and isSellingJunk
                    deliveryButtonDisabled = true;
                    deliveryButtonClasses = 'bg-stone-600 cursor-not-allowed';
                }

                // Specific condition for Soul Lumber and cars that can deliver it
                if (route.lumberType === 'soulLumber' && !canDeliverSoulLumber) {
                    deliveryButtonDisabled = true;
                    deliveryButtonClasses = 'bg-stone-600 cursor-not-allowed';
                    deliveryButtonText = 'Requires Soul Lumber Capable Vehicle'; // More generic message
                }


                routeCard.className = `bg-stone-900 p-4 rounded-lg shadow-md flex flex-col items-center border-2 border-stone-600
                    ${deliveryButtonDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg transition-shadow duration-200'}
                `;
                routeCard.innerHTML = `
                    <img src="${route.imageUrl}" alt="${route.name}" class="w-20 h-20 mb-3 rounded-full object-contain" />
                    <h3 class="text-xl font-semibold text-stone-100">${route.name}</h3>
                    <p class="text-sm text-stone-300">Requires: ${route.lumberRequired} <img src="${lumberIcon}" alt="${route.lumberType} Icon" class="currency-icon inline-block" /></p>
                    <p class="text-sm text-stone-300">Reward: ${route.moneyReward} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                    <button class="mt-4 px-6 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${deliveryButtonClasses}"
                        ${deliveryButtonDisabled ? 'disabled' : ''}>
                        ${deliveryButtonText}
                    </button>
                `;
                const startDeliveryButton = routeCard.querySelector('button');
                startDeliveryButton.addEventListener('click', () => {
                    playButtonClickSound(); // Play sound on click
                    startDelivery(route.id);
                });
                deliveryRoutesContainer.appendChild(routeCard);
            });

            return deliveriesDiv;
        };

        // New: renderQuestsView function
        const renderQuestsView = () => {
            const questsDiv = document.createElement('div');
            questsDiv.className = "w-full h-[900px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-hidden";
            questsDiv.style.height = 'auto';
            questsDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-orange-400 mb-6">Building Quests</h2>
                <p class="text-lg text-stone-300 mb-4">Help build houses and get paid handsomely!</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl" id="questItemsContainer">
                    <!-- Quest items will be dynamically added here -->
                </div>

                <!-- Quest Progress Bar -->
                <div id="questProgressBarContainer" class="progress-bar-container w-full max-w-xs mt-6 ${isQuesting ? '' : 'hidden'}">
                    <div id="questProgressBar" class="progress-bar progress-bar-orange" style="width: ${questProgress}%"></div>
                </div>
                <p id="questStatus" class="text-sm text-orange-400 ${isQuesting ? '' : 'hidden'}">Building ${questItems.find(q => q.id === currentQuestId)?.name}...</p>
            `;

            const questItemsContainer = questsDiv.querySelector('#questItemsContainer');
            questItems.forEach(quest => {
                const questCard = document.createElement('div');
                let lumberIcon = '';
                let currentLumberCount = 0;
                let isLumberAvailable = false;
                let questButtonText = 'Start Quest';
                let questButtonDisabled = false;
                let questButtonClasses = 'bg-orange-600 hover:bg-orange-700';

                // Determine which lumber type is required and set icon/count
                if (quest.lumberType === 'wood') {
                    lumberIcon = woodIconUrl;
                    currentLumberCount = woodCount;
                    isLumberAvailable = woodCount >= quest.lumberRequired;
                } else if (quest.lumberType === 'grapeLumber') {
                    lumberIcon = grapeLumberIconUrl;
                    currentLumberCount = grapeLumberCount;
                    isLumberAvailable = grapeLumberCount >= quest.lumberRequired;
                } else if (quest.lumberType === 'soulLumber') {
                    lumberIcon = soulLumberIconUrl;
                    currentLumberCount = soulLumberCount;
                    isLumberAvailable = soulLumberCount >= quest.lumberRequired;
                }

                // Check general conditions for questing
                if (!isLumberAvailable || isDelivering || isQuesting || isSellingJunk) { // Added isDelivering and isSellingJunk
                    questButtonDisabled = true;
                    questButtonClasses = 'bg-stone-600 cursor-not-allowed';
                }

                questCard.className = `bg-stone-900 p-4 rounded-lg shadow-md flex flex-col items-center border-2 border-stone-600
                    ${questButtonDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg transition-shadow duration-200'}
                `;
                questCard.innerHTML = `
                    <img src="${quest.imageUrl}" alt="${quest.name}" class="w-20 h-20 mb-3 rounded-full object-contain" />
                    <h3 class="text-xl font-semibold text-stone-100">${quest.name}</h3>
                    <p class="text-sm text-stone-300 text-center">${quest.description}</p>
                    <p class="text-sm text-stone-300">Requires: ${quest.lumberRequired} <img src="${lumberIcon}" alt="${quest.lumberType} Icon" class="currency-icon inline-block" /></p>
                    <p class="text-sm text-stone-300">Reward: ${quest.moneyReward} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                    <button class="mt-4 px-6 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${questButtonClasses}"
                        ${questButtonDisabled ? 'disabled' : ''}>
                        ${questButtonText}
                    </button>
                `;
                const startQuestButton = questCard.querySelector('button');
                startQuestButton.addEventListener('click', () => {
                    playButtonClickSound(); // Play sound on click
                    startQuest(quest.id);
                });
                questItemsContainer.appendChild(questCard);
            });

            return questsDiv;
        };


        const renderHomeView = () => {
            const homeContainer = document.createElement('div');
            // Adjust class based on full view mode - removed full view logic
            // Changed to flex-col to stack items vertically on all screen sizes
            homeContainer.className = `w-full flex flex-col gap-6`;

            // Home Controls Section (Furniture Shop, Change Home, Buy Houses)
            const homeControlsDiv = document.createElement('div');
            // Hide controls if in full view - removed full view logic
            // Changed to w-full to occupy full width
            homeControlsDiv.className = `w-full bg-stone-800 p-6 rounded-lg shadow-md`;
            homeControlsDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-indigo-400 mb-4">Your Home</h2>
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="furnitureShopBtn" class="px-4 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${isFurnitureShopOpen ? 'bg-indigo-700 hover:bg-indigo-800' : 'bg-stone-700 hover:bg-stone-600'}">
                        Shop
                    </button>
                    <button id="changeHomeBtn" class="px-4 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${homeSubView === 'changeHome' ? 'bg-emerald-700 hover:bg-emerald-800' : 'bg-stone-700 hover:bg-stone-600'}">
                        Change Home
                    </button>
                    <button id="buyHousesBtn" class="px-4 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${homeSubView === 'buyHouses' ? 'bg-amber-700 hover:bg-amber-800' : 'bg-stone-700 hover:bg-stone-600'}">
                        Buy Houses
                    </button>
                    <button id="rearrangeFurnitureBtn" class="px-4 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${isRearrangingFurniture ? 'bg-orange-700 hover:bg-orange-800' : 'bg-stone-700 hover:bg-stone-600'}">
                        ${isRearrangingFurniture ? 'Cancel Re-Arrange' : 'Re-Arrange'}
                    </button>
                    <button id="deleteFurnitureBtn" class="px-4 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${isDeletingFurniture ? 'bg-red-700 hover:bg-red-800' : 'bg-stone-700 hover:bg-stone-600'}">
                        ${isDeletingFurniture ? 'Cancel Delete' : 'Delete'}
                    </button>
                </div>
                <div id="homeSubViewContent">
                    <!-- Content for sub-views will be rendered here -->
                </div>
                <p id="deleteHint" class="mt-4 text-center text-sm text-red-400 ${isDeletingFurniture ? '' : 'hidden'}">
                    Click on a furniture item in your house to delete it.
                </p>
            `;
            homeContainer.appendChild(homeControlsDiv);

            const homeSubViewContent = homeControlsDiv.querySelector('#homeSubViewContent');

            // Event Listeners for sub-view buttons
            homeControlsDiv.querySelector('#furnitureShopBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                isFurnitureShopOpen = !isFurnitureShopOpen; // Toggle visibility
                homeSubView = isFurnitureShopOpen ? 'furnitureShop' : 'none'; // Set sub-view based on toggle
                isRearrangingFurniture = false; // Exit rearrange mode when toggling shop
                isDeletingFurniture = false; // Exit delete mode when toggling shop
                selectedFurnitureToMoveId = null;
                selectedFurnitureType = null;
                renderApp();
                saveGame();
            });
            homeControlsDiv.querySelector('#changeHomeBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                homeSubView = 'changeHome';
                isFurnitureShopOpen = false; // Close shop when changing to other sub-views
                isRearrangingFurniture = false; // Exit rearrange mode when switching sub-views
                isDeletingFurniture = false; // Exit delete mode when switching sub-views
                selectedFurnitureToMoveId = null;
                selectedFurnitureType = null;
                renderApp();
            });
            homeControlsDiv.querySelector('#buyHousesBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                homeSubView = 'buyHouses';
                isFurnitureShopOpen = false; // Close shop when changing to other sub-views
                isRearrangingFurniture = false; // Exit rearrange mode when switching sub-views
                isDeletingFurniture = false; // Exit delete mode when switching sub-views
                selectedFurnitureToMoveId = null;
                selectedFurnitureType = null;
                renderApp();
            });

            // Event listeners for Rearrange and Delete buttons (now in renderHomeView)
            homeControlsDiv.querySelector('#rearrangeFurnitureBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                isRearrangingFurniture = !isRearrangingFurniture;
                isDeletingFurniture = false; // Exit delete mode
                selectedFurnitureType = null;
                selectedFurnitureToMoveId = null;
                isFurnitureShopOpen = false; // Close shop when rearranging
                renderApp();
                saveGame();
            });

            homeControlsDiv.querySelector('#deleteFurnitureBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                isDeletingFurniture = !isDeletingFurniture;
                isRearrangingFurniture = false; // Exit rearrange mode
                selectedFurnitureType = null;
                selectedFurnitureToMoveId = null;
                isFurnitureShopOpen = false; // Close shop when deleting
                renderApp();
                saveGame();
            });

            // Render content based on homeSubView
            if (homeSubView === 'furnitureShop') {
                homeSubViewContent.appendChild(renderFurnitureShopContent());
            } else if (homeSubView === 'changeHome') {
                homeSubViewContent.appendChild(renderChangeHomeContent());
            } else if (homeSubView === 'buyHouses') {
                homeSubViewContent.appendChild(renderBuyHousesContent());
            }


            // Your Home Area Section
            const homeAreaDiv = document.createElement('div');
            homeAreaDiv.id = 'homeArea'; // Used for event listeners
            // Adjust class based on full view mode - removed full view logic
            // Changed to w-full to occupy full width
            homeAreaDiv.className = `w-full bg-black-900 rounded-lg shadow-inner p-4 relative home-grid min-h-[1200px]`;
            // Removed inline style width and height
            // homeAreaDiv.style.width = `${HOME_WIDTH}px`;
            // homeAreaDiv.style.height = `${HOME_HEIGHT}px`;

            // Set background image based on currentHouseId
            const currentHouse = houseItems.find(house => house.id === currentHouseId);
            if (currentHouse) {
                homeAreaDiv.style.backgroundImage = `url('${currentHouse.imageUrl}')`;
                console.log(`Home background set to: ${currentHouse.imageUrl} for house ID: ${currentHouseId}`); // Debugging log
            } else {
                console.warn(`Could not find house details for currentHouseId: ${currentHouseId}. No background image set.`);
            }

            homeAreaDiv.innerHTML += `
                <h2 class="text-2xl font-bold text-amber-700 mb-4 text-center">
                    ${currentHouse ? currentHouse.name : 'Unknown Home'}
                </h2>
                <!-- Removed Full View button -->
            `;

            // Removed event listener for the Full View button


            // Get furniture for the current house
            const currentHouseFurniture = allHousesFurniture[currentHouseId] || [];

            // Add existing furniture for the current house
            currentHouseFurniture.forEach(item => {
                // Find item details from furnitureItems
                const itemDetails = furnitureItems.find(f => f.id === item.type);
                if (itemDetails) {
                    const furnitureElement = document.createElement('div');
                    furnitureElement.className = `furniture-item ${selectedFurnitureToMoveId === item.id ? 'moving-selected' : ''} ${isDeletingFurniture ? 'deleting-active' : ''}`;
                    furnitureElement.dataset.id = item.id; // Store unique ID for easy lookup
                    furnitureElement.style.left = `${item.x}px`;
                    furnitureElement.style.top = `${item.y}px`;
                    furnitureElement.style.width = `${itemDetails.width}px`;
                    furnitureElement.style.height = `${itemDetails.height}px`;
                    furnitureElement.style.zIndex = 10;
                    furnitureElement.style.transform = `rotate(${item.rotation || 0}deg)`;
                    furnitureElement.innerHTML = `<img src="${itemDetails.imageUrl}" alt="${itemDetails.name}" />`;

                    furnitureElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isDeletingFurniture) {
                            deleteFurniture(item.id);
                        } else if (isRearrangingFurniture) {
                            selectFurnitureToMove(item.id);
                        } else {
                            rotateFurniture(item.id);
                        }
                    });

                    // Add right-click (contextmenu) event listener for chests
                    if (item.type === 'chest' || item.type === 'vault' || item.type === 'midas_statue' || item.type === 'demonic_pool' || item.type === 'demonic_chest') { // Added demonic_chest
                        furnitureElement.addEventListener('contextmenu', (e) => {
                            e.preventDefault(); // Prevent default context menu
                            if (!isRearrangingFurniture && !isDeletingFurniture) { // Only open if not in other modes
                                openChestInventory(item.id);
                            }
                        });

                        // New: Add touch-hold event listeners for mobile devices
                        let touchStartTime = 0;
                        furnitureElement.addEventListener('touchstart', (e) => {
                            // Only activate if not in rearrange or delete mode
                            if (!isRearrangingFurniture && !isDeletingFurniture) {
                                e.stopPropagation(); // Prevent other touch events from firing
                                touchStartTime = new Date().getTime();
                                touchStartX = e.touches[0].clientX;
                                touchStartY = e.touches[0].clientY;

                                touchStartTimer = setTimeout(() => {
                                    openChestInventory(item.id);
                                    touchStartTimer = null; // Clear timer after execution
                                }, HOLD_DURATION);
                            }
                        }, { passive: false }); // Use passive: false to allow preventDefault

                        furnitureElement.addEventListener('touchend', (e) => {
                            if (touchStartTimer) {
                                clearTimeout(touchStartTimer);
                                touchStartTimer = null;
                            }
                        });

                        furnitureElement.addEventListener('touchmove', (e) => {
                            if (touchStartTimer) {
                                const currentX = e.touches[0].clientX;
                                const currentY = e.touches[0].clientY;
                                const distance = Math.sqrt(
                                    Math.pow(currentX - touchStartX, 2) +
                                    Math.pow(currentY - touchStartY, 2)
                                );

                                if (distance > TOUCH_MOVE_THRESHOLD) {
                                    clearTimeout(touchStartTimer);
                                    touchStartTimer = null;
                                }
                            }
                        });
                    }

                    homeAreaDiv.appendChild(furnitureElement);
                }
            });

            homeAreaDiv.addEventListener('click', (e) => {
                // Pass the actual width and height of the homeAreaDiv for accurate placement
                const currentHomeWidth = homeAreaDiv.offsetWidth;
                const currentHomeHeight = homeAreaDiv.offsetHeight;
                if (selectedFurnitureType) {
                    handleClickToPlace(e, currentHomeWidth, currentHomeHeight);
                } else if (isRearrangingFurniture && selectedFurnitureToMoveId) {
                    placeMovedFurniture(e, currentHomeWidth, currentHomeHeight);
                }
                // No action needed for clicks on homeAreaDiv if isDeletingFurniture is active,
                // as furniture clicks are handled directly.
            });

            homeContainer.appendChild(homeAreaDiv);
            return homeContainer;
        };

        const renderFurnitureShopContent = () => {
            const contentDiv = document.createElement('div');
            contentDiv.className = "flex flex-col gap-4";
            contentDiv.innerHTML = `
                <h3 class="text-xl font-bold text-stone-100 mb-4">Shop Items</h3>
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="furnitureCategoryBtn" class="px-4 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${currentFurnitureCategory === 'furniture' ? 'bg-indigo-700 hover:bg-indigo-800' : 'bg-stone-700 hover:bg-stone-600'}">
                        Furniture
                    </button>
                    <button id="petsCategoryBtn" class="px-4 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${currentFurnitureCategory === 'pets' ? 'bg-purple-700 hover:bg-purple-800' : 'bg-stone-700 hover:bg-stone-600'}">
                        Pets
                    </button>
                    <button id="generatorsCategoryBtn" class="px-4 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                        ${currentFurnitureCategory === 'generators' ? 'bg-amber-700 hover:bg-amber-800' : 'bg-stone-700 hover:bg-stone-600'}">
                        Generators
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4" id="furnitureItemsContainer">
                    <!-- Furniture or Pet items will be dynamically added here -->
                </div>
            `;
            const furnitureItemsContainer = contentDiv.querySelector('#furnitureItemsContainer');

            // Event listeners for category buttons
            contentDiv.querySelector('#furnitureCategoryBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                currentFurnitureCategory = 'furniture';
                selectedFurnitureType = null; // Clear selected item when changing category
                renderApp();
            });
            contentDiv.querySelector('#petsCategoryBtn').addEventListener('click', () => { // Changed from () => to (e) => to be consistent, though e is not used
                playButtonClickSound(); // Play sound on click
                currentFurnitureCategory = 'pets';
                selectedFurnitureType = null; // Clear selected item when changing category
                renderApp();
            });
            // New: Event listener for Generators category button
            contentDiv.querySelector('#generatorsCategoryBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                currentFurnitureCategory = 'generators';
                selectedFurnitureType = null; // Clear selected item when changing category
                renderApp();
            });

            // Filter items based on the current category
            const itemsToDisplay = furnitureItems.filter(item => item.category === currentFurnitureCategory);

            itemsToDisplay.forEach(item => {
                const shopItem = document.createElement('div');
                let isDisabled = false;
                
                if (moneyCount < item.moneyCost) {
                    isDisabled = true;
                }

                shopItem.className = `shop-item p-3 border rounded-lg flex flex-col items-center
                    ${selectedFurnitureType === item.id ? 'selected bg-indigo-900' : 'bg-stone-900 hover:bg-stone-800'}
                    ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                shopItem.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 mb-2 rounded-md object-contain" />
                    <span class="font-semibold text-sm text-stone-100 text-center">${item.name}</span>
                    <span class="text-xs text-stone-300">Cost: ${item.moneyCost} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></span>
                    ${item.category === 'generators' && item.generatesWoodPerSecond ? `<span class="text-xs text-emerald-400">Generates: ${item.generatesWoodPerSecond} wood/sec</span>` : ''}
                    ${item.category === 'generators' && item.generatesSoulLumberPerSecond ? `<span class="text-xs text-red-400">Generates: ${item.generatesSoulLumberPerSecond} soul lumber/sec</span>` : ''}
                `;
                shopItem.addEventListener('click', () => {
                    if (!isRearrangingFurniture && !isDeletingFurniture && !isDisabled) { // Only allow buying if not in rearrange or delete mode
                        playPurchaseSound(); // Play purchase sound
                        buyFurniture(item.id);
                    }
                });
                furnitureItemsContainer.appendChild(shopItem);
            });
            return contentDiv;
        };

        const renderChangeHomeContent = () => {
            const contentDiv = document.createElement('div');
            contentDiv.className = "flex flex-col gap-4";
            contentDiv.innerHTML = `
                <h3 class="text-xl font-bold text-stone-100 mb-2">Your Owned Houses</h3>
                <div id="ownedHousesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Owned houses will be dynamically added here -->
                </div>
            `;
            const ownedHousesContainer = contentDiv.querySelector('#ownedHousesContainer');

            if (ownedHouses.length === 0) {
                ownedHousesContainer.innerHTML = `<p class="text-stone-400">You don't own any houses yet. Buy one from the "Buy Houses" section!</p>`;
            } else {
                ownedHouses.forEach(houseId => {
                    const house = houseItems.find(h => h.id === houseId);
                    if (house) {
                        const houseCard = document.createElement('div');
                        houseCard.className = `bg-stone-900 p-4 rounded-lg shadow-md flex flex-col items-center border-2
                            ${currentHouseId === house.id ? 'border-cyan-500 ring-4 ring-cyan-200' : 'border-stone-600'}`;
                        houseCard.innerHTML = `
                            <img src="${house.imageUrl}" alt="${house.name}" class="w-24 h-18 mb-3 rounded-md object-contain" />
                            <h4 class="text-lg font-semibold text-stone-100">${house.name}</h4>
                            <button class="mt-3 px-6 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                                ${currentHouseId === house.id ? 'bg-cyan-600 cursor-default' : 'bg-indigo-600 hover:bg-indigo-700'}"
                                ${currentHouseId === house.id ? 'disabled' : ''}>
                                ${currentHouseId === house.id ? 'Current Home' : 'Equip'}
                            </button>
                        `;
                        const equipButton = houseCard.querySelector('button');
                        equipButton.addEventListener('click', () => {
                            playButtonClickSound(); // Play sound on click
                            equipHome(house.id);
                        });
                        ownedHousesContainer.appendChild(houseCard);
                    }
                });
            }
            return contentDiv;
        };

        const renderBuyHousesContent = () => {
            const contentDiv = document.createElement('div');
            contentDiv.className = "flex flex-col gap-4";
            contentDiv.innerHTML = `
                <h3 class="text-xl font-bold text-stone-100 mb-2">Houses for Sale</h3>
                <div id="housesForSaleContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Houses for sale will be dynamically added here -->
                </div>
            `;
            const housesForSaleContainer = contentDiv.querySelector('#housesForSaleContainer');

            // Filter out houses that are already owned
            const purchasableHouses = houseItems.filter(house => !ownedHouses.includes(house.id));

            if (purchasableHouses.length === 0) {
                housesForSaleContainer.innerHTML = `<p class="text-stone-400">You own all available houses!</p>`;
            } else {
                purchasableHouses.forEach(house => {
                    const houseCard = document.createElement('div');
                    houseCard.className = `bg-stone-900 p-4 rounded-lg shadow-md flex flex-col items-center border-2 border-stone-600`;
                    houseCard.innerHTML = `
                        <img src="${house.imageUrl}" alt="${house.name}" class="w-24 h-18 mb-3 rounded-md object-contain" />
                        <h4 class="text-lg font-semibold text-stone-100">${house.name}</h4>
                        <p class="text-md font-bold text-emerald-400 mt-2">Cost: ${house.moneyCost} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                        <button class="mt-3 px-6 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out
                            ${moneyCount >= house.moneyCost ? 'bg-amber-600 hover:bg-amber-700' : 'bg-stone-600 cursor-not-allowed'}"
                            ${moneyCount < house.moneyCost ? 'disabled' : ''}>
                            Buy
                        </button>
                    `;
                    const buyButton = houseCard.querySelector('button');
                    buyButton.addEventListener('click', () => {
                        playButtonClickSound(); // Play sound on click
                        buyHome(house.id);
                    });
                    housesForSaleContainer.appendChild(houseCard);
                });
            }
            return contentDiv;
        };

        const renderBiomesView = () => {
            const biomesDiv = document.createElement('div');
            biomesDiv.className = "w-full h-[900px] bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-hidden";
            biomesDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-purple-400 mb-6">Explore Biomes!</h2>
                <p class="text-lg text-stone-300 mb-4">Select a biome to teleport to:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl" id="biomesContainer">
                    <!-- Biome items will be dynamically added here -->
                </div>
            `;

            const biomesContainer = biomesDiv.querySelector('#biomesContainer');
            // Iterate through biomesData to create buttons for each biome
            for (const biomeId in biomesData) {
                // Skip the current biome if you don't want to show it as an option to "teleport" to itself
                if (biomeId === currentView) continue; 
                
                const biome = biomesData[biomeId];
                const biomeCard = document.createElement('div');
                biomeCard.className = `bg-stone-900 p-4 rounded-lg shadow-md flex flex-col items-center border-2 border-stone-600`;
                biomeCard.innerHTML = `
                    <img src="${biome.iconUrl}" alt="${biome.name} Icon" class="w-16 h-16 mb-3 rounded-full object-contain" />
                    <h3 class="text-xl font-semibold text-stone-100">${biome.name}</h3>
                    <button class="mt-4 px-6 py-2 rounded-full font-semibold text-white shadow-md transition-all duration-200 ease-in-out bg-blue-600 hover:bg-blue-700">
                        Teleport
                    </button>
                `;
                const teleportButton = biomeCard.querySelector('button');

                // New: Unlock condition for Vampire Forest
                if (biomeId === 'vampireForest' && !vampireForestUnlocked) {
                    biomeCard.classList.add('opacity-50', 'cursor-not-allowed');
                    teleportButton.disabled = true;
                    teleportButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    teleportButton.classList.add('bg-stone-600', 'cursor-not-allowed');
                    teleportButton.textContent = 'Locked (Requires Demonic Pool)';
                } else {
                    teleportButton.addEventListener('click', () => {
                        playButtonClickSound(); // Play sound on click
                        currentView = biomeId; // Change the current view to the selected biome
                        lastLocation = biomeId; // Update lastLocation on teleport
                        renderApp(); // Re-render the app to show the new biome
                        saveGame(); // Save game state after teleporting
                    });
                }
                biomesContainer.appendChild(biomeCard);
            }
            return biomesDiv;
        };

        // New: renderInventoryView function
        const renderInventoryView = () => {
            console.log("Rendering Inventory View. Idle Wood Rate:", totalIdleWoodPerSecond, "Idle Soul Lumber Rate:", totalIdleSoulLumberPerSecond);

            const inventoryDiv = document.createElement('div');
            inventoryDiv.className = "w-full bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-auto";
            inventoryDiv.style.height = 'auto'; // Allow content to dictate height

            // Find the currently equipped axe, car, and backpack
            const currentAxe = axeItems.find(axe => axe.id === currentAxeId);
            const currentCar = carItems.find(car => car.id === currentCarId);
            const currentBackpack = backpackItems.find(bp => bp.id === currentBackpackId);


            inventoryDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-stone-200 mb-6">Your Inventory</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-4xl">
                    <div class="text-3xl font-semibold p-6 bg-yellow-950 rounded-lg shadow-md flex items-center justify-center">
                        <img src="${woodIconUrl}" alt="Wood Icon" class="currency-icon w-10 h-10" /> Lumber: <span class="text-yellow-400 ml-2" id="woodCount">${woodCount}</span>
                    </div>
                    <div class="text-3xl font-semibold p-6 bg-emerald-950 rounded-lg shadow-md flex items-center justify-center">
                        <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon w-10 h-10" /> Cash: <span class="text-emerald-400 ml-2" id="moneyCount">${moneyCount}</span>
                    </div>
                    <div class="text-3xl font-semibold p-6 bg-purple-950 rounded-lg shadow-md flex items-center justify-center ${grapeLumberCount > 0 || lumberMillUpgraded ? 'flex' : 'hidden'}">
                        <img src="${grapeLumberIconUrl}" alt="Grape Lumber Icon" class="currency-icon w-10 h-10" /> Grape Lumber: <span class="text-purple-400 ml-2" id="grapeLumberCount">${grapeLumberCount}</span>
                    </div>
                    <div class="text-3xl font-semibold p-6 bg-red-950 rounded-lg shadow-md flex items-center justify-center ${soulLumberCount > 0 ? 'flex' : 'hidden'}">
                        <img src="${soulLumberIconUrl}" alt="Soul Lumber Icon" class="currency-icon w-10 h-10" /> Soul Lumber: <span class="text-red-400 ml-2" id="soulLumberCount">${soulLumberCount}</span>
                    </div>
                    <div class="text-3xl font-semibold p-6 bg-gray-950 rounded-lg shadow-md flex items-center justify-center ${rustyCanCount > 0 ? 'flex' : 'hidden'}">
                        <img src="${rustyCanIconUrl}" alt="Rusty Can Icon" class="currency-icon w-10 h-10" /> Rusty Cans: <span class="text-gray-400 ml-2" id="rustyCanCount">${rustyCanCount}</span>
                    </div>
                    <div class="text-3xl font-semibold p-6 bg-gray-950 rounded-lg shadow-md flex items-center justify-center ${garbageCount > 0 ? 'flex' : 'hidden'}">
                        <img src="${garbageIconUrl}" alt="Garbage Icon" class="currency-icon w-10 h-10" /> Garbage: <span class="text-gray-400 ml-2" id="garbageCount">${garbageCount}</span>
                    </div>
                    <div class="text-3xl font-semibold p-6 bg-gray-950 rounded-lg shadow-md flex items-center justify-center ${screwsCount > 0 ? 'flex' : 'hidden'}">
                        <img src="${screwsIconUrl}" alt="Screws Icon" class="currency-icon w-10 h-10" /> Screws: <span class="text-gray-400 ml-2" id="screwsCount">${screwsCount}</span>
                    </div>
                    <div class="text-3xl font-semibold p-6 bg-stone-900 rounded-lg shadow-md flex items-center justify-center ${totalIdleWoodPerSecond > 0 || totalIdleSoulLumberPerSecond > 0 ? 'flex' : 'hidden'}">
                        <img src="${woodIconUrl}" alt="Wood Icon" class="currency-icon w-10 h-10" /> Idle Wood Rate: <span class="text-yellow-400 ml-2" id="idleWoodRate">${totalIdleWoodPerSecond}/sec</span>
                    </div>
                    <div class="text-3xl font-semibold p-6 bg-stone-900 rounded-lg shadow-md flex items-center justify-center ${totalIdleSoulLumberPerSecond > 0 ? 'flex' : 'hidden'}">
                        <img src="${soulLumberIconUrl}" alt="Soul Lumber Icon" class="currency-icon w-10 h-10" /> Idle Soul Lumber Rate: <span class="text-red-400 ml-2" id="idleSoulLumberRate">${totalIdleSoulLumberPerSecond}/sec</span>
                    </div>

                    <!-- Inventory Capacity Display -->
                    <div class="text-2xl font-semibold p-8 bg-stone-900 rounded-lg shadow-md flex flex-col items-center justify-center">
                        <span class="mb-2">Inventory Space:</span>
                        <span class="text-3xl font-bold text-purple-400 text-center">
                            <span id="currentInventoryWeight">${currentInventoryWeight.toFixed(2)}</span> / <span id="inventoryCapacity">${inventoryCapacity}</span> kg
                        </span>
                        <span class="text-sm text-stone-300 mt-1 text-center">(${LUMBER_ITEM_WEIGHT}kg per wood/grape lumber, ${SOUL_LUMBER_ITEM_WEIGHT}kg per soul lumber)</span>
                    </div>

                    <!-- Current Axe Display -->
                    <div id="currentAxeDisplay" class="text-2xl font-semibold p-8 bg-stone-900 rounded-lg shadow-md flex flex-col items-center justify-center ${currentAxe ? '' : 'hidden'}">
                        <span class="mb-2">Current Axe:</span>
                        ${currentAxe ? `
                            <img src="${currentAxe.imageUrl}" alt="${currentAxe.name}" class="w-16 h-16 rounded-full object-contain mb-2" />
                            <span class="text-3xl font-bold text-cyan-400 text-center">${currentAxe.name}</span>
                            <span class="text-lg text-stone-300 mt-1 text-center">(Cuts ${currentAxe.cutSpeedMultiplier}x faster)</span>
                        ` : ''}
                    </div>

                    <!-- Current Vehicle Display -->
                    <div id="currentCarDisplay" class="text-2xl font-semibold p-8 bg-stone-900 rounded-lg shadow-md flex flex-col items-center justify-center ${currentCar ? '' : 'hidden'}">
                        <span class="mb-2">Current Vehicle:</span>
                        ${currentCar ? `
                            <img src="${currentCar.imageUrl}" alt="${currentCar.name}" class="w-16 h-16 rounded-full object-contain mb-2" />
                            <span class="text-3xl font-bold text-cyan-400 text-center">${currentCar.name}</span>
                            <span class="text-lg text-stone-300 mt-1 text-center">(Money ${currentCar.moneyBonusMultiplier}x, Delivers ${currentCar.deliverySpeedMultiplier}x faster)</span>
                        ` : ''}
                    </div>

                    <!-- Current Backpack Display -->
                    <div id="currentBackpackDisplay" class="text-2xl font-semibold p-8 bg-stone-900 rounded-lg shadow-md flex flex-col items-center justify-center ${currentBackpack ? '' : 'hidden'}">
                        <span class="mb-2">Current Backpack:</span>
                        ${currentBackpack ? `
                            <img src="${currentBackpack.imageUrl}" alt="${currentBackpack.name}" class="w-16 h-16 rounded-full object-contain mb-2" />
                            <span class="text-3xl font-bold text-green-400 text-center">${currentBackpack.name}</span>
                            <span class="text-lg text-stone-300 mt-1 text-center">(Capacity: ${DEFAULT_INVENTORY_CAPACITY + currentBackpack.capacityIncrease}kg)</span>
                        ` : ''}
                    </div>
                </div>
            `;
            // Removed the call to updateCurrencyDisplay here, as its contents are now directly in the HTML
            updateCurrencyDisplay(); 

            return inventoryDiv;
        };

        // New: renderDebugView function
        const renderDebugView = () => {
            const debugDiv = document.createElement('div');
            debugDiv.className = "w-full bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-auto";
            debugDiv.style.height = 'auto';
            debugDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-pink-400 mb-6">Debug Console (Beta)</h2>
                <div class="w-full max-w-md flex flex-col gap-4">
                    <div class="flex items-center gap-2 w-full">
                        <input type="text" id="debugCommandInput" placeholder="Enter debug command (e.g., debugresetprog)"
                               class="flex-grow p-3 rounded-md bg-stone-900 text-stone-100 border border-stone-600 focus:outline-none focus:ring-2 focus:ring-pink-500" />
                        <button id="runDebugCommandBtn" class="px-6 py-3 rounded-md bg-pink-600 hover:bg-pink-700 text-white font-semibold transition-colors duration-200">
                            Run Command
                        </button>
                    </div>
                    <div id="debugConsoleOutput" class="w-full bg-stone-900 p-4 rounded-md h-96 overflow-y-auto text-sm text-stone-300 font-mono">
                        <!-- Debug logs will appear here -->
                    </div>
                </div>
            `;

            const debugCommandInput = debugDiv.querySelector('#debugCommandInput');
            const runDebugCommandBtn = debugDiv.querySelector('#runDebugCommandBtn');
            const debugConsoleOutput = debugDiv.querySelector('#debugConsoleOutput');

            // Populate initial console logs
            debugConsoleOutput.innerHTML = debugConsoleLogs.map(log => `<div>${log}</div>`).join('');
            debugConsoleOutput.scrollTop = debugConsoleOutput.scrollHeight; // Scroll to bottom

            runDebugCommandBtn.addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                const command = debugCommandInput.value.trim();
                if (command) {
                    runDebugCommand(command);
                    debugCommandInput.value = ''; // Clear input after running
                }
            });

            // Allow pressing Enter to run command
            debugCommandInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    runDebugCommandBtn.click();
                }
            });

            return debugDiv;
        };

        // New: renderSettingsView function
        const renderSettingsView = () => {
            const settingsDiv = document.createElement('div');
            settingsDiv.className = "w-full bg-stone-800 rounded-lg shadow-inner p-8 flex flex-col items-center relative overflow-auto";
            settingsDiv.style.height = 'auto';
            settingsDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-blue-400 mb-6">Settings</h2>
                <div class="w-full max-w-md flex flex-col gap-4">
                    <div class="bg-stone-900 p-4 rounded-lg shadow-md text-center">
                        <p class="text-lg font-semibold text-stone-100">Game Version: ${GAME_VERSION}</p>
                    </div>
                    <button id="goToDebugBtn" class="px-8 py-4 rounded-full font-semibold text-white shadow-lg transition-all duration-200 ease-in-out bg-pink-600 hover:bg-pink-700 flex items-center justify-center">
                        <img src="${debugIconUrl}" alt="Debug Icon" class="nav-icon mr-2" />Debug Console
                    </button>
                </div>
            `;

            settingsDiv.querySelector('#goToDebugBtn').addEventListener('click', () => {
                playButtonClickSound(); // Play sound on click
                currentView = 'debug';
                renderApp();
                saveGame();
            });

            return settingsDiv;
        };


        // Function to add a log to the debug console and update the display
        const addDebugLog = (message) => {
            const timestamp = new Date().toLocaleTimeString();
            debugConsoleLogs.push(`[${timestamp}] ${message}`);
            if (debugConsoleLogs.length > MAX_DEBUG_LOGS) {
                debugConsoleLogs.shift(); // Remove oldest log
            }
            // If currently on the debug view, update the display
            if (currentView === 'debug') {
                const debugConsoleOutput = document.getElementById('debugConsoleOutput');
                if (debugConsoleOutput) {
                    debugConsoleOutput.innerHTML = debugConsoleLogs.map(log => `<div>${log}</div>`).join('');
                    debugConsoleOutput.scrollTop = debugConsoleOutput.scrollHeight; // Scroll to bottom
                }
            }
        };

        // Function to handle debug commands
        const runDebugCommand = (command) => {
            addDebugLog(`Command received: "${command}"`);
            // Handle 'debug give' commands
            if (command.startsWith('debug give ')) {
                const parts = command.substring('debug give '.length).trim().split(' ');
                if (parts.length === 2) {
                    const itemType = parts[0].toLowerCase();
                    const amount = parseInt(parts[1]);

                    if (isNaN(amount) || amount < 1 || amount > 120) {
                        addDebugLog(`Invalid amount for debug give: "${parts[1]}". Must be a number between 1 and 120.`);
                        showMessage("Invalid amount. Must be a number between 1 and 120.", 'error');
                        return;
                    }

                    switch (itemType) {
                        case 'soul-lumber':
                            soulLumberCount += amount;
                            addDebugLog(`Gave ${amount} soul lumber.`);
                            showMessage(`Gave ${amount} soul lumber!`, 'success');
                            break;
                        case 'grape-lumber':
                            grapeLumberCount += amount;
                            addDebugLog(`Gave ${amount} grape lumber.`);
                            showMessage(`Gave ${amount} grape lumber!`, 'success');
                            break;
                        case 'normal-lumber':
                            woodCount += amount;
                            addDebugLog(`Gave ${amount} normal lumber.`);
                            showMessage(`Gave ${amount} normal lumber!`, 'success');
                            break;
                        case 'rusty-can':
                            rustyCanCount += amount;
                            addDebugLog(`Gave ${amount} rusty cans.`);
                            showMessage(`Gave ${amount} rusty cans!`, 'success');
                            break;
                        case 'garbage':
                            garbageCount += amount;
                            addDebugLog(`Gave ${amount} garbage.`);
                            showMessage(`Gave ${amount} garbage!`, 'success');
                            break;
                        case 'screws':
                            screwsCount += amount;
                            addDebugLog(`Gave ${amount} screws.`);
                            showMessage(`Gave ${amount} screws!`, 'success');
                            break;
                        case 'money':
                            moneyCount += amount;
                            addDebugLog(`Gave ${amount} money.`);
                            showMessage(`Gave ${amount} money!`, 'success');
                            break;
                        default:
                            addDebugLog(`Unknown item type for debug give: "${itemType}"`);
                            showMessage("Unknown item type. Use 'soul-lumber', 'grape-lumber', 'normal-lumber', 'rusty-can', 'garbage', 'screws', or 'money'.", 'error');
                            return; // Exit function if item type is unknown
                    }
                    updateCurrencyDisplay();
                    saveGame();
                } else {
                    addDebugLog(`Invalid 'debug give' command format. Expected: 'debug give <type> <amount>'`);
                    showMessage("Invalid 'debug give' command format. Expected: 'debug give <type> <amount>'.", 'error');
                }
                return; // Exit function after handling 'debug give'
            }
            
            // Handle other debug commands
            if (command.startsWith('debugremove ')) {
                const amountStr = command.substring('debugremove '.length).trim();
                const amount = parseInt(amountStr);

                if (isNaN(amount) || amount <= 0 || amount > 5000) {
                    addDebugLog(`Invalid amount for debugremove: "${amountStr}". Must be a number between 1 and 5000.`);
                    showMessage("Invalid amount for debugremove. Must be a number between 1 and 5000.", 'error');
                    return;
                }

                if (moneyCount >= amount) {
                    moneyCount -= amount;
                    addDebugLog(`Removed ${amount} money.`);
                    showMessage(`Removed ${amount} money!`, 'success');
                } else {
                    addDebugLog(`Cannot remove ${amount} money: Not enough money. Current: ${moneyCount}.`);
                    showMessage(`Cannot remove ${amount} money: Not enough money.`, 'error');
                }
                updateCurrencyDisplay();
                saveGame();
            } else {
                switch (command) {
                    case 'debugresetprog':
                        resetGameProgress();
                        addDebugLog("Game progress reset. Reloading...");
                        showMessage("Game progress reset! Reloading...", 'success');
                        setTimeout(() => {
                            window.location.reload(); // Reload the page to apply reset
                        }, 1500);
                        break;
                    case 'debugcheatmakemerich': // New debug command
                        moneyCount += 10000;
                        addDebugLog("Gave 10000 money (debugcheatmakemerich).");
                        showMessage("You're rich! +10000 money!", 'success');
                        updateCurrencyDisplay();
                        saveGame();
                        break;
                    case 'debugcheatunlockbiomes': // New debug command to unlock all biomes
                        biomesUnlocked = true;
                        vampireForestUnlocked = true;
                        addDebugLog("All biomes unlocked (debugcheatunlockbiomes).");
                        showMessage("All biomes unlocked!", 'success');
                        renderApp(); // Re-render to show biomes button
                        saveGame();
                        break;
                    case 'debugunlockquests': // New debug command to unlock quests
                        questsUnlocked = true;
                        addDebugLog("Quests unlocked (debugunlockquests).");
                        showMessage("Quests unlocked!", 'success');
                        renderApp();
                        saveGame();
                        break;
                    case 'debugchangelog': // New debug command to display changelog
                        addDebugLog("--- Fetching Changelog ---");
                        fetch('assets/changelog.txt') // Path to the changelog file
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.text();
                            })
                            .then(text => {
                                addDebugLog("--- Changelog Content ---");
                                text.split('n').forEach(line => {
                                    addDebugLog(line);
                                });
                                addDebugLog("--- End Changelog ---");
                            })
                            .catch(error => {
                                addDebugLog(`Failed to load changelog.txt: ${error.message}`);
                                showMessage("Failed to load changelog.txt. See debug console for details.", 'error');
                            });
                        break;
                    case 'debugdownload': // New debug command to open a new tab with a link
                        addDebugLog("Opening download link: https://github.com/StadiaStudios/lumbertycoon");
                        window.open('https://github.com/StadiaStudios/lumbertycoon', '_blank');
                        showMessage("Opening Windows download in a new tab!", 'info');
                        break;
                    default:
                        addDebugLog(`Unknown command: "${command}"`);
                        showMessage("Unknown debug command.", 'error');
                        break;
                }
            }
        };

        // Function to reset all game progress
        const resetGameProgress = () => {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            localStorage.removeItem(LOCAL_STORAGE_FIRST_LOAD_KEY); // Reset first load flag too
            // Removed localStorage.removeItem(LOCAL_STORAGE_THEME_KEY);
            // Reset all global game state variables to their initial values
            woodCount = 0;
            moneyCount = 0;
            grapeLumberCount = 0;
            soulLumberCount = 0;
            rustyCanCount = 0; // Reset rusty can count
            garbageCount = 0; // Reset garbage count
            screwsCount = 0; // Reset screws count
            currentInventoryWeight = 0; // Reset inventory weight
            inventoryCapacity = DEFAULT_INVENTORY_CAPACITY; // Reset inventory capacity
            currentView = 'forest';
            lastLocation = 'forest';
            selectedFurnitureType = null;
            sellWoodAmount = 1;
            sellGrapeWoodAmount = 1;
            sellRustyCanAmount = 1; // Reset sell amount for rusty cans
            sellGarbageAmount = 1; // Reset sell amount for garbage
            sellScrewsAmount = 1; // Reset sell amount for screws
            isCutting = false;
            cuttingProgress = 0;
            cuttingIntervalRef = null;
            currentCuttingTreeId = null;
            currentAxeId = 'basic_axe';
            ownedAxes = ['basic_axe'];
            isRearrangingFurniture = false;
            selectedFurnitureToMoveId = null;
            isDeletingFurniture = false;
            isSelling = false;
            sellingProgress = 0;
            sellingIntervalRef = null;
            currentSellAmount = 0;
            isSellingGrape = false;
            sellingGrapeProgress = 0;
            sellingGrapeIntervalRef = null;
            currentSellGrapeAmount = 0;
            isSellingJunk = false;
            sellingJunkProgress = 0;
            sellingJunkIntervalRef = null;
            currentSellJunkAmount = 0;
            currentSellJunkType = '';
            currentHouseId = 'basic_home';
            ownedHouses = ['basic_home'];
            allHousesFurniture = { 'basic_home': [] };
            homeSubView = 'none';
            currentFurnitureCategory = 'furniture';
            isFurnitureShopOpen = false;
            biomesUnlocked = false;
            lumberMillUpgraded = false;
            vampireForestUnlocked = false;
            ownedCars = [];
            currentCarId = null;
            deliveriesUnlocked = false;
            questsUnlocked = true; // Set to true for reset
            ownedBackpacks = ['basic_backpack']; // Reset owned backpacks
            currentBackpackId = 'basic_backpack'; // Reset current backpack
            isQuesting = false; // Reset questing state
            questProgress = 0;
            questIntervalRef = null;
            currentQuestId = null;
            currentQuestLumberRequired = 0;
            totalIdleWoodPerSecond = 0;
            totalIdleSoulLumberPerSecond = 0;
            if (idleWoodGenerationInterval) {
                clearInterval(idleWoodGenerationInterval);
                idleWoodGenerationInterval = null;
            }
            // New: Music related resets
            isBackgroundMusicPlaying = false;
            musicVolume = 0.5;
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
            }
            debugConsoleLogs = []; // Clear debug logs as well
        };


        // --- Core Game Logic Functions ---
        const chopTree = (treeId, event) => {
            if (isCutting) {
                addDebugLog("Already cutting a tree!");
                return;
            }

            // Prevent cutting if any other long process is active
            if (isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk) {
                showMessage("Cannot chop trees while another process is active!", 'error');
                addDebugLog("Chop failed: Another process is active.");
                return;
            }

            // Get the trees array for the current biome
            const currentBiomeTrees = biomesData[currentView]?.trees;
            if (!currentBiomeTrees) {
                addDebugLog(`No tree data found for current biome: ${currentView}`);
                return;
            }

            const treeToCut = currentBiomeTrees.find(tree => tree.id === treeId);
            if (!treeToCut) return;

            // Determine the weight of the item being chopped
            let itemWeight = LUMBER_ITEM_WEIGHT;
            if (currentView === 'vampireForest') {
                itemWeight = SOUL_LUMBER_ITEM_WEIGHT;
            }

            // Check if inventory is full before chopping
            if (currentInventoryWeight + itemWeight > inventoryCapacity) {
                showMessage("Inventory full! Sell some lumber or buy a bigger backpack.", 'error');
                addDebugLog("Chop failed: Inventory full.");
                return;
            }

            const currentAxe = axeItems.find(axe => axe.id === currentAxeId);
            const effectiveCutTime = treeToCut.cutTime / currentAxe.cutSpeedMultiplier;

            isCutting = true;
            currentCuttingTreeId = treeId;
            cuttingProgress = 0;
            renderApp(); // Re-render to show progress bar and disable other trees

            // Get a fresh reference to the tree element after renderApp()
            const treeElement = document.getElementById(`tree-${treeId}`);
            if (treeElement) {
                treeElement.classList.add('animate-shake');
            }

            const intervalTime = 50;
            const totalSteps = effectiveCutTime / intervalTime;
            const progressPerStep = 100 / totalSteps;

            cuttingIntervalRef = setInterval(() => {
                cuttingProgress += progressPerStep;
                // Get a fresh reference to the current tree's progress bar in each interval
                // The tree element itself is the wrapper div, not just the image.
                const currentTreeWrapperInInterval = document.getElementById(`tree-${currentCuttingTreeId}`).parentNode; // Get the parent wrapper
                if (currentTreeWrapperInInterval) {
                    const progressBar = currentTreeWrapperInInterval.querySelector('.progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `${cuttingProgress}%`;
                    }
                }

                if (cuttingProgress >= 100) {
                    cuttingProgress = 100;
                    clearInterval(cuttingIntervalRef);
                    cuttingIntervalRef = null;

                    // New: Check current biome to determine which currency to increment
                    if (currentView === 'purpleForest') {
                        grapeLumberCount++; // Increment grape lumber for purple trees
                        addDebugLog("Chopped grape lumber.");
                    } else if (currentView === 'vampireForest') { // New: Increment Soul Lumber for Vampire Forest trees
                        soulLumberCount++;
                        addDebugLog("Chopped soul lumber.");
                    }
                    else {
                        woodCount++; // Increment regular wood for green trees
                        addDebugLog("Chopped wood.");
                    }
                    
                    isCutting = false;
                    cuttingProgress = 0;
                    currentCuttingTreeId = null;
                    
                    // Ensure the tree element is correctly referenced for removing shake class
                    // And hide the progress bar container
                    if (currentTreeWrapperInInterval) { // Use the wrapper reference
                        const treeImage = currentTreeWrapperInInterval.querySelector('.tree-image');
                        if (treeImage) {
                            treeImage.classList.remove('animate-shake');
                        }
                        const progressBarContainer = currentTreeWrapperInInterval.querySelector('.progress-bar-container');
                        if (progressBarContainer) {
                            progressBarContainer.classList.add('hidden');
                        }
                    }
                    updateCurrencyDisplay(); // Update inventory weight and capacity display
                    renderApp(); // Full re-render to update wood count and ensure all states are consistent
                    saveGame(); // Save game state after chopping a tree
                }
            }, intervalTime);
        };

        const buyFurniture = (furnitureId) => {
            const item = furnitureItems.find(f => f.id === furnitureId);
            if (item && moneyCount >= item.moneyCost) {
                moneyCount -= item.moneyCost;
                selectedFurnitureType = furnitureId;
                isRearrangingFurniture = false; // Exit rearrange mode if buying new furniture
                isDeletingFurniture = false; // Exit delete mode if buying new furniture
                selectedFurnitureToMoveId = null; // Clear any picked up furniture
                isFurnitureShopOpen = false; // Close shop after buying an item
                playPurchaseSound(); // Play purchase sound
                renderApp(); // Re-render to update money and show placement hint
                saveGame(); // Save game state after buying furniture
                checkVampireForestUnlock(); // Check for unlock after buying furniture
                addDebugLog(`Bought ${item.name} for ${item.moneyCost} money.`);
            } else if (item) {
                showMessage("Not enough money to buy " + item.name, 'error');
                addDebugLog(`Failed to buy ${item.name}: Not enough money.`);
            }
        };

        const buyAxe = (axeId) => {
            const axeToBuy = axeItems.find(axe => axe.id === axeId);
            if (!axeToBuy) return;

            if (ownedAxes.includes(axeId)) {
                showMessage("You already own this axe!", 'info');
                currentAxeId = axeId; // Equip if already owned
                renderApp(); // Re-render to update equipped axe
                saveGame(); // Save game state after equipping axe
                addDebugLog(`Already owned and equipped ${axeToBuy.name}.`);
                return;
            }

            if (moneyCount >= axeToBuy.moneyCost) {
                moneyCount -= axeToBuy.moneyCost;
                ownedAxes.push(axeId);
                currentAxeId = axeId; // Equip new axe automatically
                playPurchaseSound(); // Play purchase sound
                showMessage(`Bought and equipped ${axeToBuy.name}!`, 'success');
                addDebugLog(`Bought and equipped ${axeToBuy.name} for ${axeToBuy.moneyCost} money.`);
                renderApp(); // Re-render to update money, owned axes, and equipped axe
                saveGame(); // Save game state after buying axe
            } else {
                showMessage("Not enough money to buy " + axeToBuy.name, 'error');
                addDebugLog(`Failed to buy ${axeToBuy.name}: Not enough money.`);
            }
        };

        const equipAxe = (axeId) => {
            if (ownedAxes.includes(axeId)) {
                currentAxeId = axeId;
                showMessage(`Equipped ${axeItems.find(axe => axe.id === axeId)?.name}`, 'success');
                addDebugLog(`Equipped ${axeItems.find(axe => axe.id === axeId)?.name}.`);
                renderApp(); // Re-render to update equipped axe
                saveGame(); // Save game state after equipping axe
            } else {
                showMessage("You don't own this axe.", 'error');
                addDebugLog(`Failed to equip axe ${axeId}: Not owned.`);
            }
        };

        // New: buyCar function
        const buyCar = (carId) => {
            const carToBuy = carItems.find(car => car.id === carId);
            if (!carToBuy) return;

            if (ownedCars.includes(carId)) {
                showMessage("You already own this car!", 'info');
                currentCarId = carId; // Equip if already owned
                renderApp(); // Re-render to update equipped car
                saveGame(); // Save game state after equipping car
                addDebugLog(`Already owned and equipped ${carToBuy.name}.`);
                return;
            }

            if (moneyCount >= carToBuy.moneyCost) {
                moneyCount -= carToBuy.moneyCost;
                ownedCars.push(carId);
                currentCarId = carId; // Equip new car automatically
                playPurchaseSound(); // Play purchase sound
                showMessage(`Bought and equipped ${carToBuy.name}!`, 'success');
                addDebugLog(`Bought and equipped ${carToBuy.name} for ${carToBuy.moneyCost} money.`);

                // Unlock deliveries if this is the first car purchased
                if (ownedCars.length === 1) {
                    deliveriesUnlocked = true;
                    showMessage("Deliveries unlocked!", 'success');
                    addDebugLog("Deliveries unlocked.");
                }
                renderApp(); // Re-render to update money, owned cars, equipped car, and potentially navigation
                saveGame(); // Save game state after buying car
            } else {
                showMessage("Not enough money to buy " + carToBuy.name, 'error');
                addDebugLog(`Failed to buy ${carToBuy.name}: Not enough money.`);
            }
        };

        // New: equipCar function
        const equipCar = (carId) => {
            if (ownedCars.includes(carId)) {
                currentCarId = carId;
                showMessage(`Equipped ${carItems.find(car => car.id === carId)?.name}`, 'success');
                addDebugLog(`Equipped ${carItems.find(car => car.id === carId)?.name}.`);
                renderApp(); // Re-render to update equipped car
                saveGame(); // Save game state after equipping car
            } else {
                showMessage("You don't own this car.", 'error');
                addDebugLog(`Failed to equip car ${carId}: Not owned.`);
            }
        };

        // New: buyBackpack function
        const buyBackpack = (backpackId) => {
            const backpackToBuy = backpackItems.find(bp => bp.id === backpackId);
            if (!backpackToBuy) return;

            if (ownedBackpacks.includes(backpackId)) {
                showMessage("You already own this backpack!", 'info');
                currentBackpackId = backpackId; // Equip if already owned
                updateInventoryCapacity(); // Update capacity immediately
                renderApp(); // Re-render to update equipped backpack
                saveGame(); // Save game state after equipping backpack
                addDebugLog(`Already owned and equipped ${backpackToBuy.name}.`);
                return;
            }

            if (moneyCount >= backpackToBuy.moneyCost) {
                moneyCount -= backpackToBuy.moneyCost;
                ownedBackpacks.push(backpackId);
                currentBackpackId = backpackId; // Equip new backpack automatically
                updateInventoryCapacity(); // Update capacity immediately
                playPurchaseSound(); // Play purchase sound
                showMessage(`Bought and equipped ${backpackToBuy.name}! Capacity increased to ${inventoryCapacity}kg!`, 'success');
                addDebugLog(`Bought and equipped ${backpackToBuy.name} for ${backpackToBuy.moneyCost} money.`);
                renderApp(); // Re-render to update money, owned backpacks, and equipped backpack
                saveGame(); // Save game state after buying backpack
            } else {
                showMessage("Not enough money to buy " + backpackToBuy.name, 'error');
                addDebugLog(`Failed to buy ${backpackToBuy.name}: Not enough money.`);
            }
        };

        // New: equipBackpack function
        const equipBackpack = (backpackId) => {
            if (ownedBackpacks.includes(backpackId)) {
                currentBackpackId = backpackId;
                updateInventoryCapacity(); // Update capacity immediately
                showMessage(`Equipped ${backpackItems.find(bp => bp.id === backpackId)?.name}! Capacity now ${inventoryCapacity}kg.`, 'success');
                addDebugLog(`Equipped ${backpackItems.find(bp => bp.id === backpackId)?.name}.`);
                renderApp(); // Re-render to update equipped backpack
                saveGame(); // Save game state after equipping backpack
            } else {
                showMessage("You don't own this backpack.", 'error');
                addDebugLog(`Failed to equip backpack ${backpackId}: Not owned.`);
            }
        };

        // New: startDelivery function
        const startDelivery = (routeId) => {
            if (!currentCarId) {
                showMessage("No car equipped for delivery! Please buy one from the Car Shop.", 'error');
                addDebugLog("Delivery failed: No car equipped.");
                return;
            }
            if (isDelivering) {
                showMessage("Already on a delivery!", 'info');
                addDebugLog("Delivery failed: Already on a delivery.");
                return;
            }
            // Prevent delivery if questing or selling junk is active
            if (isQuesting || isSellingJunk) {
                showMessage("Cannot start delivery while another process is active!", 'error');
                addDebugLog("Delivery failed: Quest or junk selling is active.");
                return;
            }

            const route = deliveryRoutes.find(r => r.id === routeId);
            if (!route) return;

            const equippedCar = carItems.find(c => c.id === currentCarId);

            // Check if Soul Lumber requires a capable vehicle
            if (route.lumberType === 'soulLumber' && (!equippedCar || !equippedCar.deliversSoulLumber)) {
                showMessage("You need a vehicle capable of delivering Soul Lumber for this route!", 'error');
                addDebugLog("Delivery failed: Requires Soul Lumber capable vehicle.");
                return;
            }

            let isLumberAvailable = false;
            // Check required lumber type and amount
            if (route.lumberType === 'wood' && woodCount >= route.lumberRequired) {
                isLumberAvailable = true;
            } else if (route.lumberType === 'grapeLumber' && grapeLumberCount >= route.lumberRequired) {
                isLumberAvailable = true;
            } else if (route.lumberType === 'soulLumber' && soulLumberCount >= route.lumberRequired) { // New: Check Soul Lumber
                isLumberAvailable = true;
            }

            if (!isLumberAvailable) {
                showMessage(`Not enough ${route.lumberType} for this delivery! Requires ${route.lumberRequired} ${route.lumberType}.`, 'error');
                addDebugLog(`Delivery failed: Not enough ${route.lumberType}.`);
                return;
            }

            // Delivery time is now affected by the car's deliverySpeedMultiplier
            const effectiveDeliveryTime = route.baseTime / equippedCar.deliverySpeedMultiplier; 

            isDelivering = true;
            currentDeliveryRouteId = routeId;
            currentDeliveryAmount = route.lumberRequired; // Store the amount of lumber being delivered
            deliveryProgress = 0;
            renderApp(); // Re-render to show progress bar and disable buttons
            addDebugLog(`Starting delivery of ${currentDeliveryAmount} ${route.lumberType} to ${route.name}.`);

            // Removed delivery sound start: if (deliverySound && deliverySound.loaded) { deliverySound.start(); }


            const intervalTime = 50;
            const totalSteps = effectiveDeliveryTime / intervalTime;
            const progressPerStep = 100 / totalSteps;

            deliveryIntervalRef = setInterval(() => {
                deliveryProgress += progressPerStep;
                const progressBar = document.getElementById('deliveryProgressBar');
                if (progressBar) {
                    progressBar.style.width = `${deliveryProgress}%`;
                }

                if (deliveryProgress >= 100) {
                    deliveryProgress = 100;
                    clearInterval(deliveryIntervalRef);
                    deliveryIntervalRef = null;

                    // Decrement the correct lumber type
                    if (route.lumberType === 'wood') {
                        woodCount -= route.lumberRequired;
                    } else if (route.lumberType === 'grapeLumber') {
                        grapeLumberCount -= route.lumberRequired;
                    } else if (route.lumberType === 'soulLumber') { // New: Decrement Soul Lumber
                        soulLumberCount -= route.lumberRequired;
                    }
                    
                    // Money reward now includes the car's money bonus multiplier
                    moneyCount += (route.moneyReward * equippedCar.moneyBonusMultiplier);

                    isDelivering = false;
                    deliveryProgress = 0;
                    currentDeliveryRouteId = null;
                    currentDeliveryAmount = 0;

                    // Removed delivery sound stop: if (deliverySound && deliverySound.state === 'started') { sellingSound.stop(); }

                    showMessage(`Delivered ${route.lumberRequired} ${route.lumberType} for ${route.moneyReward * equippedCar.moneyBonusMultiplier} money!`, 'success');
                    addDebugLog(`Completed delivery for ${route.name}. Earned ${route.moneyReward * equippedCar.moneyBonusMultiplier} money.`);
                    updateCurrencyDisplay(); // Update inventory weight and capacity display
                    renderApp(); // Full re-render to update counts and hide progress bar
                    saveGame(); // Save game state after delivery
                }
            }, intervalTime);
        };

        // New: startQuest function
        const startQuest = (questId) => {
            if (isQuesting) {
                showMessage("Already on a quest!", 'info');
                addDebugLog("Quest failed: Already on a quest.");
                return;
            }
            // Prevent questing if any other long process is active
            if (isCutting || isSelling || isSellingGrape || isDelivering || isSellingJunk) {
                showMessage("Cannot start a quest while another process is active!", 'error');
                addDebugLog("Quest failed: Another process is active.");
                return;
            }

            const quest = questItems.find(q => q.id === questId);
            if (!quest) return;

            let isLumberAvailable = false;
            // Check required lumber type and amount
            if (quest.lumberType === 'wood' && woodCount >= quest.lumberRequired) {
                isLumberAvailable = true;
            } else if (quest.lumberType === 'grapeLumber' && grapeLumberCount >= quest.lumberRequired) {
                isLumberAvailable = true;
            } else if (quest.lumberType === 'soulLumber' && soulLumberCount >= quest.lumberRequired) {
                isLumberAvailable = true;
            }

            if (!isLumberAvailable) {
                showMessage(`Not enough ${quest.lumberType} for this quest! Requires ${quest.lumberRequired} ${quest.lumberType}.`, 'error');
                addDebugLog(`Quest failed: Not enough ${quest.lumberType}.`);
                return;
            }

            isQuesting = true;
            currentQuestId = questId;
            currentQuestLumberRequired = quest.lumberRequired; // Store the amount of lumber being used
            questProgress = 0;
            renderApp(); // Re-render to show progress bar and disable buttons
            addDebugLog(`Starting quest: ${quest.name}. Consuming ${quest.lumberRequired} ${quest.lumberType}.`);

            const intervalTime = 50;
            const totalSteps = quest.baseTime / intervalTime;
            const progressPerStep = 100 / totalSteps;

            questIntervalRef = setInterval(() => {
                questProgress += progressPerStep;
                const progressBar = document.getElementById('questProgressBar');
                if (progressBar) {
                    progressBar.style.width = `${questProgress}%`;
                }

                if (questProgress >= 100) {
                    questProgress = 100;
                    clearInterval(questIntervalRef);
                    questIntervalRef = null;

                    // Consume the correct lumber type
                    if (quest.lumberType === 'wood') {
                        woodCount -= quest.lumberRequired;
                    } else if (quest.lumberType === 'grapeLumber') {
                        grapeLumberCount -= quest.lumberRequired;
                    } else if (quest.lumberType === 'soulLumber') {
                        soulLumberCount -= quest.lumberRequired;
                    }
                    
                    moneyCount += quest.moneyReward;

                    // New: Award randomized junk items
                    const junkItems = ["Rusty Can", "Garbage", "Screws"];
                    const awardedItems = [];

                    // Randomly select two unique items
                    while (awardedItems.length < 2) {
                        const randomIndex = Math.floor(Math.random() * junkItems.length);
                        const selectedItem = junkItems[randomIndex];
                        if (!awardedItems.includes(selectedItem)) {
                            awardedItems.push(selectedItem);
                        }
                    }

                    let rewardMessage = `Quest "${quest.name}" completed! Earned ${quest.moneyReward} money.`;
                    awardedItems.forEach(item => {
                        const amount = Math.floor(Math.random() * 5) + 1; // Random amount between 1 and 5
                        if (item === "Rusty Can") {
                            rustyCanCount += amount;
                            rewardMessage += ` Received ${amount} Rusty Can(s).`;
                        } else if (item === "Garbage") {
                            garbageCount += amount;
                            rewardMessage += ` Received ${amount} Garbage.`;
                        } else if (item === "Screws") {
                            screwsCount += amount;
                            rewardMessage += ` Received ${amount} Screw(s).`;
                        }
                    });

                    isQuesting = false;
                    questProgress = 0;
                    currentQuestId = null;
                    currentQuestLumberRequired = 0;

                    showMessage(rewardMessage, 'success');
                    addDebugLog(`Completed quest "${quest.name}". Earned ${quest.moneyReward} money and junk items.`);
                    updateCurrencyDisplay(); // Update inventory weight and capacity display
                    renderApp(); // Full re-render to update counts and hide progress bar
                    saveGame(); // Save game state after quest completion
                }
            }, intervalTime);
        };


        const sellWood = () => {
            const amountToSell = parseInt(sellWoodAmount); // Use the state variable
            if (isNaN(amountToSell) || amountToSell <= 0) {
                showMessage("Please enter a valid amount to sell.", 'error');
                addDebugLog("Sell wood failed: Invalid amount.");
                return;
            }
            if (woodCount < amountToSell) {
                showMessage("Not enough wood to sell that amount!", 'error');
                addDebugLog("Sell wood failed: Not enough wood.");
                return;
            }
            if (isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk) { // Disable if any selling/delivery/quest process is active
                showMessage("Already processing a sale, delivery, or quest!", 'info');
                addDebugLog("Sell wood failed: Another process is active.");
                return;
            }

            isSelling = true;
            currentSellAmount = amountToSell;
            sellingProgress = 0;
            renderApp(); // Re-render to show progress bar and disable button
            addDebugLog(`Starting to sell ${amountToSell} wood.`);

            // Removed selling sound start: if (sellingSound && sellingSound.state === 'started') { sellingSound.start(); }


            const totalSellTime = amountToSell * SELL_TIME_PER_WOOD_MS;
            const intervalTime = 50;
            const totalSteps = totalSellTime / intervalTime;
            const progressPerStep = 100 / totalSteps;

            sellingIntervalRef = setInterval(() => {
                sellingProgress += progressPerStep;
                const progressBar = document.getElementById('sellingProgressBar');
                if (progressBar) {
                    progressBar.style.width = `${sellingProgress}%`;
                }

                if (sellingProgress >= 100) {
                    sellingProgress = 100;
                    clearInterval(sellingIntervalRef);
                    sellingIntervalRef = null;

                    woodCount -= currentSellAmount;
                    moneyCount += (currentSellAmount * WOOD_TO_MONEY_RATE);

                    // Check for biomes unlock condition
                    if (moneyCount >= 100 && !biomesUnlocked) {
                        biomesUnlocked = true;
                        showMessage("Biomes unlocked!", 'success');
                        addDebugLog("Biomes unlocked.");
                    }
                    // New: Check for quests unlock condition (e.g., after earning a certain amount of money)
                    // Removed this check as quests are now unlocked by default
                    /*
                    if (moneyCount >= 500 && !questsUnlocked) {
                        questsUnlocked = true;
                        showMessage("Quests unlocked! Check the new 'Quests' tab!", 'success');
                        addDebugLog("Quests unlocked.");
                    }
                    */


                    isSelling = false;
                    sellingProgress = 0;
                    currentSellAmount = 0; // Reset current sell amount

                    // Removed selling sound stop: if (sellingSound && sellingSound.state === 'started') { sellingSound.stop(); }

                    showMessage(`Sold ${amountToSell} wood for ${amountToSell * WOOD_TO_MONEY_RATE} money.`, 'success');
                    addDebugLog(`Sold ${amountToSell} wood.`);
                    updateCurrencyDisplay(); // Update inventory weight and capacity display
                    renderApp(); // Full re-render to update counts and hide progress bar
                    saveGame(); // Save game state after selling wood
                }
            }, intervalTime);
        };

        // New: Function to sell Grape Lumber
        const sellGrapeWood = () => {
            // Check if the lumber mill is upgraded before allowing grape lumber selling
            if (!lumberMillUpgraded) {
                showMessage("Lumber Mill not upgraded. Cannot sell Grape Lumber.", 'error');
                addDebugLog("Sell grape wood failed: Lumber Mill not upgraded.");
                return;
            }

            const amountToSell = parseInt(sellGrapeWoodAmount);
            if (isNaN(amountToSell) || amountToSell <= 0) {
                showMessage("Please enter a valid amount of Grape Lumber to sell.", 'error');
                addDebugLog("Sell grape wood failed: Invalid amount.");
                return;
            }
            if (grapeLumberCount < amountToSell) {
                showMessage("Not enough Grape Lumber to sell that amount!", 'error');
                addDebugLog("Sell grape wood failed: Not enough grape lumber.");
                return;
            }
            if (isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk) { // Disable if any selling/delivery/quest process is active
                showMessage("Already processing a sale, delivery, or quest!", 'info');
                addDebugLog("Sell grape wood failed: Another process is active.");
                return;
            }

            isSellingGrape = true;
            currentSellGrapeAmount = amountToSell;
            sellingGrapeProgress = 0;
            renderApp(); // Re-render to show progress bar and disable button
            addDebugLog(`Starting to sell ${amountToSell} grape lumber.`);

            // Removed selling sound start: if (sellingSound && sellingSound.state === 'started') { sellingSound.start(); }

            const totalSellTime = amountToSell * SELL_TIME_PER_GRAPE_WOOD_MS;
            const intervalTime = 50;
            const totalSteps = totalSellTime / intervalTime;
            const progressPerStep = 100 / totalSteps;

            sellingGrapeIntervalRef = setInterval(() => {
                sellingGrapeProgress += progressPerStep;
                const progressBar = document.getElementById('sellingGrapeProgressBar');
                if (progressBar) {
                    progressBar.style.width = `${sellingGrapeProgress}%`;
                }

                if (sellingGrapeProgress >= 100) {
                    sellingGrapeProgress = 100;
                    clearInterval(sellingGrapeIntervalRef);
                    sellingGrapeIntervalRef = null;

                    grapeLumberCount -= currentSellGrapeAmount;
                    moneyCount += (currentSellGrapeAmount * GRAPE_WOOD_TO_MONEY_RATE);

                    isSellingGrape = false;
                    sellingGrapeProgress = 0;
                    currentSellGrapeAmount = 0;

                    // Removed selling sound stop: if (sellingSound && sellingSound.state === 'started') { sellingSound.stop(); }

                    showMessage(`Sold ${amountToSell} Grape Lumber for ${amountToSell * GRAPE_WOOD_TO_MONEY_RATE} money.`, 'success');
                    addDebugLog(`Sold ${amountToSell} grape lumber.`);
                    updateCurrencyDisplay(); // Update inventory weight and capacity display
                    renderApp(); // Full re-render to update counts and hide progress bar
                    saveGame(); // Save game state after selling grape lumber
                }
            }, intervalTime);
        };

        // New: Function to sell junk items (Rusty Can, Garbage, Screws)
        const sellJunk = (itemType, amountToSell) => {
            if (isNaN(amountToSell) || amountToSell <= 0) {
                showMessage("Please enter a valid amount.", 'error');
                addDebugLog(`Sell junk failed: Invalid amount (${amountToSell}).`);
                return;
            }

            let currentItemCount;
            let moneyRate;
            let itemName;

            switch (itemType) {
                case 'rustyCan':
                    currentItemCount = rustyCanCount;
                    moneyRate = RUSTY_CAN_TO_MONEY_RATE;
                    itemName = 'Rusty Can(s)';
                    break;
                case 'garbage':
                    currentItemCount = garbageCount;
                    moneyRate = GARBAGE_TO_MONEY_RATE;
                    itemName = 'Garbage';
                    break;
                case 'screws':
                    currentItemCount = screwsCount;
                    moneyRate = SCREWS_TO_MONEY_RATE;
                    itemName = 'Screw(s)';
                    break;
                default:
                    addDebugLog(`Unknown junk item type: ${itemType}`);
                    showMessage("Unknown junk item type.", 'error');
                    return;
            }

            if (currentItemCount < amountToSell) {
                showMessage(`Not enough ${itemName} to sell that amount!`, 'error');
                addDebugLog(`Sell junk failed: Not enough ${itemName}.`);
                return;
            }
            if (isSelling || isSellingGrape || isDelivering || isQuesting || isSellingJunk) {
                showMessage("Already processing a sale, delivery, or quest!", 'info');
                addDebugLog("Sell junk failed: Another process is active.");
                return;
            }

            isSellingJunk = true;
            currentSellJunkAmount = amountToSell;
            currentSellJunkType = itemName;
            sellingJunkProgress = 0;
            renderApp(); // Re-render to show progress bar and disable buttons
            addDebugLog(`Starting to sell ${amountToSell} ${itemName}.`);

            const totalSellTime = amountToSell * SELL_TIME_PER_JUNK_MS;
            const intervalTime = 50;
            const totalSteps = totalSellTime / intervalTime;
            const progressPerStep = 100 / totalSteps;

            sellingJunkIntervalRef = setInterval(() => {
                sellingJunkProgress += progressPerStep;
                const progressBar = document.getElementById('sellingJunkProgressBar');
                if (progressBar) {
                    progressBar.style.width = `${sellingJunkProgress}%`;
                }

                if (sellingJunkProgress >= 100) {
                    sellingJunkProgress = 100;
                    clearInterval(sellingJunkIntervalRef);
                    sellingJunkIntervalRef = null;

                    if (itemType === 'rustyCan') {
                        rustyCanCount -= currentSellJunkAmount;
                    } else if (itemType === 'garbage') {
                        garbageCount -= currentSellJunkAmount;
                    } else if (itemType === 'screws') {
                        screwsCount -= currentSellJunkAmount;
                    }
                    moneyCount += (currentSellJunkAmount * moneyRate);

                    isSellingJunk = false;
                    sellingJunkProgress = 0;
                    currentSellJunkAmount = 0;
                    currentSellJunkType = '';

                    showMessage(`Sold ${amountToSell} ${itemName} for ${amountToSell * moneyRate} money.`, 'success');
                    addDebugLog(`Sold ${amountToSell} ${itemName}.`);
                    updateCurrencyDisplay(); // Update inventory weight and capacity display
                    renderApp(); // Full re-render to update counts and hide progress bar
                    saveGame(); // Save game state after selling junk
                }
            }, intervalTime);
        };

        // New: Function to upgrade the Lumber Mill
        const upgradeLumberMill = () => {
            if (moneyCount >= LUMBER_MILL_UPGRADE_COST) {
                moneyCount -= LUMBER_MILL_UPGRADE_COST;
                lumberMillUpgraded = true;
                playPurchaseSound(); // Play purchase sound
                showMessage("Lumber Mill upgraded! You can now sell Grape Lumber.", 'success');
                addDebugLog("Lumber Mill upgraded.");
                renderApp(); // Re-render to update money and show grape lumber selling section
                saveGame(); // Save game state after upgrade
            } else {
                showMessage("Not enough money to upgrade the Lumber Mill.", 'error');
                addDebugLog("Lumber Mill upgrade failed: Not enough money.");
            }
        };


        const handleClickToPlace = (e, homeWidth, homeHeight) => {
            if (!selectedFurnitureType) return;

            const homeAreaDiv = document.getElementById('homeArea');
            if (!homeAreaDiv) return;

            const homeRect = homeAreaDiv.getBoundingClientRect();
            // Find item details from furnitureItems
            const itemDetails = furnitureItems.find(f => f.id === selectedFurnitureType);
            if (!itemDetails) return;

            // Calculate x and y to center the furniture on the click point
            let x = e.clientX - homeRect.left - (itemDetails.width / 2);
            let y = e.clientY - homeRect.top - (itemDetails.height / 2);

            // Ensure furniture stays within bounds
            x = Math.max(0, Math.min(x, homeWidth - itemDetails.width));
            y = Math.max(0, Math.min(y, homeHeight - itemDetails.height));

            // Add furniture to the current house's furniture array
            if (!allHousesFurniture[currentHouseId]) {
                allHousesFurniture[currentHouseId] = [];
            }
            const newFurniture = {
                id: generateUniqueId(),
                type: selectedFurnitureType,
                x: x,
                y: y,
                rotation: 0 // Initialize rotation to 0
            };

            // Initialize inventory for chests and vaults, and now Demonic Chest
            if (selectedFurnitureType === 'chest' || selectedFurnitureType === 'vault' || selectedFurnitureType === 'midas_statue' || selectedFurnitureType === 'demonic_pool') {
                newFurniture.inventory = { money: 0 }; // Only money for these types
            } else if (selectedFurnitureType === 'demonic_chest') {
                newFurniture.inventory = { soulLumber: 0 }; // Only soulLumber for Demonic Chest
            }

            allHousesFurniture[currentHouseId].push(newFurniture);
            selectedFurnitureType = null;
            renderApp(); // Re-render to place furniture and hide hint
            saveGame(); // Save game state after placing furniture
            checkVampireForestUnlock(); // Check for unlock after buying furniture
            startOrUpdateIdleGeneration(); // Update idle generation after placing new furniture
            addDebugLog(`Placed new furniture: ${itemDetails.name}.`);
        };

        const rotateFurniture = (furnitureId) => {
            // Find the furniture in the current house's furniture array
            const currentHouseFurniture = allHousesFurniture[currentHouseId] || [];
            const itemIndex = currentHouseFurniture.findIndex(item => item.id === furnitureId);
            if (itemIndex > -1) {
                // Increment rotation by 90 degrees, reset to 0 after 270 (360 becomes 0)
                currentHouseFurniture[itemIndex].rotation = (currentHouseFurniture[itemIndex].rotation + 90) % 360;
                renderApp(); // Re-render to apply new rotation
                saveGame(); // Save game state after rotating furniture
                addDebugLog(`Rotated furniture item ${furnitureId}.`);
            }
        };

        const selectFurnitureToMove = (furnitureId) => {
            // Find the furniture in the current house's furniture array
            const currentHouseFurniture = allHousesFurniture[currentHouseId] || [];
            // If the same furniture is clicked again, deselect it
            if (selectedFurnitureToMoveId === furnitureId) {
                selectedFurnitureToMoveId = null;
                addDebugLog(`Deselected furniture ${furnitureId} for moving.`);
            } else {
                selectedFurnitureToMoveId = furnitureId;
                addDebugLog(`Selected furniture ${furnitureId} for moving.`);
            }
            renderApp(); // Re-render to update visual selection
            saveGame(); // Save game state after selecting furniture to move
        };

        const placeMovedFurniture = (e, homeWidth, homeHeight) => {
            if (!selectedFurnitureToMoveId) return;

            const homeAreaDiv = document.getElementById('homeArea');
            if (!homeAreaDiv) return;

            const homeRect = homeAreaDiv.getBoundingClientRect();
            // Find the furniture in the current house's furniture array
            const currentHouseFurniture = allHousesFurniture[currentHouseId] || [];
            const itemIndex = currentHouseFurniture.findIndex(item => item.id === selectedFurnitureToMoveId);
            if (itemIndex > -1) {
                // Find item details from furnitureItems
                const itemDetails = furnitureItems.find(f => f.id === currentHouseFurniture[itemIndex].type);
                if (!itemDetails) return;

                // Calculate new position, centering the furniture on the click
                let x = e.clientX - homeRect.left - (itemDetails.width / 2);
                let y = e.clientY - homeRect.top - (itemDetails.height / 2);

                // Ensure furniture stays within bounds
                x = Math.max(0, Math.min(x, homeWidth - itemDetails.width));
                y = Math.max(0, Math.min(y, homeHeight - itemDetails.height));

                currentHouseFurniture[itemIndex].x = x;
                currentHouseFurniture[itemIndex].y = y;
                addDebugLog(`Moved furniture ${selectedFurnitureToMoveId} to (${x}, ${y}).`);
            }

            selectedFurnitureToMoveId = null; // Clear selected furniture
            isRearrangingFurniture = false; // Exit rearrange mode
            renderApp(); // Re-render to update furniture position and mode
            saveGame(); // Save game state after moving furniture
        };

        const deleteFurniture = (furnitureId) => {
            // Find the furniture in the current house's furniture array
            let currentHouseFurniture = allHousesFurniture[currentHouseId] || [];
            const initialLength = currentHouseFurniture.length;
            // Filter out the furniture to be deleted
            allHousesFurniture[currentHouseId] = currentHouseFurniture.filter(item => item.id !== furnitureId);

            if (allHousesFurniture[currentHouseId].length < initialLength) {
                showMessage(`Deleted furniture item.`, 'success');
                addDebugLog(`Deleted furniture item. ${furnitureId}`);
                renderApp(); // Re-render to remove the furniture visually
                saveGame(); // Save game state after deleting furniture
                checkVampireForestUnlock(); // Check for unlock after deleting furniture
                startOrUpdateIdleGeneration(); // Update idle generation after deleting furniture
            } else {
                showMessage(`Furniture item not found.`, 'error');
                addDebugLog(`Failed to delete furniture item ${furnitureId}: Not found.`);
            }
        };

        const equipHome = (houseId) => {
            if (ownedHouses.includes(houseId)) {
                currentHouseId = houseId;
                showMessage(`Equipped ${houseItems.find(h => h.id === houseId)?.name}`, 'success');
                addDebugLog(`Equipped home ${houseId}.`);
                // Ensure the furniture array for the new house exists
                if (!allHousesFurniture[currentHouseId]) {
                    allHousesFurniture[currentHouseId] = [];
                }
                renderApp(); // Re-render to update current house and its furniture
                saveGame(); // Save game state after equipping a new home
                startOrUpdateIdleGeneration(); // Update idle generation when changing homes
            } else {
                showMessage("You don't own this house.", 'error');
                addDebugLog(`Failed to equip home ${houseId}: Not owned.`);
            }
        };

        const buyHome = (houseId) => {
            const houseToBuy = houseItems.find(house => house.id === houseId);
            if (!houseToBuy) return;

            if (ownedHouses.includes(houseId)) {
                showMessage("You already own this house!", 'info');
                addDebugLog(`Already owned home ${houseId}.`);
                return;
            }

            if (moneyCount >= houseToBuy.moneyCost) {
                moneyCount -= houseToBuy.moneyCost;
                ownedHouses.push(houseId);
                // Initialize an empty furniture array for the new house
                allHousesFurniture[houseId] = [];
                currentHouseId = houseId; // Automatically equip new house
                playPurchaseSound(); // Play purchase sound
                showMessage(`Bought and equipped ${houseToBuy.name}!`, 'success');
                addDebugLog(`Bought and equipped home ${houseToBuy.name} for ${houseToBuy.moneyCost} money.`);
                renderApp(); // Re-render to update money, owned houses, and equipped house
                saveGame(); // Save game state after buying a house
                startOrUpdateIdleGeneration(); // Update idle generation when buying a new home
            } else {
                showMessage("Not enough money to buy " + houseToBuy.name, 'error');
                addDebugLog(`Failed to buy home ${houseToBuy.name}: Not enough money.`);
            }
        };

        // --- New: Function to check if Vampire Forest should be unlocked ---
        const checkVampireForestUnlock = () => {
            let hasDemonicPool = false;
            for (const houseId in allHousesFurniture) {
                const furnitureInHouse = allHousesFurniture[houseId];
                if (furnitureInHouse.some(item => item.type === 'demonic_pool')) {
                    hasDemonicPool = true;
                    break;
                }
            }

            if (hasDemonicPool && !vampireForestUnlocked) {
                vampireForestUnlocked = true;
                showMessage("Vampire Forest unlocked!", 'success');
                addDebugLog("Vampire Forest unlocked.");
            } else if (!hasDemonicPool && vampireForestUnlocked) {
                // If a demonic pool was sold/deleted and it was the last one, lock the biome again
                vampireForestUnlocked = false;
                showMessage("Vampire Forest locked again (no Demonic Pool owned).", 'info');
                addDebugLog("Vampire Forest locked (no Demonic Pool owned).");
            }
            renderApp(); // Re-render to update navigation/biome view
        };


        // --- Chest Inventory Functions ---
        let currentOpenChestId = null; // Track which chest's inventory is open

        const openChestInventory = (chestId) => {
            const currentHouseFurniture = allHousesFurniture[currentHouseId];
            const chest = currentHouseFurniture.find(item => item.id === chestId);
            
            if (!chest) {
                addDebugLog("Chest not found for inventory: " + chestId);
                return;
            }

            currentOpenChestId = chestId;

            const appRoot = getAppRoot();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'chestInventoryModal';
            modalOverlay.className = 'modal-overlay';

            let modalContentHtml = `
                <div class="modal-content">
                    <button class="modal-close-button" id="closeChestModal">&times;</button>
                    <h3 class="text-2xl font-bold text-stone-100 mb-4 text-center">${chest.name || 'Storage'} Inventory</h3>
                    <div class="flex flex-col gap-4">
            `;

            // Dynamically generate content based on chest type
            if (chest.type === 'chest' || chest.type === 'vault' || chest.type === 'midas_statue' || chest.type === 'demonic_pool') {
                modalContentHtml += `
                        <!-- Money Section -->
                        <div class="bg-stone-800 p-4 rounded-lg flex flex-col items-center">
                            <h4 class="text-xl font-semibold text-stone-100 mb-2">Money</h4>
                            <p class="text-lg text-stone-300 mb-2">In Chest: <span id="chestMoneyCount">${chest.inventory.money}</span> <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="number" id="moneyAmount" min="1" value="1" class="w-24 p-2 border border-stone-600 rounded-md text-center text-lg font-semibold bg-stone-700 text-stone-100" />
                                <button id="depositMoneyBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-semibold">Deposit</button>
                                <button id="withdrawMoneyBtn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-md text-white font-semibold">Withdraw</button>
                            </div>
                            <p class="text-sm text-stone-400">Your Money: ${moneyCount} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" /></p>
                        </div>
                `;
            } else if (chest.type === 'demonic_chest') {
                modalContentHtml += `
                        <!-- Soul Lumber Section for Demonic Chest -->
                        <div class="bg-stone-800 p-4 rounded-lg flex flex-col items-center">
                            <h4 class="text-xl font-semibold text-stone-100 mb-2">Soul Lumber</h4>
                            <p class="text-lg text-stone-300 mb-2">In Chest: <span id="chestSoulLumberCount">${chest.inventory.soulLumber}</span> <img src="${soulLumberIconUrl}" alt="Soul Lumber Icon" class="currency-icon inline-block" /></p>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="number" id="soulLumberAmount" min="1" value="1" class="w-24 p-2 border border-stone-600 rounded-md text-center text-lg font-semibold bg-stone-700 text-stone-100" />
                                <button id="depositSoulLumberBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold">Deposit</button>
                                <button id="withdrawSoulLumberBtn" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 rounded-md text-white font-semibold">Withdraw</button>
                            </div>
                            <p class="text-sm text-stone-400">Your Soul Lumber: ${soulLumberCount} <img src="${soulLumberIconUrl}" alt="Soul Lumber Icon" class="currency-icon inline-block" /></p>
                        </div>
                `;
            }

            modalContentHtml += `
                    </div>
                </div>
            `;
            modalOverlay.innerHTML = modalContentHtml;
            appRoot.appendChild(modalOverlay);
            addDebugLog(`Opened inventory for chest: ${chestId}.`);

            // Add event listeners for modal buttons based on chest type
            modalOverlay.querySelector('#closeChestModal').addEventListener('click', closeChestInventory);

            if (chest.type === 'chest' || chest.type === 'vault' || chest.type === 'midas_statue' || chest.type === 'demonic_pool') {
                modalOverlay.querySelector('#depositMoneyBtn').addEventListener('click', () => {
                    playButtonClickSound(); // Play sound on click
                    const amount = parseInt(modalOverlay.querySelector('#moneyAmount').value);
                    depositToChest(chestId, 'money', amount);
                });
                modalOverlay.querySelector('#withdrawMoneyBtn').addEventListener('click', () => {
                    playButtonClickSound(); // Play sound on click
                    const amount = parseInt(modalOverlay.querySelector('#moneyAmount').value);
                    withdrawFromChest(chestId, 'money', amount);
                });
            } else if (chest.type === 'demonic_chest') {
                modalOverlay.querySelector('#depositSoulLumberBtn').addEventListener('click', () => {
                    playButtonClickSound(); // Play sound on click
                    const amount = parseInt(modalOverlay.querySelector('#soulLumberAmount').value);
                    depositToChest(chestId, 'soulLumber', amount);
                });
                modalOverlay.querySelector('#withdrawSoulLumberBtn').addEventListener('click', () => {
                    playButtonClickSound(); // Play sound on click
                    const amount = parseInt(modalOverlay.querySelector('#soulLumberAmount').value);
                    withdrawFromChest(chestId, 'soulLumber', amount);
                });
            }
        };

        const closeChestInventory = () => {
            const modal = document.getElementById('chestInventoryModal');
            if (modal) {
                modal.remove();
                currentOpenChestId = null;
                addDebugLog("Closed chest inventory.");
            }
            updateCurrencyDisplay(); // Re-render to ensure main UI is updated if any counts changed
        };

        const updateChestInventoryDisplay = (chestId) => {
            const chest = allHousesFurniture[currentHouseId].find(item => item.id === chestId);
            if (!chest || !document.getElementById('chestInventoryModal')) return;

            const modal = document.getElementById('chestInventoryModal');

            if (chest.type === 'chest' || chest.type === 'vault' || chest.type === 'midas_statue' || chest.type === 'demonic_pool') {
                const chestMoneyCountSpan = modal.querySelector('#chestMoneyCount');
                if (chestMoneyCountSpan) chestMoneyCountSpan.textContent = chest.inventory.money;
                const yourMoneySpan = modal.querySelector('.bg-stone-800:nth-child(1) .text-sm');
                if (yourMoneySpan) yourMoneySpan.innerHTML = `Your Money: ${moneyCount} <img src="${moneyIconUrl}" alt="Money Icon" class="currency-icon inline-block" />`;
            } else if (chest.type === 'demonic_chest') {
                const chestSoulLumberCountSpan = modal.querySelector('#chestSoulLumberCount');
                if (chestSoulLumberCountSpan) chestSoulLumberCountSpan.textContent = chest.inventory.soulLumber;
                const yourSoulLumberSpan = modal.querySelector('.bg-stone-800:nth-child(1) .text-sm');
                if (yourSoulLumberSpan) yourSoulLumberSpan.innerHTML = `Your Soul Lumber: ${soulLumberCount} <img src="${soulLumberIconUrl}" alt="Soul Lumber Icon" class="currency-icon inline-block" />`;
            }
        };

        const depositToChest = (chestId, itemType, amount) => {
            if (isNaN(amount) || amount <= 0) {
                showMessage("Please enter a valid amount.", 'error');
                addDebugLog(`Deposit failed: Invalid amount (${amount}).`);
                return;
            }

            const chest = allHousesFurniture[currentHouseId].find(item => item.id === chestId);
            if (!chest) return;

            if (itemType === 'money' && (chest.type === 'chest' || chest.type === 'vault' || chest.type === 'midas_statue' || chest.type === 'demonic_pool')) {
                if (moneyCount >= amount) {
                    moneyCount -= amount;
                    chest.inventory.money += amount;
                    showMessage(`Deposited ${amount} money to chest.`, 'success');
                    addDebugLog(`Deposited ${amount} money to chest ${chestId}.`);
                } else {
                    showMessage("Not enough money to deposit.", 'error');
                    addDebugLog(`Deposit failed: Not enough money to deposit ${amount}.`);
                }
            } else if (itemType === 'soulLumber' && chest.type === 'demonic_chest') {
                if (soulLumberCount >= amount) {
                    soulLumberCount -= amount;
                    chest.inventory.soulLumber += amount;
                    showMessage(`Deposited ${amount} Soul Lumber to Demonic Chest.`, 'success');
                    addDebugLog(`Deposited ${amount} Soul Lumber to demonic chest ${chestId}.`);
                } else {
                    showMessage("Not enough Soul Lumber to deposit.", 'error');
                    addDebugLog(`Deposit failed: Not enough Soul Lumber to deposit ${amount}.`);
                }
            } else {
                showMessage(`Invalid item type (${itemType}) for this chest type (${chest.type}).`, 'error');
                addDebugLog(`Deposit failed: Invalid item type ${itemType} for chest type ${chest.type}.`);
            }
            updateCurrencyDisplay(); // Update global currency display
            updateChestInventoryDisplay(chestId); // Update modal display
            saveGame();
        };

        const withdrawFromChest = (chestId, itemType, amount) => {
            if (isNaN(amount) || amount <= 0) {
                showMessage("Please enter a valid amount.", 'error');
                addDebugLog(`Withdraw failed: Invalid amount (${amount}).`);
                return;
            }

            const chest = allHousesFurniture[currentHouseId].find(item => item.id === chestId);
            if (!chest) return;

            if (itemType === 'money' && (chest.type === 'chest' || chest.type === 'vault' || chest.type === 'midas_statue' || chest.type === 'demonic_pool')) {
                if (chest.inventory.money >= amount) {
                    chest.inventory.money -= amount;
                    moneyCount += amount;
                    showMessage(`Withdrew ${amount} money from chest.`, 'success');
                    addDebugLog(`Withdrew ${amount} money from chest ${chestId}.`);
                } else {
                    showMessage("Not enough money in chest to withdraw.", 'error');
                    addDebugLog(`Withdraw failed: Not enough money in chest to withdraw ${amount}.`);
                }
            } else if (itemType === 'soulLumber' && chest.type === 'demonic_chest') {
                if (chest.inventory.soulLumber >= amount) {
                    chest.inventory.soulLumber -= amount;
                    soulLumberCount += amount;
                    showMessage(`Withdrew ${amount} Soul Lumber from Demonic Chest.`, 'success');
                    addDebugLog(`Withdrew ${amount} Soul Lumber from demonic chest ${chestId}.`);
                } else {
                    showMessage("Not enough Soul Lumber in chest to withdraw.", 'error');
                    addDebugLog(`Withdraw failed: Not enough Soul Lumber in chest to withdraw ${amount}.`);
                }
            } else {
                showMessage(`Invalid item type (${itemType}) for this chest type (${chest.type}).`, 'error');
                addDebugLog(`Withdraw failed: Invalid item type ${itemType} for chest type ${chest.type}.`);
            }
            updateCurrencyDisplay(); // Update global currency display
            updateChestInventoryDisplay(chestId); // Update modal display
            saveGame();
        };

        // --- Idle Generation Functions ---
        const calculateIdleGenerationRates = () => {
            let woodRate = 0;
            let soulLumberRate = 0;
            for (const houseId in allHousesFurniture) {
                const furnitureInHouse = allHousesFurniture[houseId];
                furnitureInHouse.forEach(item => {
                    const itemDetails = furnitureItems.find(f => f.id === item.type);
                    if (itemDetails && itemDetails.category === 'generators') {
                        if (itemDetails.generatesWoodPerSecond) {
                            woodRate += itemDetails.generatesWoodPerSecond;
                        }
                        if (itemDetails.generatesSoulLumberPerSecond) {
                            soulLumberRate += itemDetails.generatesSoulLumberPerSecond;
                        }
                    }
                });
            }
            return { wood: woodRate, soulLumber: soulLumberRate };
        };

        const startOrUpdateIdleGeneration = () => {
            // Clear any existing interval
            if (idleWoodGenerationInterval) {
                clearInterval(idleWoodGenerationInterval);
                idleWoodGenerationInterval = null;
            }

            // Reset rates before calculating
            totalIdleWoodPerSecond = 0;
            totalIdleSoulLumberPerSecond = 0;

            const { wood: newWoodRate, soulLumber: newSoulLumberRate } = calculateIdleGenerationRates();
            totalIdleWoodPerSecond = newWoodRate;
            totalIdleSoulLumberPerSecond = newSoulLumberRate;

            if (totalIdleWoodPerSecond > 0 || totalIdleSoulLumberPerSecond > 0) {
                // Set interval to add resources every second
                idleWoodGenerationInterval = setInterval(() => {
                    // Temporarily store the current weight before adding
                    const currentWeightBeforeGeneration = calculateCurrentInventoryWeight();

                    if (totalIdleWoodPerSecond > 0) {
                        // Check inventory capacity before adding idle wood
                        if (currentWeightBeforeGeneration + (totalIdleWoodPerSecond * LUMBER_ITEM_WEIGHT) <= inventoryCapacity) {
                            woodCount += totalIdleWoodPerSecond;
                        } else {
                            addDebugLog("Idle wood generation paused: Inventory full.");
                            showMessage("Idle wood generation paused: Inventory full!", 'info', 5000);
                        }
                    }
                    if (totalIdleSoulLumberPerSecond > 0) {
                        // Check inventory capacity before adding idle soul lumber
                        if (currentWeightBeforeGeneration + (totalIdleSoulLumberPerSecond * SOUL_LUMBER_ITEM_WEIGHT) <= inventoryCapacity) {
                            soulLumberCount += totalIdleSoulLumberPerSecond;
                        } else {
                            addDebugLog("Idle soul lumber generation paused: Inventory full.");
                            showMessage("Idle soul lumber generation paused: Inventory full!", 'info', 5000);
                        }
                    }
                    // Only update the display if the inventory view is currently active
                    if (currentView === 'inventory') {
                        updateCurrencyDisplay();
                    }
                    // No need to save game every second, save on other actions
                }, 1000); // Every 1 second
                addDebugLog(`Idle generation started/updated: ${totalIdleWoodPerSecond} wood/second, ${totalIdleSoulLumberPerSecond} soul lumber/second.`);
            } else {
                addDebugLog("No active generators, idle generation stopped.");
            }
        };

        // New: Function to turn off all generators
        const turnOffAllGenerators = () => {
            if (idleWoodGenerationInterval) {
                clearInterval(idleWoodGenerationInterval);
                idleWoodGenerationInterval = null;
            }
            totalIdleWoodPerSecond = 0;
            totalIdleSoulLumberPerSecond = 0;
            showMessage("All generators turned off.", 'info');
            addDebugLog("All generators turned off.");
            renderApp(); // Re-render to update display and button state
            saveGame(); // Save game state after turning off generators
        };


        // --- Save/Load Game Functions ---
        const saveGame = () => {
            const gameState = {
                woodCount: woodCount,
                moneyCount: moneyCount,
                grapeLumberCount: grapeLumberCount, // New: Save grape lumber count
                soulLumberCount: soulLumberCount, // New: Save soul lumber count
                rustyCanCount: rustyCanCount, // New: Save rusty can count
                garbageCount: garbageCount, // New: Save garbage count
                screwsCount: screwsCount, // New: Save screws count
                currentAxeId: currentAxeId,
                ownedAxes: ownedAxes,
                currentHouseId: currentHouseId, // Save current house
                ownedHouses: ownedHouses,     // Save owned houses
                allHousesFurniture: allHousesFurniture, // Save all furniture for all houses
                currentFurnitureCategory: currentFurnitureCategory, // Save the current furniture category
                isFurnitureShopOpen: isFurnitureShopOpen, // New: Save the furniture shop open state
                biomesUnlocked: biomesUnlocked, // Save biomes unlocked state
                lumberMillUpgraded: lumberMillUpgraded, // Save lumber mill upgrade state
                vampireForestUnlocked: vampireForestUnlocked, // New: Save vampire forest unlock state
                lastLocation: currentView, // Save the current view as the last location
                ownedCars: ownedCars, // New: Save owned cars
                currentCarId: currentCarId, // New: Save current car
                deliveriesUnlocked: deliveriesUnlocked, // New: Save deliveries unlocked state
                questsUnlocked: questsUnlocked, // New: Save quests unlocked state
                totalIdleWoodPerSecond: totalIdleWoodPerSecond, // Save idle wood rate
                totalIdleSoulLumberPerSecond: totalIdleSoulLumberPerSecond, // New: Save idle soul lumber rate
                ownedBackpacks: ownedBackpacks, // Save owned backpacks
                currentBackpackId: currentBackpackId, // Save current backpack
                // New: Music related saves
                isBackgroundMusicPlaying: isBackgroundMusicPlaying,
                musicVolume: musicVolume,
                // Removed activeTheme from save
                // Do not save isSelling, sellingProgress, etc. as they are transient states
            };
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameState));
                addDebugLog("Game saved successfully!");
            }
            catch (e) {
                addDebugLog("Error saving game to local storage: " + e.message);
            }
        };

        const loadGame = () => {
            try {
                const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedState) {
                    const gameState = JSON.parse(savedState);
                    woodCount = gameState.woodCount || 0;
                    moneyCount = gameState.moneyCount || 0;
                    grapeLumberCount = gameState.grapeLumberCount || 0; // New: Load grape lumber count
                    soulLumberCount = gameState.soulLumberCount || 0; // New: Load soul lumber count
                    rustyCanCount = gameState.rustyCanCount || 0; // New: Load rusty can count
                    garbageCount = gameState.garbageCount || 0; // New: Load garbage count
                    screwsCount = gameState.screwsCount || 0; // New: Load screws count
                    currentAxeId = gameState.currentAxeId || 'basic_axe';
                    ownedAxes = gameState.ownedAxes || ['basic_axe'];
                    currentHouseId = gameState.currentHouseId || 'basic_home';
                    ownedHouses = gameState.ownedHouses || ['basic_home'];
                    // When loading furniture, ensure chest inventories are initialized if missing (for old saves)
                    allHousesFurniture = gameState.allHousesFurniture || { 'basic_home': [] };
                    for (const houseId in allHousesFurniture) {
                        allHousesFurniture[houseId].forEach(item => {
                            if ((item.type === 'chest' || item.type === 'vault' || item.type === 'midas_statue' || item.type === 'demonic_pool') && !item.inventory) {
                                item.inventory = { money: 0 }; // Initialize with money only
                            } else if (item.type === 'demonic_chest' && !item.inventory) {
                                item.inventory = { soulLumber: 0 }; // Initialize with soulLumber only
                            }
                            // Ensure inventory properties exist if they were previously saved as undefined/null
                            if (item.inventory) {
                                if (item.type === 'chest' || item.type === 'vault' || item.type === 'midas_statue' || item.type === 'demonic_pool') {
                                    item.inventory.money = item.inventory.money || 0;
                                } else if (item.type === 'demonic_chest') {
                                    item.inventory.soulLumber = item.inventory.soulLumber || 0;
                                }
                            }
                        });
                    }

                    currentFurnitureCategory = gameState.currentFurnitureCategory || 'furniture'; // Load current furniture category
                    isFurnitureShopOpen = gameState.isFurnitureShopOpen !== undefined ? gameState.isFurnitureShopOpen : false; // New: Load furniture shop open state, default to false
                    biomesUnlocked = gameState.biomesUnlocked !== undefined ? gameState.biomesUnlocked : false; // Load biomes unlocked state
                    lumberMillUpgraded = gameState.lumberMillUpgraded !== undefined ? gameState.lumberMillUpgraded : false; // Load lumber mill upgrade state
                    vampireForestUnlocked = gameState.vampireForestUnlocked !== undefined ? gameState.vampireForestUnlocked : false; // New: Load vampire forest unlock state
                    lastLocation = gameState.lastLocation || 'forest'; // Load last visited location
                    currentView = lastLocation; // Set current view to last visited location
                    ownedCars = gameState.ownedCars || []; // New: Load owned cars
                    currentCarId = gameState.currentCarId || null; // New: Load current car
                    deliveriesUnlocked = gameState.deliveriesUnlocked !== undefined ? gameState.deliveriesUnlocked : false; // New: Load deliveries unlocked state
                    questsUnlocked = gameState.questsUnlocked !== undefined ? gameState.questsUnlocked : true; // Set to true by default
                    totalIdleWoodPerSecond = gameState.totalIdleWoodPerSecond || 0; // Load idle wood rate
                    totalIdleSoulLumberPerSecond = gameState.totalIdleSoulLumberPerSecond || 0; // New: Load idle soul lumber rate
                    ownedBackpacks = gameState.ownedBackpacks || ['basic_backpack']; // Load owned backpacks
                    currentBackpackId = gameState.currentBackpackId || 'basic_backpack'; // Load current backpack
                    // New: Music related loads
                    isBackgroundMusicPlaying = gameState.isBackgroundMusicPlaying !== undefined ? gameState.isBackgroundMusicPlaying : false;
                    musicVolume = gameState.musicVolume !== undefined ? gameState.musicVolume : 0.5;
                    // Removed activeTheme from load
                    addDebugLog("Game loaded successfully!");
                } else {
                    addDebugLog("No saved game found. Starting new game.");
                    // Initialize default furniture for basic_home if no save exists
                    allHousesFurniture = { 'basic_home': [] };
                }
            } catch (e) {
                addDebugLog("Error loading game from local storage: " + e.message);
                // Optionally reset game state if loading fails
                woodCount = 0;
                moneyCount = 0;
                grapeLumberCount = 0; // New: Reset grape lumber count
                soulLumberCount = 0; // New: Reset soul lumber count
                rustyCanCount = 0; // Reset rusty can count
                garbageCount = 0; // Reset garbage count
                screwsCount = 0; // Reset screws count
                currentAxeId = 'basic_axe';
                ownedAxes = ['basic_axe'];
                currentHouseId = 'basic_home';
                ownedHouses = ['basic_home'];
                allHousesFurniture = { 'basic_home': [] }; // Reset furniture for basic home
                currentFurnitureCategory = 'furniture'; // Reset furniture category
                isFurnitureShopOpen = false; // New: Reset furniture shop open state
                biomesUnlocked = false; // Reset biomes unlocked state
                lumberMillUpgraded = false; // Reset lumber mill upgrade state
                vampireForestUnlocked = false; // New: Reset vampire forest unlock state
                lastLocation = 'forest'; // Reset last location
                currentView = 'forest'; // Reset current view
                ownedCars = []; // New: Reset owned cars
                currentCarId = null; // New: Reset current car
                deliveriesUnlocked = false; // New: Reset deliveries unlocked state
                questsUnlocked = true; // Set to true for new game
                totalIdleWoodPerSecond = 0; // Reset idle wood rate
                totalIdleSoulLumberPerSecond = 0; // New: Reset idle soul lumber rate
                ownedBackpacks = ['basic_backpack']; // Reset owned backpacks
                currentBackpackId = 'basic_backpack'; // Reset current backpack
                // New: Music related resets
                isBackgroundMusicPlaying = false;
                musicVolume = 0.5;
            }
            // Reset any active processes on load to prevent inconsistencies
            isSelling = false;
            sellingProgress = 0;
            currentSellAmount = 0;
            clearInterval(sellingIntervalRef);
            sellingIntervalRef = null;
            // Removed selling sound stop: if (sellingSound && sellingSound.state === 'started') { sellingSound.stop(); }

            // New: Reset grape lumber selling states
            isSellingGrape = false;
            sellingGrapeProgress = 0;
            currentSellGrapeAmount = 0;
            clearInterval(sellingGrapeIntervalRef);
            sellingGrapeIntervalRef = null;

            // New: Reset junk selling states
            isSellingJunk = false;
            sellingJunkProgress = 0;
            currentSellJunkAmount = 0;
            currentSellJunkType = '';
            clearInterval(sellingJunkIntervalRef);
            sellingJunkIntervalRef = null;
            
            isCutting = false;
            cuttingProgress = 0;
            currentCuttingTreeId = null;
            clearInterval(cuttingIntervalRef);
            cuttingIntervalRef = null;

            // New: Reset delivery states
            isDelivering = false;
            deliveryProgress = 0;
            currentDeliveryRouteId = null;
            currentDeliveryAmount = 0;
            clearInterval(deliveryIntervalRef);
            deliveryIntervalRef = null;
            // Removed delivery sound stop: if (deliverySound && deliverySound.state === 'started') { sellingSound.stop(); }
            
            // New: Reset quest states
            isQuesting = false;
            questProgress = 0;
            currentQuestId = null;
            currentQuestLumberRequired = 0;
            clearInterval(questIntervalRef);
            questIntervalRef = null;

            // Reset furniture modes
            isRearrangingFurniture = false;
            isDeletingFurniture = false;
            selectedFurnitureToMoveId = null;
            selectedFurnitureType = null;

            // After loading, immediately check for biome unlocks
            checkVampireForestUnlock();
            // Start idle generation after loading game state
            startOrUpdateIdleGeneration();
            // Update inventory capacity after loading
            updateInventoryCapacity();
        };

        // --- Music Control Functions ---
        const startBackgroundMusic = () => {
            backgroundMusic = document.getElementById('backgroundMusic');
            if (backgroundMusic) {
                backgroundMusic.volume = musicVolume; // Set initial volume
                backgroundMusic.play().then(() => {
                    isBackgroundMusicPlaying = true;
                    updateMusicControlsUI();
                    addDebugLog("Background music started.");
                }).catch(error => {
                    console.warn("Autoplay prevented:", error);
                    addDebugLog("Autoplay prevented for music. User interaction needed.");
                    isBackgroundMusicPlaying = false; // Ensure state is correct if autoplay fails
                    updateMusicControlsUI();
                });
            }
        };

        const toggleMusic = () => {
            if (backgroundMusic) {
                if (isBackgroundMusicPlaying) {
                    backgroundMusic.pause();
                    isBackgroundMusicPlaying = false;
                    addDebugLog("Background music paused.");
                } else {
                    backgroundMusic.play().then(() => {
                        isBackgroundMusicPlaying = true;
                        addDebugLog("Background music resumed.");
                    }).catch(error => {
                        console.warn("Failed to play music:", error);
                        addDebugLog("Failed to play music. User interaction might be required.");
                        isBackgroundMusicPlaying = false; // Keep state as paused if play fails
                    });
                }
                updateMusicControlsUI();
                saveGame(); // Save music state
            }
        };

        const setMusicVolume = (volume) => {
            if (backgroundMusic) {
                musicVolume = parseFloat(volume);
                backgroundMusic.volume = musicVolume;
                addDebugLog(`Music volume set to: ${musicVolume}`);
                saveGame(); // Save music volume
            }
        };

        const updateMusicControlsUI = () => {
            const musicToggleButton = document.getElementById('musicToggleButton');
            const musicIcon = document.getElementById('musicIcon');
            const volumeSlider = document.getElementById('volumeSlider');
            const musicControlsDiv = document.getElementById('music-controls');

            if (musicControlsDiv) {
                musicControlsDiv.classList.remove('hidden'); // Ensure controls are visible after game starts
            }

            if (musicToggleButton && musicIcon) {
                musicIcon.textContent = isBackgroundMusicPlaying ? '🔊' : '🔇'; // Speaker emoji for playing, muted for paused
            }
            if (volumeSlider) {
                volumeSlider.value = musicVolume;
            }
        };

        // --- Main Render Function ---
        const renderApp = () => {
            const appRoot = getAppRoot();
            if (!appRoot) return;

            // No theme classes to remove/add on app-root, styling is global or via general classes

            // Clear existing content
            appRoot.innerHTML = '';

            // Normal view: render all standard elements
            appRoot.classList.remove('w-full', 'max-w-full', 'p-0', 'm-0', 'rounded-none', 'shadow-none', 'min-h-screen');
            appRoot.style.alignItems = 'center'; // Revert alignment

            // Header
            const header = document.createElement('h1');
            header.className = "text-4xl font-bold text-rose-400 mb-6"; // Changed header color
            header.textContent = "LUMBER TYCOON";
            appRoot.appendChild(header);

            // Navigation Buttons
            appRoot.appendChild(setupNavigation());

            // Render current view
            switch (currentView) {
                case 'forest':
                    appRoot.appendChild(renderTreeChoppingView('forest'));
                    break;
                case 'lumberMill':
                    appRoot.appendChild(renderLumberMillView());
                    break;
                case 'shops': // New case for the Shops view
                    appRoot.appendChild(renderShopsView());
                    break;
                case 'axeShop': // Axe Shop is now a sub-view of Shops
                    appRoot.appendChild(renderAxeShopView());
                    break;
                case 'carShop': // Car Shop is now a sub-view of Shops
                    appRoot.appendChild(renderCarShopView());
                    break;
                case 'backpackShop': // New case for Backpack Shop
                    appRoot.appendChild(renderBackpackShopView());
                    break;
                case 'buySellShop': // New case for Buy & Sell Shop
                    appRoot.appendChild(renderBuySellShopView());
                    break;
                case 'home':
                    appRoot.appendChild(renderHomeView());
                    break;
                case 'biomes':
                    appRoot.appendChild(renderBiomesView());
                    break;
                case 'purpleForest': // New case for the purple forest biome
                    appRoot.appendChild(renderTreeChoppingView('purpleForest'));
                    break;
                case 'vampireForest': // New case for the vampire forest biome
                    appRoot.appendChild(renderTreeChoppingView('vampireForest'));
                    break;
                case 'deliveries': // New case for deliveries
                    appRoot.appendChild(renderDeliveriesView());
                    break;
                case 'quests': // New case for quests
                    appRoot.appendChild(renderQuestsView());
                    break;
                case 'inventory': // New case for inventory
                    appRoot.appendChild(renderInventoryView());
                    break;
                case 'debug': // New case for debug view
                    appRoot.appendChild(renderDebugView());
                    break;
                case 'settings': // New case for settings view
                    appRoot.appendChild(renderSettingsView());
                    break;
                default:
                    appRoot.appendChild(renderTreeChoppingView('forest'));
            }

            // Update music controls UI after rendering the app
            updateMusicControlsUI();
        };

        // --- Initialization ---
        window.onload = async () => { // Made onload async to await Tone.start()
            const loadingScreen = document.getElementById('loading-screen');
            const welcomeMessage = document.getElementById('welcome-message');
            const clickToStartOverlay = document.getElementById('click-to-start-overlay');
            const startButton = document.getElementById('startButton');

            // Show loading screen immediately
            loadingScreen.classList.remove('hidden');

            // Load game state
            loadGame();

            // Get background music element
            backgroundMusic = document.getElementById('backgroundMusic');
            if (backgroundMusic) {
                backgroundMusic.volume = musicVolume; // Set initial volume from loaded state
            }

            // Simulate loading time and then hide loading screen
            setTimeout(() => {
                loadingScreen.classList.add('hidden'); // Fade out loading screen

                if (isFirstLoad) {
                    welcomeMessage.textContent = "Welcome to LumberTycoon!";
                    welcomeMessage.classList.add('show'); // Show welcome message
                    localStorage.setItem(LOCAL_STORAGE_FIRST_LOAD_KEY, 'false'); // Mark as not first load
                    setTimeout(() => {
                        welcomeMessage.classList.remove('show'); // Fade out welcome message
                        // After welcome message, show click-to-start overlay for first-time users
                        clickToStartOverlay.classList.remove('hidden');
                    }, 3000); // Hide welcome message after 3 seconds
                } else {
                    // For returning users, directly show click-to-start overlay (or start game if music was off)
                    clickToStartOverlay.classList.remove('hidden');
                }
            }, 1000); // Adjust loading screen display time as needed (e.g., 1000ms = 1 second)

            // Event listener for the "Start Game" button on the overlay
            startButton.addEventListener('click', async () => { // Made the click handler async
                clickToStartOverlay.classList.add('hidden'); // Hide the overlay
                await setupAudio(); // Initialize Tone.js and load sounds ONLY after user click
                startBackgroundMusic(); // Attempt to start music
                renderApp(); // Initial render with loaded or default state
            });

            // Add event listeners for music controls once they are available in the DOM
            document.addEventListener('DOMContentLoaded', () => {
                const musicToggleButton = document.getElementById('musicToggleButton');
                const volumeSlider = document.getElementById('volumeSlider');

                if (musicToggleButton) {
                    musicToggleButton.addEventListener('click', toggleMusic);
                }
                if (volumeSlider) {
                    volumeSlider.addEventListener('input', (e) => setMusicVolume(e.target.value));
                }
                updateMusicControlsUI(); // Initialize UI based on loaded state
            });

            // Save game state before the user leaves or refreshes the page
            window.addEventListener('beforeunload', saveGame);

            // Prevent double-tap zoom on iOS and other mobile browsers
            // Add this outside of window.onload to ensure it's active immediately
            document.documentElement.addEventListener('dblclick', (e) => {
                e.preventDefault();
            }, { passive: false });
        };
    </script>
</body>
</html>
